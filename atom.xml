<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>windliang</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://windliang.wang/"/>
  <updated>2023-08-31T23:44:33.759Z</updated>
  <id>https://windliang.wang/</id>
  
  <author>
    <name>windliang</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>从小白到入门编程的成长之路</title>
    <link href="https://windliang.wang/2023/08/31/%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%85%A5%E9%97%A8%E7%BC%96%E7%A8%8B%E7%9A%84%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF/"/>
    <id>https://windliang.wang/2023/08/31/%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%85%A5%E9%97%A8%E7%BC%96%E7%A8%8B%E7%9A%84%E6%88%90%E9%95%BF%E4%B9%8B%E8%B7%AF/</id>
    <published>2023-08-30T23:48:32.000Z</published>
    <updated>2023-08-31T23:44:33.759Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间在知乎看到这个问题「<a href="https://www.zhihu.com/question/614706706/answer/3146012068" target="_blank" rel="noopener">想请教现在的在职程序员第一次编程入门的是怎样的？</a>」，现在又到了大学新生入学的日子，这里把答案贴过来，希望对大家有所帮助。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230831075109555.png" alt=""></p><p>按时间线来回忆下：</p><h2 id="14-年-9-月-15-年-3-月大一上"><a href="#14-年-9-月-15-年-3-月大一上" class="headerlink" title="14 年 9 月 - 15 年 3 月大一上"></a>14 年 9 月 - 15 年 3 月大一上</h2><p>14 年进入大学接触编程，第一门编程语言 C++。</p><p>开始就是学基础语法，学循环、学递归，求绝对值、求阶乘、一元二次方程求解，到最后的学生管理系统。</p><p><img src="https://pic1.zhimg.com/80/v2-bb99a05769ad80fa59a3b06bb6ea3b3a_1440w.webp?source=1940ef5c" alt="img"></p><p>txt 文件是类似下边的数据：</p><p><img src="https://pica.zhimg.com/80/v2-f5539b9fed34796b59820eca4a45b18d_1440w.webp?source=1940ef5c" alt="img"></p><p>写出的程序就是命令行之间的交互，程序把 txt 读入，然后进行增删改查的操作。</p><p><img src="https://picx.zhimg.com/80/v2-d79811e1b2c1128171481c1a1b731c7b_1440w.webp?source=1940ef5c" alt="img"></p><p>最开始底层是用一个大数组保存的，当时正好在学链表，自己就想着干脆再用链表重写一下吧，然后花了几天时间将整个代码进行了重写，未来遇到链表的问题都变得轻轻松松了。</p><p>大一寒假回家闲来无事就在网上找了些课程，学了<a href="https://www.zhihu.com/search?q=郝斌&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra={&quot;sourceType&quot;%3A&quot;answer&quot;%2C&quot;sourceId&quot;%3A3146012068}" target="_blank" rel="noopener">郝斌</a>的数据构课程，但当时应该是懵懵懂懂，只了解了大概。</p><h2 id="15-年-3-月-15-年-9-月大一下"><a href="#15-年-3-月-15-年-9-月大一下" class="headerlink" title="15 年 3 月 - 15 年 9 月大一下"></a>15 年 3 月 - 15 年 9 月大一下</h2><p>大一下学期接触了 GUI，也就是有界面的应用，学校的课程是 MFC。</p><p><img src="https://picx.zhimg.com/80/v2-09c41120e35b979bfd84f9590cb0a2df_1440w.webp?source=1940ef5c" alt="img"></p><p>课程末，把大一上写的黑框的学生管理系统改成了有界面的。</p><p><img src="https://pic1.zhimg.com/80/v2-22a454919b675bb94b57509a23c19024_1440w.webp?source=1940ef5c" alt="img"></p><p>接着暑假开始的时候没有直接回家，学校当时有 ACM 集训第一个月留校了，但当时基础太差，如听天书，最终也没走 ACM 的道路。</p><p>但期间因为有了 MFC 的知识，自己又尝试做了一个双人版的贪吃蛇。完全从零自己开始写， 画蛇身，动起来，操控，一步一步最后完成的。</p><p>并且实现了局域网对战，对网络有了初步的了解。</p><p><img src="https://pic1.zhimg.com/80/v2-639aacf85cd02dc4e47b4d8d073f398f_1440w.webp?source=1940ef5c" alt="img"></p><p><a href="https://www.zhihu.com/question/398508166/answer/1281030495" target="_blank" rel="noopener">用c语言可以实现多人在线游戏吗？100 赞同 · 8 评论回答<img src="https://pica.zhimg.com/v2-e41503e83cfeb73864b2e95f02305656_720w.jpg?source=7e7ef6e2" alt="img"></a></p><p>大一期间还接触过其他事情：</p><p>期间接触到 <a href="https://www.zhihu.com/people/fd7c571a0ada1a72e42e8d7992c4a780" target="_blank" rel="noopener">@萧井陌</a>的 <a href="https://zhuanlan.zhihu.com/p/19959253" target="_blank" rel="noopener">Badger4us：编程入门指南 v2.0</a> ，陆陆续续开始看里边的 python 课（未来写过很多 python）、哈佛大学的 cs50 课（了解到很多概念，对 scratch 也印象深刻，未来也专门又用了一次）、SICP（神书，也学到了 lisp 语言）。这篇文章对自己帮助很大，每当迷茫的时候就会去读读。</p><p>期间联系了一位老师，从大一寒假开始陆陆续续看论文、学 MATLAB、学算法，详细的故事可以看 <a href="https://www.zhihu.com/question/345429819/answer/825839114" target="_blank" rel="noopener">有一些超级难的算法比如遗传算法，蚁群算法，看了数学建模国赛感觉好难写，那些人怎么写出来的?</a></p><h2 id="15-年-9-月-16-年-3-月大二上"><a href="#15-年-9-月-16-年-3-月大二上" class="headerlink" title="15 年 9 月 - 16 年 3 月大二上"></a>15 年 9 月 - 16 年 3 月大二上</h2><p>学校课程多了数据结构，对链表、树、图有了更多的了解，期间有个小作业继续利用 MFC 进行可视化。</p><p><img src="https://pic1.zhimg.com/80/v2-195910d9ca4f88006bbb2b09d0a23abf_1440w.webp?source=1940ef5c" alt="img"></p><p>当时学校查成绩只能到教务网站自己去查，没有自己的官方 app，于是就萌发了自己去写一个 app 的想法，开始一步步践行。</p><p>寒假的时候开始学习 java 语言：</p><p><img src="https://pic1.zhimg.com/80/v2-3d1c83872eda9181dad6bf2dd2d27935_1440w.webp?source=1940ef5c" alt="img"></p><p>学习 Java 之后才对面向过程编程和面向对象有了更多的理解。</p><h2 id="16-年-3-月-16-年-9-月大二下"><a href="#16-年-3-月-16-年-9-月大二下" class="headerlink" title="16 年 3 月 - 16 年 9 月大二下"></a>16 年 3 月 - 16 年 9 月大二下</h2><p>继续学习 java，开始写简单的安卓应用，之前学数据结构的时候做过无界面的计算器，这里结合安卓就做了一个有界面的计算器。</p><p><img src="https://picx.zhimg.com/80/v2-dfb40f0bc2f909899bf651e34ea9ba16_1440w.webp?source=1940ef5c" alt="img"></p><p><img src="https://picx.zhimg.com/80/v2-e8893468a94ce52d6350f1903ae4bf27_1440w.webp?source=1940ef5c" alt="img"></p><p>掌握基本安卓开发后，如果做查成绩的 app 肯定还需要数据，于是又捡起之前的 python，学习爬虫，了解网络知识、html 解析，最终成功查出来。</p><p><img src="https://pic1.zhimg.com/80/v2-7a215cc8ec325de96292549640523468_1440w.webp?source=1940ef5c" alt="img"></p><p>这个之后，被学校的一个互联网社团看到了，于是有了联系，他们也有做学校 app 的想法，于是从独自作战变成了团队合作。</p><p>当时的学校网络需要连好之后进行手动登录，于是又写了一个 app</p><p><img src="https://pic1.zhimg.com/80/v2-dfd8fbbc924002d987de499ad459754b_1440w.webp?source=1940ef5c" alt="img"></p><p>暑假第一个月继续留校学习，借了几本安卓的书开始学习</p><p><img src="https://picx.zhimg.com/80/v2-fbaa883623a6e3b70f0f4f74fe93f3b1_1440w.webp?source=1940ef5c" alt="img"></p><h2 id="16-年-9-月-1-7-年-3-月-大三上"><a href="#16-年-9-月-1-7-年-3-月-大三上" class="headerlink" title="16 年 9 月 - 1 7 年 3 月 大三上"></a>16 年 9 月 - 1 7 年 3 月 大三上</h2><p>在团队里有了更多的事情，由于当时 python 比较熟，又写了一个接口用来在线充值饭卡，之前学校充值饭卡只能线下充。</p><p><img src="https://pic1.zhimg.com/80/v2-874aa93a9fd9f71eec8107a06f98dd71_1440w.webp?source=1940ef5c" alt="img"></p><p>学校课程里也陆陆续续接触一些底层的计算机知识，操作系统、计算机组成原理、汇编语言、数字逻辑这些。</p><p>比如电脑上模拟 8086 CPU 做的一个东西：</p><p><img src="https://picx.zhimg.com/80/v2-c1b5c11dd34076abbd0cb596b157ae9d_1440w.webp?source=1940ef5c" alt="img"></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/Kapture%202023-08-31%20at%2007.55.40.gif" alt=""></p><p>17 年生日的时候搭建了自己的第一个博客，<a href="https://windliang.wang">https://windliang.wang</a> ，了解了域名、服务器、git 各种概念，后边陆陆续续就开始总结文章了。</p><p><img src="https://pic1.zhimg.com/80/v2-9229df4b76596c05f7506b65e60d4750_1440w.webp?source=1940ef5c" alt="img"></p><h2 id="17-年-3-月-17-年-9-月-大三下"><a href="#17-年-3-月-17-年-9-月-大三下" class="headerlink" title="17 年 3 月 - 17 年 9 月 大三下"></a>17 年 3 月 - 17 年 9 月 大三下</h2><p>大三下一开学，app 正式上线，支持查课表、查成绩、充值饭卡：</p><p><img src="https://picx.zhimg.com/80/v2-67f10cc5625425d19439fa2839c8d041_1440w.webp?source=1940ef5c" alt="img"></p><h2 id="17-年-9-月-17-年-3-月大四上"><a href="#17-年-9-月-17-年-3-月大四上" class="headerlink" title="17 年 9 月 - 17 年 3 月大四上"></a>17 年 9 月 - 17 年 3 月大四上</h2><p>经常需要上自习，但每天的空教室是在楼下黑板手写公布的，但其实到教务网站是可以查出来的。于是注册了公众号 windliang，实现了一个查询空教室的功能。</p><p><img src="https://picx.zhimg.com/80/v2-49a22f736207e9a1e9664b230860f6cc_1440w.webp?source=1940ef5c" alt="img"></p><p>再接着学习了前端 html、css、js，写了一个棋类对战游戏(从这里开始和前端结缘)，也作为了软件工程的结课作业。</p><p><a href="https://zhuanlan.zhihu.com/p/71165578" target="_blank" rel="noopener">windliang：WebSocket: 从狼吃羊说起</a></p><p><img src="https://picx.zhimg.com/80/v2-b904199fea56f284343ef377625de624_1440w.webp?source=1940ef5c" alt="img"></p><p>由于毕业设计和深度学习有关，也开始总结深度学习的知识。<a href="https://www.zhihu.com/column/deeplearning1024" target="_blank" rel="noopener">零基础入门深度学习</a></p><h2 id="18-年-3-月-18-年-6-月大四下"><a href="#18-年-3-月-18-年-6-月大四下" class="headerlink" title="18 年 3 月 - 18 年 6 月大四下"></a>18 年 3 月 - 18 年 6 月大四下</h2><p>开始陆陆续续刷题，并且总结题解，<a href="https://leetcode.wang" target="_blank" rel="noopener">https://leetcode.wang</a></p><p>除了上边列的，陆陆续续还做过很多小东西，就是那种突然有个想法就去实现，不会就去一点点学。</p><p>之后毕业又读了研，但通过大学四年基本上拥有了基础的编程能力，无论学什么新语言，用什么新框架上手都会很快。</p><p>接着就是毕业后的故事，前段时间刚满三周年：<a href="https://zhuanlan.zhihu.com/p/640990591" target="_blank" rel="noopener">windliang：工作三年后的胡思乱想</a></p><p>总结下来，入门编程最核心的就是去多写代码了，最好先定个目标，想要实现什么，然后基于此去学习相关知识，不断攻破。</p><p>但对于初学者，每当接触一个新知识点的时候还是很痛苦的，只能不停的拆解目标，一步一个脚印来攻克。</p><p>从不会到会，这个过程不断循环，每次有成果出来都会非常开心，随着这个过程不断扩充自己边界，到后来再学新知识就不会那么抗拒了，迁移学习的能力越来越强。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前段时间在知乎看到这个问题「&lt;a href=&quot;https://www.zhihu.com/question/614706706/answer/3146012068&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;想请教现在的在职程序员第一次编程入门的是怎样的
      
    
    </summary>
    
    
      <category term="随想" scheme="https://windliang.wang/categories/%E9%9A%8F%E6%83%B3/"/>
    
    
      <category term="随想" scheme="https://windliang.wang/tags/%E9%9A%8F%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>【限免】0基础入门前端系列课程</title>
    <link href="https://windliang.wang/2023/08/13/0%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E5%89%8D%E7%AB%AF%E7%B3%BB%E5%88%97%E8%AF%BE%E7%A8%8B/"/>
    <id>https://windliang.wang/2023/08/13/0%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E5%89%8D%E7%AB%AF%E7%B3%BB%E5%88%97%E8%AF%BE%E7%A8%8B/</id>
    <published>2023-08-13T02:19:16.000Z</published>
    <updated>2023-09-06T00:21:13.817Z</updated>
    
    <content type="html"><![CDATA[<p>免费学详细规则：<a href="https://mp.weixin.qq.com/s/0X8l9VeEp0VizlUTSgVmqg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/0X8l9VeEp0VizlUTSgVmqg</a></p><p>前端存在<strong>知识点杂多、技术迭代快</strong>的特点，对于初学者或者非前端开发者往往会一脸懵逼。</p><p>这个系列会逐个介绍前端各个知识点，最后再详细介绍「课程减减」这个网站如何从零开始开发，包含前后端的开发，以及最后部署上线，预览地址 <a href="https://coursesub.top/" target="_blank" rel="noopener">https://coursesub.top/</a></p><h1 id="课程介绍"><a href="#课程介绍" class="headerlink" title="课程介绍"></a>课程介绍</h1><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/1686402092795-4d35181e-ba66-47cb-b46f-f96ecdf3ddbf.png" style="zoom:50%;"></p><p>前端整体结构可以理解为上边的图，底层的硬件、操作系统部分我们不关心，谷歌开源了 V8 引擎，它可以运行 js 语言，基于此又有了 <strong>Chrome</strong> 浏览器和 <strong>Node.js</strong>。</p><ul><li>浏览器可以运行 html/css/js 的代码，渲染网页并且提供交互能力。在原生的 js 的基础上，又诞生了Vue/React，可以提升网页开发效率。</li><li>Node.js 目前有两方面作用，一方面是写脚手架或者一些命令行工具，比如 Webpack。另一方面可以搭建 HTTP 服务器，提供后端接口，比如使用 koa 框架。</li></ul><p>课程会详细介绍各个知识点的来龙去脉，目录如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230807080036010.png" alt=""></p><h1 id="适合人群"><a href="#适合人群" class="headerlink" title="适合人群"></a>适合人群</h1><p>前端初学者：简单学习了 html、css、js，对其他概念还不太了解，也没有独立开发项目的经验。</p><p>其他开发人员：不管是后端、算法、测开等，只要有过编程经验，都可以轻松地跟上课程。</p><h1 id="收获什么"><a href="#收获什么" class="headerlink" title="收获什么"></a>收获什么</h1><p>会了解前端的整体架构，各个部分的作用，跟着教程可以搭建出「课程减减」这个网站。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/1686401004503-ed8d2a90-1519-47aa-86f9-f2db5623ff1a.png" style="zoom:50%;"></p><p>包含前后端整个开发过程的详细介绍，以及最后通过 nginx 将网站部署上线。</p><p>整个课程下来，<strong>会对前端有一个大体的认知</strong>，未来想写其他的网站也不再迷茫，该干什么， 需要做什么都做到心中有数。</p><h1 id="购买须知"><a href="#购买须知" class="headerlink" title="购买须知"></a>购买须知</h1><ol><li>本系列为图文形式内容服务，文章会由微信公众号文章的形式发布，共计 14 篇(已完结)；</li><li>购买用户可享有永久的阅读权限；</li><li>教程为虚拟内容服务，一经购买成功概不退款；</li><li>版权归本公众号所有，任何机构、媒体、网站或个人未经本网协议授权不得转载、链接、转贴或以其他方式复制发布/发表，违者将依法追究责任；</li></ol><h1 id="购买优惠"><a href="#购买优惠" class="headerlink" title="购买优惠"></a>购买优惠</h1><p>安卓用户进这里 <a href="https://mp.weixin.qq.com/s/xvfdXNSOKyMp--X-h_WE_Q" target="_blank" rel="noopener">安卓用户购买</a> 点击文章下方「合集详情」购买即可，苹果用户看这里 <a href="https://mp.weixin.qq.com/s/oOu--D69edllkoHbpD-3Qg" target="_blank" rel="noopener">ios 用户购买</a> 。</p><p>购买后添加下边微信可以领取返现红包，具体返现红包以 <a href="https://coursesub.top/" target="_blank" rel="noopener">https://coursesub.top/</a> 这里展示的为准，目前返现 20 元</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/640.jpeg" style="zoom:50%;"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;免费学详细规则：&lt;a href=&quot;https://mp.weixin.qq.com/s/0X8l9VeEp0VizlUTSgVmqg&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/0X8l9VeEp0V
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>关于 TypeScript 的一点点思考</title>
    <link href="https://windliang.wang/2023/08/12/%E5%85%B3%E4%BA%8ETypeScript/"/>
    <id>https://windliang.wang/2023/08/12/%E5%85%B3%E4%BA%8ETypeScript/</id>
    <published>2023-08-12T00:17:13.000Z</published>
    <updated>2023-08-12T00:41:22.148Z</updated>
    
    <content type="html"><![CDATA[<p>平常写 ts 比较少，用了几天时间刷完了阮一峰老师新写的 ts 教程，依旧通俗易懂，对于入门或者查漏补缺还是挺有帮助的。</p><p><a href="https://wangdoc.com/typescript/" target="_blank" rel="noopener">wangdoc.com/typescript/</a></p><p>加深了两点收获：</p><ol><li>ts 是一门独立的语言，利用它的类型推导可以做很多事情。</li><li>ts 又是一门特殊的语言，杂糅到了 js 中去使用。混合使用过程中，一不小心就会被绕进去。</li></ol><p>上次详细看 ts 还是写斐波那契的时候，<a href="https://zhuanlan.zhihu.com/p/427849482" target="_blank" rel="noopener">用 TypeScript 实现斐波那契数列</a></p><p>混了 Anthony Fu ts 类型体操项目的一道题：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230812084112082.png" alt=""></p><p><a href="https://github.com/type-challenges/type-challenges" target="_blank" rel="noopener">https://github.com/type-challenges/type-challenges</a> </p><p>正因为 ts 是一门独立的语言，所以可以用 ts 实现菲波那切数列、实现中国象棋，甚至实现编译器，也就有了上边的类型体操项目。</p><p>我 ts 平常用的比较少，猜测有下边的原因：</p><ol><li><p>大家对 ts 的了解深浅不一，ts 说简单也简单，说复杂也复杂，平常快速的业务迭代中很少有时间说专门去刷一遍 ts。</p></li><li><p>第一次开发的时候会多花时间。 定一个接口需要写类型，函数参数需要写类型，如果参数是对象套对象再套对象，那简直要疯掉。</p></li><li><p>未来迭代也花时间。后端接口有变动，除了改逻辑代码，还要再把相应的类型也都改了。</p></li><li><p>写逻辑的时候会被限制，经常遇到动态修改变量的情况，如果有 ts 还需要多考虑下。</p></li><li><p>收益不明显，如果说为了类型提示，编辑器通过插件一定程度上也可以。如果为了减少 bug，但用 js 写也很少因为类型问题出现 bug，基本上都是逻辑问题。</p><p>一般都会通过问号操作符或者 || 操作进行兜底，因为影响范围太广了，一不小心直接影响几千万用户，所以写的时候都会很谨慎，会考虑各种极端情况。比如之前总结的 <a href="https://zhuanlan.zhihu.com/p/561275198" target="_blank" rel="noopener">提升前端开发质量的十点经验沉淀</a>。</p></li></ol><p>当然以上仅我自己的看法，ts 这么火也肯定是有原因的，等未来 ts 写的多了再来补充它的好处。</p><p>现在项目达成的共识是新建文件的时候建成 ts，至于里边代码多少用 ts 就不做太多限制了，anyScript 由此诞生 \狗头。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;平常写 ts 比较少，用了几天时间刷完了阮一峰老师新写的 ts 教程，依旧通俗易懂，对于入门或者查漏补缺还是挺有帮助的。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://wangdoc.com/typescript/&quot; target=&quot;_blank&quot; rel=&quot;noopen
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="TypeScript" scheme="https://windliang.wang/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title>Vue中props是Object可以直接修改吗</title>
    <link href="https://windliang.wang/2023/07/06/Vue%E4%B8%ADprops%E6%98%AFObject%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9%E5%90%97/"/>
    <id>https://windliang.wang/2023/07/06/Vue%E4%B8%ADprops%E6%98%AFObject%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BF%AE%E6%94%B9%E5%90%97/</id>
    <published>2023-07-06T00:02:45.000Z</published>
    <updated>2023-07-11T23:16:06.534Z</updated>
    
    <content type="html"><![CDATA[<p>好久没有在知乎上看到好问题了，前几天<a href="https://www.zhihu.com/question/609822540/answer/3099837968" target="_blank" rel="noopener">看到一个</a>，把回答同步过来。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230706080412256.png" alt=""></p><p>确实是一个很有争议的问题，团队里也经常讨论这个问题，下边分享下我的想法，也不一定是最佳实践。</p><p>首先，不要修改 prop 的值肯定是一条比较好的实践，保证数据的流向明确。</p><p><a href="https://vuejs.org/guide/components/props.html#one-way-data-flow" target="_blank" rel="noopener">官方文档</a>中也有明确指出：</p><h1 id="One-Way-Data-Flow"><a href="#One-Way-Data-Flow" class="headerlink" title="One-Way Data Flow"></a>One-Way Data Flow</h1><p>All props form a <strong>one-way-down binding</strong> between the child property and the parent one: when the parent property updates, it will flow down to the child, but not the other way around. This prevents child components from accidentally mutating the parent’s state, which can make your app’s data flow harder to understand.</p><p>In addition, every time the parent component is updated, all props in the child component will be refreshed with the latest value. This means you should <strong>not</strong> attempt to mutate a prop inside a child component. If you do, Vue will warn you in the console:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  props: [<span class="string">'foo'</span>],</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// ❌ 警告！prop 是只读的！</span></span><br><span class="line">    <span class="keyword">this</span>.foo = <span class="string">'bar'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>There are usually two cases where it’s tempting to mutate a prop:</p><p><strong>1.The prop is used to pass in an initial value; the child component wants to use it as a local data property afterwards.</strong> In this case, it’s best to define a local data property that uses the prop as its initial value:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue3</span></span><br><span class="line"><span class="keyword">const</span> props = defineProps([<span class="string">'initialCounter'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// counter only uses props.initialCounter as the initial value;</span></span><br><span class="line"><span class="comment">// it is disconnected from future prop updates.</span></span><br><span class="line"><span class="keyword">const</span> counter = ref(props.initialCounter)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue2</span></span><br><span class="line">props: [<span class="string">'initialCounter'</span>],</span><br><span class="line">data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: <span class="keyword">this</span>.initialCounter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. The prop is passed in as a raw value that needs to be transformed.</strong> In this case, it’s best to define a computed property using the prop’s value:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue3</span></span><br><span class="line"><span class="keyword">const</span> props = defineProps([<span class="string">'size'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// computed property that auto-updates when the prop changes</span></span><br><span class="line"><span class="keyword">const</span> normalizedSize = computed(<span class="function"><span class="params">()</span> =&gt;</span> props.size.trim().toLowerCase())</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue2</span></span><br><span class="line">props: [<span class="string">'size'</span>],</span><br><span class="line">computed: &#123;</span><br><span class="line">  normalizedSize: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.size.trim().toLowerCase()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了避免修改 prop 的值，可以在 data 中初始化为 prop 的值然后再去使用或者定义 computed 属性拿到 prop 值再去使用。</p><p>当然，上边的写法也仅仅对原始值生效，如果 props 定义成一个 Array 或者 Object，如果把 Object 的值直接赋值给 data：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">props: [<span class="string">'initialCounterObj'</span>],</span><br><span class="line">data: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counterObj: <span class="keyword">this</span>.initialCounterObj</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当去修改 <code>counterObj</code> 中的值，虽然看起来没有修改 props 的值，但因为 Object 传递进来的是引用，修改 <code>counterObj</code> 的值的时候外部的相应的对象也跟着修改了。</p><p>针对这种情况，可以将 Object 摊开，变为一个个原始值。</p><h2 id="通过-sync"><a href="#通过-sync" class="headerlink" title="通过 .sync"></a>通过 .sync</h2><p>父组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">child</span> <span class="attr">field1.sync</span>=<span class="string">"obj.field1"</span> <span class="attr">field2.sync</span>=<span class="string">"obj.field2"</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br></pre></td></tr></table></figure><p>子组件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  props: [<span class="string">'field1'</span>, <span class="string">'field2'</span>],</span><br><span class="line">  methods: &#123;</span><br><span class="line">      updateField1(newVal)&#123;</span><br><span class="line">           <span class="keyword">this</span>.$emit(<span class="string">'update:field1'</span>, newVal)</span><br><span class="line">      &#125;,</span><br><span class="line">      updateField2(newVal)&#123;</span><br><span class="line">           <span class="keyword">this</span>.$emit(<span class="string">'update:field2'</span>, newVal)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="通过-get-set"><a href="#通过-get-set" class="headerlink" title="通过 get set"></a><a href="https://stackoverflow.com/questions/59992698/vuejs-best-practices-for-passing-form-data-to-child-and-back-to-parent?rq=4" target="_blank" rel="noopener">通过 get set</a></h2><p>父组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">child</span> <span class="attr">v-model</span>=<span class="string">"obj"</span>&gt;</span><span class="tag">&lt;/<span class="name">child</span>&gt;</span></span><br></pre></td></tr></table></figure><p>子组件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    value: &#123;</span><br><span class="line">      type: <span class="built_in">Object</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  computed: &#123;</span><br><span class="line">    field1: &#123;</span><br><span class="line">      get() &#123; <span class="keyword">return</span> <span class="keyword">this</span>.value.field1 &#125;,</span><br><span class="line">      set(field1) &#123; <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, &#123;...this.value, field1 &#125;)&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    field2: &#123;</span><br><span class="line">      get() &#123; <span class="keyword">return</span> <span class="keyword">this</span>.value.field1 &#125;,</span><br><span class="line">      set(field2) &#123; <span class="keyword">this</span>.$emit(<span class="string">'input'</span>, &#123;...this.value, field2 &#125;)&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外一种更暴力的写法就是题主讲到的方案三 「<strong>不可变对象型」，</strong>每次修改前都把整个对象（或数组）克隆一遍，修改新的对象，再通过 emit 事件把新的对象（这里最好也再克隆一下）传出去。</p><p>上边的方案都可以保证不去修改 props 的值。</p><p>看下<a href="https://vuejs.org/guide/components/props.html#one-way-data-flow" target="_blank" rel="noopener">官方</a>对于 props 是 Object/Array 的态度：</p><h1 id="Mutating-Object-Array-Props"><a href="#Mutating-Object-Array-Props" class="headerlink" title="Mutating Object / Array Props"></a>Mutating Object / Array Props</h1><p>When objects and arrays are passed as props, while the child component cannot mutate the prop binding, it <strong>will</strong> be able to mutate the object or array’s nested properties. This is because in JavaScript objects and arrays are passed by reference, and it is unreasonably expensive for Vue to prevent such mutations.</p><p>The main drawback of such mutations is that it allows the child component to affect parent state in a way that isn’t obvious to the parent component, potentially making it more difficult to reason about the data flow in the future. As a best practice, you should avoid such mutations unless the parent and child are tightly coupled by design. In most cases, the child should emit an event to let the parent perform the mutation.</p><p>关键句：<strong>you should avoid such mutations unless the parent and child are tightly coupled by design.</strong></p><p>因此对于表单场景，我认为符合 parent and child are tightly coupled by design ，很多时候由于表单越来越大，一个 Vue 文件会变得巨大，此时想要拆部分表单出来成为一个组件，这种情况下采用题主所说的方案一「直接修改型」我认为是更佳的，不然的话不管采用什么方式保证不修改 props 都会增加很多代码，反而增加了很多理解成本。</p><p>更进一步，对于 Object/Array，是否修改 props 取决于当前组件的通用性，如果这个组件专门为了某个父组件使用或者专门服务于某个页面，并且为了不修改 props 会增加很多工作量，这种情况下直接修改 props 我认为是合适的。</p><p>但如果这个组件可能用给其他人，此时修改 props ，如果使用方不清楚的话就可能引发问题。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;好久没有在知乎上看到好问题了，前几天&lt;a href=&quot;https://www.zhihu.com/question/609822540/answer/3099837968&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;看到一个&lt;/a&gt;，把回答同步过来。&lt;/
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="Vue" scheme="https://windliang.wang/tags/Vue/"/>
    
  </entry>
  
  <entry>
    <title>工作三年后的胡思乱想</title>
    <link href="https://windliang.wang/2023/07/02/%E5%B7%A5%E4%BD%9C%E4%B8%89%E5%B9%B4%E5%90%8E%E7%9A%84%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3/"/>
    <id>https://windliang.wang/2023/07/02/%E5%B7%A5%E4%BD%9C%E4%B8%89%E5%B9%B4%E5%90%8E%E7%9A%84%E8%83%A1%E6%80%9D%E4%B9%B1%E6%83%B3/</id>
    <published>2023-07-02T07:44:18.000Z</published>
    <updated>2023-07-02T09:07:17.489Z</updated>
    
    <content type="html"><![CDATA[<p>一眨眼工作已经三年了，前两年的总结 <a href="https://windliang.wang/2021/05/29/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B9%B4/">工作第一年</a>、<a href="https://windliang.wang/2022/06/30/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%BA%8C%E5%B9%B4/">工作第二年</a> 基本上把在公司做的事情都介绍了，今年站在「前端已死」、互联网大裁员的环境下，想想未来的路可能更为应景。</p><p>经常说这是最好的时代，也是最坏的时代，互联网便是如此。通过互联网将人与人之间的各种链接都成为了可能，在互联网诞生之前，人与人之间的交流就是现实生活中的圈子，而现在本来这一辈子都不会在现实中产生交集的人在互联网却会相遇。</p><p>各种写书的大佬、开源的大佬，以往可能只是从文字、代码中了解他们，但现在通过社交媒体、微信竟然就产生了互动。当然不好一面就是也会遇到和自己不相投的人，也许会影响自己的心情。</p><p>通过互联网极大的扩宽了我们的视野，看到了别人在怎么生活，也放大了自己的焦虑和欲望。我们需要认清自己的边界，知道自己想要什么，自己能做什么，不需要对本来不可能发生在自己身上的事情而焦虑。</p><p>当迷茫焦虑时，看看宇宙的纪录片，从宇宙的视角去看自己，无论从空间大小还是时间维度，其实自己什么都不是，想那么多干啥。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/milky-way-2695569_1280.jpg" style="zoom: 50%;"></p><p>再想想其他动物，吃饭睡觉喵喵叫，也挺好的。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230630080510771.png" style="zoom: 25%;"></p><h1 id="前端已死"><a href="#前端已死" class="headerlink" title="前端已死"></a>前端已死</h1><p>互联网已经结束了快速扩张的时期，这是个客观事实，因此招聘的人数相对于之前减少了很多，但远没到一个已死的状态，相对于其他行业，选择互联网依旧是一个不错的选择。</p><p>前端会不会死不知道，互联网肯定会一直存在下去，现在整个社会都是基于互联网，已经变成了像电、水一样的基础设施，没有人可以离开它。因此互联网的相关的岗位一定会一直一直存在。</p><p>至于互联网中具体的职业划分，前端、后端、算法、数据库等，它们各自使用的语言、技术一定会发生变化的，当选择互联网技术行业的时候，就应该抱有持续学习的态度。</p><p>塞班操作系统被安卓、iOS 取代、.Net 岗位的减少、客户端大量岗位转前端，这些也就发生在近十几二十年。当某一个岗位减少的时候，一定又会出现新的岗位，保持开放的心态去学就可以，变化再多肯定也有不变的东西。当掌握一门技术再学习另一门技术的时候，肯定会比小白学习一门新技术快很多很多，很多经验也会迁移过去。</p><p>去年 12 月出来的 chatGPT 为代表的大模型，到现在也就半年多的时间，很多以前完全不敢想的事情就这样发生了。可以预见的是一部分岗位数量肯定也会减少，目前影响最大的应该是  UI 岗，其次一定程度上可以提高程序员的开发以及学习效率，但还没有到取代的程度，但未来会再怎么发展就不得而知了。</p><p>相对于其他行业，虽然互联网相关技术迭代确实很快，但如果是因为热爱而选择这个行业，我觉得去做一辈子是没问题的。</p><h1 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h1><p>底层技术服务于上层技术，上层技术服务于应用，真正赚钱的是应用，它可能提升了用户的效率、也可能提升了用户的生活体验，这样用户才愿意付费。上层技术的人收到了钱，进一步也愿意为底层技术的人付费。</p><p>但对于一个应用，技术并不是最重要的，更多需要的是产品和运营，一个应用在 chatGPT 和各种框架、云服务的加持下做出来变得太简单了，更多的是我们需要思考如何设计产品和如何推广运营产品，和用户产生更亲密的连接，用户才愿意付费。</p><p>极端一点，即使现在所有的应用都停止更新了，其实也并不会产生多大的影响。</p><p>在公司中亦是如此，对于技术开发，没有谁是不可取代的，公司更期望的是那些可以发现问题、分析问题、定义问题的人，至于怎么解决，问题定义清楚以后，解决方案自然可以出来，谁去解决并不重要了。</p><p>但也不用太过悲观，虽然技术不是最重要的，但一定是不可或缺的，在解决问题的过程中也会区分出能力强和能力差的：方案的设定、代码编写的好坏、线上的 bug 数、代码的扩展性等。</p><h1 id="赚钱"><a href="#赚钱" class="headerlink" title="赚钱"></a>赚钱</h1><p>赚钱很大程度又是需要运气的，比如同一个人十年前进入互联网和现在进入互联网差别就会很大，再比如开发一个应用突然爆火，例如「羊了个羊」，这些我们是很难控制的，我们只能「尽人事，听天命」。</p><p>最近几年，除了在公司工作，对于有技术的同学赚钱有下边的方式：</p><ul><li><p>付费课程、出书</p><p>最近几年越来越多的人在极客时间、掘金小册写课程或者直接出书。</p><p>对于写课的人赚到了钱，对于买课的人只要跟着看完了，多多少少都会有很多收获。付费课程会比较系统， 如果没有这些课程，去学东西肯定也是可以学的，但需要花很多时间去网上搜一些零碎的资料，由于没有经验甚至可能走很多弯路。</p></li><li><p>付费社群</p><p>市面上也会有一些付费训练的社群或者知识星球</p><p>对于组织付费社群的人会花费很大的精力，需要持续运营并且照顾到每一个人，不然就等着挨骂吧。因此这类收益也会很高，一些人会辞去工作专职来搞。</p></li><li><p>开源</p><p>大部分开源基本上是用爱发电，更多是收获一些朋友、流量、提升技术。</p><p>比如 <a href="https://www.infoq.cn/article/s8jsfyhxu8vowd1uphkp" target="_blank" rel="noopener">core-js</a> 作者的经历，一个 22.6k star 的项目，几乎各个网站都在用的一个项目，作者却因为钱的问题被很多人谩骂。因此如果是个人专职开源一个项目靠  GitHub Sponsor 会很难很难。</p><p>当然，开源也是能赚到钱的，比如 Vue 开源就赚到了很多钱，但毕竟是很少很少数了。</p><p>依赖纯开源项目赚到钱，还是需要背靠公司。比如阿里云谦的 Umi、通过开源加入 NuxtLab 的 Anthony Fu、在 AFFiNE 的雪碧等等。</p></li><li><p>应用</p><p>身为一个程序员，尤其是前端程序员，当然可以自己维护一个应用来赚钱。</p><p>做得很成功的比如 Livid 的 V2ex 社区，Abner Lee 的 Typora（后来知道作者竟然是国内开发者）。</p><p>也有一些没有那么出名的，比如大鹏的 <a href="https://mdnice.com/" target="_blank" rel="noopener">mdnice</a>，秋风的 <a href="https://www.mujicv.com/index.html" target="_blank" rel="noopener">木及简历</a>。</p><p>当然如果要做一个很大的项目，背靠公司也是一个很好的选择，比如之前阿里玉伯的语雀、之前极客邦池建强的极客时间。</p><p>还有一些小的创业公司会做的，冯大辉的「抽奖助手」、吴鲁加的「知识星球」等。</p><p>做出这些应用不需要很多时间，需要我们善于发现生活中的痛点以及强大的执行力，当然想成功的话需要再加一点运气，在成功前需要不断尝试不同的东西。</p></li><li><p>流量变现</p><p>有流量就会赚钱，不管是接广告、还是带货。互联网上也会有部分人专注于怎么搞流量，知乎怎么获得更多曝光、视频号怎么获得更多流量、怎么批量注册号，各个平台规则可能是什么，怎么对抗规则，这类有技术加持也会更加顺利，很多人也在专职做。</p></li></ul><p>赚钱的方式有很多，对于我来说，我会尽量选择复利的事情，这样才能产生更大的价值。比如一对一咨询，一份时间换一份收入。但如果把东西写成课程，只需要花一份的时间就能获得 N 份的收入。</p><p>另外就是需要保持分享，分享除了能帮助其他人，对自己也会有很大的帮助，写文章的过程中也会不断的有新的认知得到。虽然当下可能没有金钱方面的收入，但时间放宽到几十年，相信一定会有很大的回报。</p><p>人的欲望是无穷的，也不能陷入赚钱的极端，目标应该是关注此刻，体验生活，享受生活，而不是不停的赚钱。之前听播客，有一个恰当的比喻，钱就好比汽油，不停的赚钱相当于不停的加油，但如果汽车停着一直不动，再多的汽油也是无意义的。</p><h1 id="健康"><a href="#健康" class="headerlink" title="健康"></a>健康</h1><p>最近几年总是爆出程序员突然离世的新闻，前段时间耗子叔突然离世的消息听到之后真的很震惊。twitter 经常刷到耗子叔的动态，然后突然一天竟然就戛然而止了，毫无征兆。</p><p>意外是无法避免的，只能尽可能的从饮食、作息、锻炼三方面降低生病的风险。</p><h2 id="饮食"><a href="#饮食" class="headerlink" title="饮食"></a>饮食</h2><p>我是工作第一年体检的时候检查出了中度脂肪肝、尿酸高，当时因为是刚毕业，体重是我的巅峰，140 多斤，脂肪都堆在了肚子上。那段时间就开始跑步加吃沙拉，少吃米饭、面条。降的也快，几个月就回到了 130 斤以下，甚至到 120 多点。</p><p>第二年体检的时候，脂肪肝基本没有了，尿酸也降了许多。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230702141922024.png" alt="image-20230702141922024" style="zoom:50%;"></p><p>后来就保持少吃米饭，多吃蛋白质、蔬菜的饮食了。</p><h2 id="作息"><a href="#作息" class="headerlink" title="作息"></a>作息</h2><p>有一次得了带状疱疹，那种非常痛的类似于痘痘的东西，后来了解了一下是因为免疫力低导致病毒入侵的。猜测因为晚上坐在电脑前，气温降低了没注意，从而导致了生病。</p><p>病好之后就决心养成早睡早起的习惯。</p><p>之前作息基本上是 1 点到 2 点睡觉，9 点前后起床。现在基本上保持在 11 点前后睡觉，6 点到 7 点间起床了。</p><p>早起的好处就是早上会有大把的时间，而且这段时间是专属于自己的，并且因为大脑刚苏醒，效率也会很高。但如果是工作一天，晚上回家再做自己的事情，此时大脑已经很疲惫了，效率会比较低。</p><h2 id="运动"><a href="#运动" class="headerlink" title="运动"></a>运动</h2><p>最开始是跑步，但确实很难坚持下去，跑步需要换衣服、出门，还依赖于外边的天气，成本很高。后来陆续尝试过 keep、一些付费课程，都做了但没有完全养成习惯。</p><p>后来知道了 switch 的健身环大冒险，然后就一路坚持到了现在，前段时间已经通关了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230702143219493.png" alt="image-20230702143219493" style="zoom:50%;"></p><p>目前也一直在坚持，基本上一周会运动三到四次，一次大概花费 50 分钟左右。</p><h1 id="投资"><a href="#投资" class="headerlink" title="投资"></a>投资</h1><p>大学的时候开始接触到理财，知道了基金的概念，看了银行螺丝钉的「指数基金定投指南」，也看了「穷爸爸富爸爸」、「小狗钱钱」这类理财入门的书。当时赚到的一些钱，就跟着银行螺丝钉投了，主要是一些宽基和中概、医疗。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230702153842246.png" alt="image-20230702153842246" style="zoom:50%;"></p><p>一直到工作的第一年，基金收入确实不错，甚至赚了百分之四五十。当时想着原来股市这么简单，这咋还能亏钱了。</p><p>接着疫情不断发展，还有外部经济的变化，中概、医疗都大跌，当时发了年终奖还不停的补仓中概，到现在亏损也有百分之三四十了。</p><p>但我心态是可以的，一切都是浮亏和浮盈，只要不卖一切都是浮云。</p><p>经历了大起大落后吸取了一些教训，那就是一定要严格执行计划，现金流多不一定要立刻全部投入，而是按计划定投，因为没人知道会跌多久，只有有充足的现金流，才能够把亏损逐步拉平。</p><p>现在国家规定互联网基金这些必须走「投顾」，也就是主理人帮我们买入、卖出，我们只需要交一定的投顾费即可。目前我都是在雪球上投，跟投的有孟岩的「长钱账户」、alex 的「全球精选」、螺丝钉的指数增强和主动优选。</p><p>能设置自动跟投的就自动跟投了，我相信专业的事交给专业的人肯定是没问题的。</p><p>投资肯定是财富自由不了的，但一定比把钱放余额宝强一些，只要耐心持有，尤其是目前这样的熊市投入，相信到下一个牛市会有不错的回报。</p><p>（以上仅个人看法，股市有风险，入市需谨慎）</p><h1 id="保险"><a href="#保险" class="headerlink" title="保险"></a>保险</h1><p>如果开始接触理财，除了投资，一个绕不过去的点就是保险。</p><p>对于保险是什么的比喻，之前听薛兆丰的课时候印象深刻。</p><blockquote><p>我现在还年轻力壮，将来年纪大了可能会生病，为了防止以后生病要花一大笔医药费，今天就开始存钱，每个月拿出 10% 的收入存起来，未雨绸缪。这是一种做法。</p><p>另外一种做法，是我每个月也拿出 10% 的收入去买保险。</p><p>这两种做法有什么区别呢？</p><p>区别在于，如果我是用储蓄来未雨绸缪，那么未来可能就会发生两种不同的情形。</p><p>如果我将来年纪大了也没生病，我存的钱就还是我的钱，我不需要花出去，这时候我还是很幸运的，能够保有我原来的收入，这份储蓄没有被花掉，我赚了。</p><p>但是如果我运气不好，生病了，这份储蓄就会被用掉，甚至需要借很多钱去治病，生活会发生巨大的变化。</p><p>所以通过储蓄来未雨绸缪，它的特点是未来的结局是可变的，是变动的、是带有风险的。要么高、要么低，要么能够保有原来的这份储蓄，要么这份储蓄就被用掉了甚至借更多的钱。</p><p>而对于保险来说，如果你没病，那你的生活该怎么样还是怎么样。如果你病了，那会有保险公司给你支付一大笔钱，你也不用和别人借钱，病好后继续该干啥干啥。</p></blockquote><p>因此存钱去防止生病就有赌的成分了，如果没病就白赚了很多钱，如果病了生活质量可能会发生很大的变化。</p><p>而保险就可以降低风险，未来即使生病了，由于看病不需要花钱了，病好后生活质量也尽可能的维持在原来轨道 。</p><p>我期望未来肯定是尽量稳定的，所以在不影响当前生活质量的条件下我愿意拿出一部分钱来买保险。原计划我可能会 30 岁以后开始买重疾险，之前女朋友的朋友有推荐保险的，然后就跟女朋友一起配置了重疾险。</p><p>选保险一定要慎重，一些看起来很划算的保险， 到理赔的时候可能会推三阻四，甚至理赔前公司破产了，尽量要选择大公司。</p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>当然生活没有标准答案，每个人看到世界也都是不同的，我也一直在成长，一直在认识新的东西，上边的所想的也不能保证说未来不会再变。</p><p>未来能做的就是多看看书，不限制自己，看看经济学的、哲学的、心理学的、人文的，多出去走走看看，尽可能多的增加人生体验，去认识世界，认识自己，做自己想做的事，爱自己所爱的人，走下去就好了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一眨眼工作已经三年了，前两年的总结 &lt;a href=&quot;https://windliang.wang/2021/05/29/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%B8%80%E5%
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="随想" scheme="https://windliang.wang/tags/%E9%9A%8F%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>css层叠上下文和z-index的使用和思考</title>
    <link href="https://windliang.wang/2023/06/13/css%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8Cz-index%E7%9A%84%E4%BD%BF%E7%94%A8%E5%92%8C%E6%80%9D%E8%80%83/"/>
    <id>https://windliang.wang/2023/06/13/css%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87%E5%92%8Cz-index%E7%9A%84%E4%BD%BF%E7%94%A8%E5%92%8C%E6%80%9D%E8%80%83/</id>
    <published>2023-06-13T00:00:00.000Z</published>
    <updated>2023-06-22T07:54:26.234Z</updated>
    
    <content type="html"><![CDATA[<p>过去一段时间经常遇到线上的页面元素互相遮盖的问题，索性就总结一下吧。</p><p>正常情况下，页面元素是从左到右和从上到下渲染（x、y 维度），但因为 margin 可以写负值，还有一些定位相关的 css 属性(absolute、relative、fixed、stick)，这就会导致元素之间可能重叠，重叠后就需要判断元素堆叠顺序，这就涉及到层叠上下文（Stacking context）了，相当于增加了 z 轴的维度。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/1*uGPV3qEF7yBq4PD0zua19A.png" alt="z-index"></p><h1 id="无新增层叠上下文的情况"><a href="#无新增层叠上下文的情况" class="headerlink" title="无新增层叠上下文的情况"></a>无新增层叠上下文的情况</h1><p>我们先抛开层叠上下文的概念，看一下没有 z-index 或者其他特殊 css 属性正常情况下元素的堆叠规则。</p><p>按照元素出现的顺序依次堆叠下边的元素：</p><ol><li>非定位的 block 元素，一般就是背景</li><li>float 元素</li><li>非定位的 inline 元素，一般就是文字内容</li><li>定位元素，即 position 设置了 relative 或者 absolute</li></ol><p>一句话总结就是同类型的后出现的覆盖先出现的，定位元素覆盖非定位元素。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      .relative &#123;</span></span><br><span class="line"><span class="undefined">        height: 50px;</span></span><br><span class="line"><span class="undefined">        position: relative;</span></span><br><span class="line"><span class="undefined">        top: 10px;</span></span><br><span class="line"><span class="undefined">        background: rgba(0, 0, 255);</span></span><br><span class="line"><span class="undefined">        box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      .static1 &#123;</span></span><br><span class="line"><span class="undefined">        background: rgba(255, 0, 0, 0.5);</span></span><br><span class="line"><span class="undefined">        height: 90px;</span></span><br><span class="line"><span class="undefined">        box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="undefined">        overflow: hidden;</span></span><br><span class="line"><span class="undefined">        width: 60vw;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      .static2 &#123;</span></span><br><span class="line"><span class="undefined">        color: red;</span></span><br><span class="line"><span class="undefined">        background: rgba(0, 255, 0);</span></span><br><span class="line"><span class="undefined">        height: 90px;</span></span><br><span class="line"><span class="undefined">        margin-top: -20px;</span></span><br><span class="line"><span class="undefined">        box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="undefined">        overflow: hidden;</span></span><br><span class="line"><span class="undefined">        width: 80vw;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      .float &#123;</span></span><br><span class="line"><span class="undefined">        background: rgba(255, 255, 0);</span></span><br><span class="line"><span class="undefined">        height: 100px;</span></span><br><span class="line"><span class="undefined">        margin-top: -20px;</span></span><br><span class="line"><span class="undefined">        box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.6);</span></span><br><span class="line"><span class="undefined">        float: left;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"relative"</span>&gt;</span>我是 relative 元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"static1"</span>&gt;</span></span><br><span class="line">      我是 static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是</span><br><span class="line">      static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是</span><br><span class="line">      static1 元素<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static1 元素</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"static2"</span>&gt;</span></span><br><span class="line">      我是 static2 元素,margin-top 是负值<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static2 元素,margin-top</span><br><span class="line">      是负值<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static2 元素,margin-top 是负值<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static2</span><br><span class="line">      元素,margin-top 是负值<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是 static2 元素,margin-top 是负值<span class="tag">&lt;<span class="name">br</span> /&gt;</span>我是</span><br><span class="line">      static2 元素,margin-top 是负值</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"float"</span>&gt;</span>我是float 元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622121535164.png" alt="image-20230622121535164"></p><p>static 的背景看成 block 元素，文字看成 inline 元素。先堆叠 block 元素，再堆叠 float 元素，再堆叠 inline 元素，最后堆叠定位元素。</p><p>static2 的背景遮盖了 static1 的背景，但没有遮盖住 static1 的文字。</p><p>float 元素遮盖了 static2 的背景。</p><p>static2 的文字遮挡了 static1 的文字，因为 float 元素在 inline 元素之前进行了堆叠，所以 static2 的文字也遮盖了 float 的文字。</p><p>relative 元素最后堆叠，直接遮盖了 static1 的背景和文字。</p><h1 id="含有新增的层叠上下文-Stacking-context"><a href="#含有新增的层叠上下文-Stacking-context" class="headerlink" title="含有新增的层叠上下文 Stacking context"></a>含有新增的层叠上下文 Stacking context</h1><p>考虑一下有新增的层叠上下文的情况。</p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>层叠上下文可以理解成一张画布，可以在上边独立地一层一层的刷染料。不同的层叠上下文就是不同的画布，他们之间互相独立。而且层叠上下文中也可以在再形成新的层叠上下文。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/stacking-context-diagram.png" alt="Diagram showing stacked rectangles conveying the three-dimensional, nested nature of stacking contexts"></p><p><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_positioned_layout/Understanding_z-index/Stacking_context" target="_blank" rel="noopener">如何生成新的层叠上下文</a>：</p><ul><li>Root element of the document (<code>&lt;html&gt;</code>).</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/position" target="_blank" rel="noopener"><code>position</code></a> value <code>absolute</code> or <code>relative</code> and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/z-index" target="_blank" rel="noopener"><code>z-index</code></a> value other than <code>auto</code>.</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/position" target="_blank" rel="noopener"><code>position</code></a> value <code>fixed</code> or <code>sticky</code> (sticky for all mobile browsers, but not older desktop browsers).</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/container-type" target="_blank" rel="noopener"><code>container-type</code></a> value <code>size</code> or <code>inline-size</code> set, intended for <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_container_queries" target="_blank" rel="noopener">container queries</a>.</li><li>Element that is a child of a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_flexible_box_layout/Basic_concepts_of_flexbox" target="_blank" rel="noopener">flex</a> container, with <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/z-index" target="_blank" rel="noopener"><code>z-index</code></a> value other than <code>auto</code>.</li><li>Element that is a child of a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/grid" target="_blank" rel="noopener"><code>grid</code></a> container, with <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/z-index" target="_blank" rel="noopener"><code>z-index</code></a> value other than <code>auto</code>.</li><li>Element with an <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/opacity" target="_blank" rel="noopener"><code>opacity</code></a> value less than <code>1</code> (See <a href="https://www.w3.org/TR/css-color-3/#transparency" target="_blank" rel="noopener">the specification for opacity</a>).</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/mix-blend-mode" target="_blank" rel="noopener"><code>mix-blend-mode</code></a> value other than <code>normal</code>.</li><li>Element with any of the following properties with value other than <code>none</code> ：<ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/transform" target="_blank" rel="noopener"><code>transform</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/filter" target="_blank" rel="noopener"><code>filter</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/backdrop-filter" target="_blank" rel="noopener"><code>backdrop-filter</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/perspective" target="_blank" rel="noopener"><code>perspective</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/clip-path" target="_blank" rel="noopener"><code>clip-path</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/mask" target="_blank" rel="noopener"><code>mask</code></a> / <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/mask-image" target="_blank" rel="noopener"><code>mask-image</code></a> / <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/mask-border" target="_blank" rel="noopener"><code>mask-border</code></a></li></ul></li><li>Element with an <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/isolation" target="_blank" rel="noopener"><code>isolation</code></a> value <code>isolate</code>.</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/will-change" target="_blank" rel="noopener"><code>will-change</code></a> value specifying any property that would create a stacking context on non-initial value (see <a href="https://dev.opera.com/articles/css-will-change-property/" target="_blank" rel="noopener">this post</a>).</li><li>Element with a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/contain" target="_blank" rel="noopener"><code>contain</code></a> value of <code>layout</code>, or <code>paint</code>, or a composite value that includes either of them (i.e. <code>contain: strict</code>, <code>contain: content</code>).</li></ul><p>总结下常用的：</p><p>html 元素。</p><p>position 为 absolute 或者 relative，并且 z-index 不是 auto。</p><p>position 为 fixed，<strong>无需设置 z-index 的值</strong>。</p><p>flex 的子项，并且 z-index 不是 auto。</p><p>opacity 设置为小于 1。</p><p>上边的这些情况都会生成一个层叠上下文，在自己的层叠上下文内进行一层一层的渲染。</p><h2 id="堆叠原则"><a href="#堆叠原则" class="headerlink" title="堆叠原则"></a>堆叠原则</h2><p>同一个层叠上下文内元素的堆叠就是之前讨论的无新增层叠上下文的情况（之前的情况其实就是只有一个层叠上下文，即 html 元素自己生成了一个层叠上下文）。</p><p>同一层叠上下文中，层叠上下文之间堆叠顺序如下：</p><ol><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为负值</li><li>没有生成层叠上下文的元素，即之前讨论的无新增层叠上下文的情况<ol><li>非定位的 block 元素，一般就是背景</li><li>float 元素</li><li>非定位的 inline 元素，一般就是文字内容</li><li>定位元素，即 position 设置了 relative 或者 absolute，但没设置 z-index</li></ol></li><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为 0 或者其他条件生成的层叠上下文</li><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为正值，值越大越在上边。</li></ol><p>一个层叠上下文中可以一直嵌套的生成新的层叠上下文，如果要比较不同的层叠上下文下元素的层级关系，<strong>首先需要找到当前元素所在的层叠上下文</strong>（它所在的层叠上下文又在另一个层叠上下文之中，一直向上找，直到找到从它们共同层叠上下（比如 html 元素）中生成的那个层叠上下文），接着按照堆叠规则比较它们所在的层叠上下文关系即可。</p><p>看一个<a href="https://philipwalton.com/articles/what-no-one-told-you-about-z-index/" target="_blank" rel="noopener">经典的例子</a>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      .red,</span></span><br><span class="line"><span class="undefined">      .green,</span></span><br><span class="line"><span class="undefined">      .blue &#123;</span></span><br><span class="line"><span class="undefined">        position: absolute;</span></span><br><span class="line"><span class="undefined">        width: 100px;</span></span><br><span class="line"><span class="undefined">        color: white;</span></span><br><span class="line"><span class="undefined">        line-height: 100px;</span></span><br><span class="line"><span class="undefined">        text-align: center;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      .red &#123;</span></span><br><span class="line"><span class="undefined">        z-index: 1;</span></span><br><span class="line"><span class="undefined">        top: 20px;</span></span><br><span class="line"><span class="undefined">        left: 20px;</span></span><br><span class="line"><span class="undefined">        background: red;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      .green &#123;</span></span><br><span class="line"><span class="undefined">        top: 60px;</span></span><br><span class="line"><span class="undefined">        left: 60px;</span></span><br><span class="line"><span class="undefined">        background: green;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">      .blue &#123;</span></span><br><span class="line"><span class="undefined">        top: 100px;</span></span><br><span class="line"><span class="undefined">        left: 100px;</span></span><br><span class="line"><span class="undefined">        background: blue;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"red"</span>&gt;</span>Red<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"green"</span>&gt;</span>Green<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"blue"</span>&gt;</span>Blue<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>首先观察除了 html 元素有没有新的层叠上下文。</p><p>有一个新生成的层叠上下文：Red 因为设置了 z-index = 1，并且是 absolute 定位，所以生成了层叠上下文，Red 会高于其他元素。</p><p>green 和 blue 都是非定位元素，按照出现顺序，blue 覆盖 green。</p><p>所以从底层到上边的顺序就是绿色、蓝色、红色。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622130720208.png" alt="image-20230622130720208"></p><p>下边思考一下如果修改代码，并且在下边的限制条件下，让红色到最底层：</p><ul><li>不修改任何标签元素的名字，只增加修改 css</li><li>不改变任何元素的 z-index</li><li>不改变任何元素的 position 属性</li></ul><p>如果直接知道答案了，那层叠关系应该是学透了。</p><p>答案就是给 div 加一个透明度：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.99</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622131314901.png" alt="image-20230622131314901"></p><p>我们重新分析一下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.red</span>,</span></span><br><span class="line"><span class="css">      <span class="selector-class">.green</span>,</span></span><br><span class="line"><span class="css">      <span class="selector-class">.blue</span> &#123;</span></span><br><span class="line"><span class="undefined">        position: absolute;</span></span><br><span class="line"><span class="undefined">        width: 100px;</span></span><br><span class="line"><span class="undefined">        color: white;</span></span><br><span class="line"><span class="undefined">        line-height: 100px;</span></span><br><span class="line"><span class="undefined">        text-align: center;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.red</span> &#123;</span></span><br><span class="line"><span class="undefined">        z-index: 1;</span></span><br><span class="line"><span class="undefined">        top: 20px;</span></span><br><span class="line"><span class="undefined">        left: 20px;</span></span><br><span class="line"><span class="undefined">        background: red;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.green</span> &#123;</span></span><br><span class="line"><span class="undefined">        top: 60px;</span></span><br><span class="line"><span class="undefined">        left: 60px;</span></span><br><span class="line"><span class="undefined">        background: green;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.blue</span> &#123;</span></span><br><span class="line"><span class="undefined">        top: 100px;</span></span><br><span class="line"><span class="undefined">        left: 100px;</span></span><br><span class="line"><span class="undefined">        background: blue;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">      div &#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">opacity</span>: 0<span class="selector-class">.99</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"red"</span>&gt;</span>Red<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"green"</span>&gt;</span>Green<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"blue"</span>&gt;</span>Blue<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>现在相当于有五个层叠上下文：</p><p>html(初始的一个层叠上下文)</p><ul><li>div(通过 opacity 生成)<ul><li>red(通过 absolute + z-index 生成)</li></ul></li><li>div(通过 opacity 生成)</li><li>div(通过 opacity 生成)</li></ul><p>比较 Red、Green、Blue 的层叠顺序，就是比较三者所在的层叠上下文，即各自所在的 div，三个 div 都是通过 opacity 生成的层叠上下文，所以它们层叠顺序就是出现的顺序，从底部到顶层就是 Red、Green、Blue。</p><p>即使 Green 和 Blue 本身没有生成层叠上下文，但因为它们所在的父元素的层叠上下文比较高，所以就把 Red 覆盖了。</p><p>再举个例子，因为比较的是所在的层叠上下文的顺序，因此平常开发中会遇到设置 z-index = 999（同时是定位元素了），也无法到最上层。原因就是它所在的层叠上下文比较低，类似于下边的情况。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622140148429.png" alt="image-20230622140148429" style="zoom:50%;"></p><p>还有一个神奇的现象：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.my-element</span> &#123;</span></span><br><span class="line"><span class="undefined">        background: rgb(232 240 254 / 0.5);</span></span><br><span class="line"><span class="undefined">        border: 1px solid lightblue;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        width: 250px;</span></span><br><span class="line"><span class="undefined">        height: 250px;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="css">      <span class="selector-class">.my-element</span> <span class="selector-class">.child</span> &#123;</span></span><br><span class="line"><span class="undefined">        position: relative;</span></span><br><span class="line"><span class="undefined">        z-index: -1;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">        background: pink;</span></span><br><span class="line"><span class="undefined">        border: 1px solid hotpink;</span></span><br><span class="line"><span class="undefined">        padding: 1rem;</span></span><br><span class="line"><span class="undefined">        width: 275px;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"my-element"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"child"</span>&gt;</span>I am behind my parent<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>回忆下之前说的堆叠顺序：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622155424571.png" alt="image-20230622155424571"></p><p>因为父元素和子元素都在同一个层叠上下文下，所以会先堆叠 z-index 为负值的元素，所以就形成了子元素穿越到父元素下边的情况。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622140741157.png" alt="image-20230622140741157"></p><p>如果我们让父元素也生成一个层叠上下文，上边的情况就不会发生了：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.my-element</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">rgb</span>(232 240 254 / 0.5);</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid lightblue;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">width</span>: <span class="number">250px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">250px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230622141026125.png" alt="image-20230622141026125"></p><p>当父元素加了层叠上下文之后，父元素和子元素就不在同一层叠上下文中了。</p><p>父元素在根元素上。</p><p>子元素在父元素上。</p><h1 id="堆叠顺序判断"><a href="#堆叠顺序判断" class="headerlink" title="堆叠顺序判断"></a>堆叠顺序判断</h1><p>总结一下：</p><p>判断元素之间的堆叠顺序，首先判断是否在同一层叠上下文中。</p><p>如果在同一堆叠上下文，就按照下边的顺序：</p><ol><li>非定位的 block 元素，一般就是背景</li><li>float 元素</li><li>非定位的 inline 元素，一般就是文字内容</li><li>定位元素，即 position 设置了 relative 或者 absolute</li></ol><p>如果不在同一堆叠上下文，就找到元素所在的层叠上下文，并且要一直往上找层叠上下文，直到找到从它们共同层叠上下生成的那个层叠上下文：</p><p>按照下边的规则判断层叠上下文的顺序，层叠上下文的顺序就是要比较元素的堆叠顺序了：</p><ol><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为负值</li><li>没有生成层叠上下文的元素，即之前讨论的无新增层叠上下文的情况<ol><li>非定位的 block 元素，一般就是背景</li><li>float 元素</li><li>非定位的 inline 元素，一般就是文字内容</li><li>定位元素，即 position 设置了 relative 或者 absolute，但没设置 z-index</li></ol></li><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为 0 或者其他条件生成的层叠上下文</li><li>通过 z-index 加上某些条件生成的层叠上下文，并且 z-index 为正值，值越大越在上边。</li></ol><h1 id="实践经验"><a href="#实践经验" class="headerlink" title="实践经验"></a>实践经验</h1><p><strong>能不设置 z-index 就不要去设置</strong>，设置请三思。</p><h2 id="定位元素天生高于普通元素"><a href="#定位元素天生高于普通元素" class="headerlink" title="定位元素天生高于普通元素"></a>定位元素天生高于普通元素</h2><p>设置了 relative 或者 absolute 的元素会高于其他元素，因此这种情况下完全可以不设置 z-index，如果设置了 z-index 就会生成新的层叠上下文，可能会造成堆叠的混乱。</p><p>另外因为设置了 fixed 即使不设置 z-index 也会生成一个层叠上下文，因此 fixed 元素会高于其他所有的普通元素（定位元素和非定位元素）。但如果页面中有定位元素设置了正的 z-index，就不得不给 fixed 元素加一个更大 z-index 了。</p><h2 id="子元素层级受到父层叠上下文的影响"><a href="#子元素层级受到父层叠上下文的影响" class="headerlink" title="子元素层级受到父层叠上下文的影响"></a>子元素层级受到父层叠上下文的影响</h2><p>当设置了一个 z-index 产生了层叠上下文后，需要考虑当前元素会不会成为别的元素的父元素，如果在多人合作中经常互相改代码或者引用组件，如果某个地方产生了层叠上下文，那子元素的层级就会受到该父元素的影响从而导致达不到想要的层级。</p><p>比如将一个弹窗组件放到了一个父元素中，父元素有层叠上下文，这样就会导致弹窗组件达不到自己想要的高度。</p><h1 id="z-index-管理思考"><a href="#z-index-管理思考" class="headerlink" title="z-index 管理思考"></a>z-index 管理思考</h1><p>团队中一个项目过大之后，层级问题真的是防不胜防，也许可以做下边的事情来降低问题的发生：</p><h2 id="宣导"><a href="#宣导" class="headerlink" title="宣导"></a>宣导</h2><p>因为层级和 z-index 的问题可能没详细去了解过，边开发边调试最后达到效果就好。所以最好可以先宣导一下，把层级的问题团队内完全对齐，降低问题的发生。</p><h2 id="开发前"><a href="#开发前" class="headerlink" title="开发前"></a>开发前</h2><p>设计一套体系来管理 z-index。</p><p>常规的做法就是将所有的 z-index 定义为变量统一管理，并且规定范围，普通元素 1 - 100，弹窗 101 - 999 类似这样。</p><p>当有页面需要 z-index 时就去注册，命名的时候可以按页面、按组件范围进行区分，这样未来想知道某个页面有哪些 z-index 可以一目了然。</p><h2 id="开发中"><a href="#开发中" class="headerlink" title="开发中"></a>开发中</h2><p>规则有了，但不遵守没啥用。</p><p>需要在 commit 以及打包流水线中进行强制卡控，如果发现 z-index 使用了数字就禁止提交 commit，如果强制用 -n 提交了，就在流水线中禁止打包。</p><h2 id="老项目"><a href="#老项目" class="headerlink" title="老项目"></a>老项目</h2><p>对于老项目去推动上边的流程真的太难了，把所有的 z-index 去重新定义变量，对于大项目来说修改、回归工作量会很大很大，因此基本无望。</p><p>可以做点工具来尽量避免出现层级的问题：</p><p>比如页面的层叠上下文进行静态扫描，可以把层叠上下文的关系展示出来，这样如果需要新加层叠上下文，可以直观的知道会不会影响到别人。</p><p>再进一步，如果有全套的 Mock 数据，可以模拟出来所有层叠上下文都渲染时候，真实页面长什么样子，会更加直观。</p><h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><p>以上思考都是理想情况下可以做的事情，现实状况可能会遇到小团队没必要推，大团队推不动的情况，哈哈。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;过去一段时间经常遇到线上的页面元素互相遮盖的问题，索性就总结一下吧。&lt;/p&gt;
&lt;p&gt;正常情况下，页面元素是从左到右和从上到下渲染（x、y 维度），但因为 margin 可以写负值，还有一些定位相关的 css 属性(absolute、relative、fixed、stick)
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="css" scheme="https://windliang.wang/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>js宏任务和微任务执行顺序详解</title>
    <link href="https://windliang.wang/2023/04/08/js%E5%AE%8F%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E8%AF%A6%E8%A7%A3/"/>
    <id>https://windliang.wang/2023/04/08/js%E5%AE%8F%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E8%AF%A6%E8%A7%A3/</id>
    <published>2023-04-08T13:04:45.000Z</published>
    <updated>2023-04-09T01:09:31.902Z</updated>
    
    <content type="html"><![CDATA[<p>最近看了死月的 <a href="https://s.juejin.cn/ds/AshEp8U/" target="_blank" rel="noopener">趣学 Node.js</a> 小册，关于宏任务、微任务部分突然意识到所谓的执行顺序其实就是底层 <code>C++</code>  写的各种代码的结果，当了解了 <code>Node.js</code> 代码或者 <code>V8</code> 代码再看这些问题真的就是降维打击（当然我只是有了这个感觉，还没细看过[旺柴]）。</p><p>但如果平常用不到，我们也没必要真的去看底层的代码，即使不了解底层代码，我们也可以根据具体的表现来自己定一些规则进行理解，只要根据这个规则来判断执行顺序是正确的，能指导平常开发也就足够了。</p><blockquote><p>这篇文章只讲基本的概念，不进行深入，能够判断 <code>setTimemout</code>、<code>Promise</code> 的执行顺序即可。</p></blockquote><p>众所周知，<code>JavaScript</code> 单线程执行的，所以对于一些耗时的任务，我们可以将其丢入任务队列当中，这样一来，也就不会阻碍其他同步代码的执行。等到异步任务完成之后，再去进行相关逻辑的操作。</p><p><code>js</code> 在主线程中执行的顺序：宏任务 -&gt; 宏任务 -&gt; 宏任务 … </p><p>在每一个宏任务中又可以产生微任务，当微任务全部执行结束后执行下一个宏任务。<br>【宏任务 [微任务]】 -&gt; 【宏任务 [微任务]】-&gt; 【宏任务 [微任务]】…</p><h1 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h1><p>生成方法：</p><ul><li>用户交互：用户在页面上进行交互操作（例如点击、滚动、输入等），会触发浏览器产生宏任务来响应用户操作。</li><li>网络请求：当浏览器发起网络请求（例如通过 <code>Ajax</code>、<code>Fetch</code>、<code>WebSocket</code> 等方式）时，会产生宏任务来处理请求和响应。</li><li><strong>定时器：通过 <code>JavaScript</code> 宿主环境提供的定时器函数（例如 <code>setTimeout</code>、<code>setInterval</code>）可以设置一定的时间后产生宏任务执行对应的回调函数。</strong></li><li><code>DOM</code> 变化：当 <code>DOM</code> 元素发生变化时（例如节点的添加、删除、属性的修改等），会产生宏任务来更新页面。</li><li>跨窗口通信：在浏览器中，跨窗口通信（例如通过 <code>postMessage</code> 实现）会产生宏任务来处理通信消息。</li><li><code>JavaScript</code> 脚本执行事件；比如页面引入的 <code>script</code> 就是一个宏任务。</li></ul><p>重点来看下 <code>setTimeout</code> 。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout block'</span>)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end here'</span>)</span><br></pre></td></tr></table></figure><p>以上代码会输出什么？</p><hr><p>什么都不会输出</p><p>上边代码相当于两个宏任务：</p><p>第一个宏任务就是上边的整个脚本</p><p>第二个宏任务是 setTimeout 传入的这个函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout block'</span>)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>第一个宏任务执行到 <code>while true</code> 的时候死循环了，所以自己的 <code>console.log(&#39;end here&#39;)</code> 不会执行。</p><p>第二个宏任务也没有机会执行到。</p><p>因此什么都不会输出。</p><p>再来看一个：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> t1 = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> t3 = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'setTimeout block'</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'t3 - t1 ='</span>, t3 - t1)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t2 = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (t2 - t1 &lt; <span class="number">200</span>) &#123;</span><br><span class="line">    t2 = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end here'</span>)</span><br></pre></td></tr></table></figure><p><code>t1</code> 记录开始的时间，设置一个 <code>100</code> 毫秒执行的定时器，定时器中输出执行当前任务的时间。</p><p>那么  <code>console.log(&#39;t3 - t1 =&#39;, t3 - t1)</code> 输出的是多少呢？</p><hr><p>输出答案是 <code>200</code>。</p><p>同样的，上边是两个宏任务。</p><p>整个脚本是第一个宏任务。</p><p>计时器生成了第二个宏任务。</p><p>只有第一个宏任务执行结束后才会执行第二个宏任务。</p><p>所以即使定时器时间到了也不会立刻执行，只有当第一个宏任务执行结束后才会去执行定时器的任务，此时已经过去了 <code>200</code> 毫秒。</p><h1 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h1><p>生成方法：</p><ul><li><strong><code>Promise</code>：<code>Promise</code> 是一种异步编程的解决方案，它可以将异步操作封装成一个 <code>Promise</code> 对象，通过 <code>then</code> 方法注册回调函数，当 <code>promise</code> 变为 <code>resolve</code> 或者 <code>reject</code> 会将回调函数加入微任务队列中。</strong></li><li><code>MutationObserver</code>：<code>MutationObserver</code> 是一种可以观察 <code>DOM</code> 变化的 <code>API</code>，通过监听 <code>DOM</code> 变化事件并注册回调函数，将回调函数加入微任务队列中。</li><li><code>process.nextTick</code>：<code>process.nextTick</code> 是 <code>Node.js</code> 中的一个 <code>API</code>，它可以将一个回调函数加入微任务队列中。</li></ul><p>重点看 <code>Promise</code> 的使用，关于 <code>Promise</code> 怎么用这里不细说了，重点放到输出顺序上。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> r = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"1"</span>);</span><br><span class="line">    resolve()</span><br><span class="line">&#125;);</span><br><span class="line">r.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"2"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"3"</span>)</span><br></pre></td></tr></table></figure><p>上边的输出什么：</p><hr><p>比较基础的使用。输出 <code>1 3 2</code> 。</p><p><code>new Promise</code> 接受一个函数，返回一个 <code>Promise</code> 对象。值得注意的一点是<strong>传给 <code>Promise</code> 的那个函数会直接执行</strong>。所以会先输出 <code>1</code> 。</p><p><code>Promise</code> 对象拥有一个 <code>then</code> 方法来注册回调函数，当 <strong><code>promise reslove 或者 reject</code> 后会将注册函数加到微任务队列</strong>。</p><p>上边的代码因为是直接 <code>resolve</code> 了，所以会将 <code>() =&gt; console.log(&quot;2&quot;)</code>  注册到微任务队列中。</p><p>宏任务执行完毕后开始执行微任务，所以最后输出  <code>2</code> 。</p><p>再看下 <code>async</code> 和 <code>await</code> ：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve());</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  method()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上边的会输出什么呢？</p><hr><p>先输出 <code>2</code>，再输出 <code>1</code>。</p><p>这里需要明确一点，<code>async</code> 修饰的函数，相当于给当前函数<strong>包了一层 Promise</strong>。</p><p>所以</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  method()</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>相当于</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve,reject)&#123; resolve(method())&#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结合前边说的<strong>传给 Promise 的那个函数会直接执行。</strong></p><p>所以先执行 <code>resolve(method())</code>，进入<code>method</code> 内部：<br>接下来是 <code>await</code> 的作用：遇到 <code>await</code> 会<strong>先执行 <code>await</code> 右边的逻辑</strong>，执行完之后会暂停到这里。跳出当前函数去执行之前的代码。<br>所以 <code>method()</code> 方法中，</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve());</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先执行了 <code>method2</code>，当 <code>method2</code> 返回了 <code>Promise</code> 后就会暂定执行，跳回 <code>main</code> 函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>((resolve,reject)&#123; resolve(method())&#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>main</code> 函数执行完毕后才会再回到 <code>method</code> 方法中。</p><p>所以先输出 <code>2</code>，后输出 <code>1</code>。</p><p>如果想要先输出 1 再输出 2 需要怎么改呢？</p><hr><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve());</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span>  <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> method() <span class="comment">// 这里 await 即可</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p>再看一个：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">const</span> n = <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve(<span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  method();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure><p>上边的会输出什么呢？</p><hr><p>当 <code>main</code> 函数执行结束后，按照之前说的应该是回到 <code>await</code> 那里，所以应该输出<code>3 2 1</code> 吗？</p><p>其实是不对的，<code>await</code> 还有一个特性，它会把后边执行的代码整个<strong>注册为回调函数，相当于放到了 .then 里边</strong>，如果 <code>Promise</code> 直接 <code>resolve</code>，相当于将后边的代码放到了微任务队列中。</p><p>所以</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">const</span> n = <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>等价于：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve(method2())).then(<span class="function">(<span class="params">n</span>) =&gt;</span> <span class="built_in">console</span>.log(n));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>await</code> 之前已经有一个 <code>Promise</code> 把任务加到了微任务队列中。所以正确的输出顺序是 <code>3 1 2</code>。</p><p>所以回到 <strong>await 继续执行其实是表象</strong>，本质上是从微任务队列中把之前要执行的代码取了出来继续执行。</p><p>如果想输出 <code>3 2 1</code> ，该怎么改代码呢？</p><hr><p>可以将 <code>new Promise((resolve) =&gt; resolve()).then(() =&gt; console.log(1));</code> 这句中的 <code>reslove()</code> 函数延迟调用，通过 <code>setTimeout</code> 放到下一个宏任务中执行。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> setTimeout(resolve, <span class="number">0</span>)).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">1</span>));</span><br><span class="line">  <span class="keyword">const</span> n = <span class="keyword">await</span> method2();</span><br><span class="line">  <span class="built_in">console</span>.log(n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve(<span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  method();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="综合"><a href="#综合" class="headerlink" title="综合"></a>综合</h1><p>如果理解了上边的，下边的内容就简单了，首先明确几个点：</p><ol><li>【宏任务 [微任务]】 -&gt; 【宏任务 [微任务]】-&gt; 【宏任务 [微任务]】…</li></ol><p>​        当宏任务和当前宏任务产生的微任务全部执行完毕后，才会执行下一个宏任务。每遇到生成的微任务就放到微任务队列中，当前宏任        务代码全部执行后开始执行微任务队列中的任务</p><ol start="2"><li>传给 <code>new Promise</code> 的函数会<strong>直接执行</strong></li><li><code>async</code> 包装的函数相当于包了一层 <code>Promise</code> ，因此返回的一定是一个 <code>Promise</code></li><li>执行到 <code>await</code>，先执行 <code>await</code> 右边的东西，执行完后后会暂停在 <code>await</code> 这里，并且把后边的<strong>内容丢到 <code>then</code> 中</strong>（再结合第 <code>5</code> 点）。跳到外边接着执行。外边都执行完之后开始执行微任务队列</li><li>当 <code>promise</code> 变为 <code>resolve</code> 或者<code>reject</code> 的时候才会将 <code>then</code> 中注册的<strong>回调函数加入微任务队列中 </strong></li><li><code>setTimeout</code> 产生宏任务</li></ol><p>可以多读几遍下边开始正式练习，看代码的时候函数定义直接跳过，从执行函数开始看</p><h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><p>来一道魔鬼题：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>); </span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">2</span>)); </span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        resolve();</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">3</span>));</span><br><span class="line">      &#125;, <span class="number">0</span>); </span><br><span class="line">    &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">4</span>));</span><br><span class="line">    <span class="keyword">await</span> method3(); </span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>); </span><br><span class="line">    <span class="keyword">const</span> n = <span class="keyword">await</span> method2(); </span><br><span class="line">    <span class="built_in">console</span>.log(n); </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">6</span>);</span><br><span class="line">      setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">7</span>); </span><br><span class="line">        resolve(<span class="number">8</span>);</span><br><span class="line">      &#125;, <span class="number">0</span>); </span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">method3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">9</span>); </span><br><span class="line">      resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    method();</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">10</span>); </span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">11</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  main();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">12</span>);</span><br></pre></td></tr></table></figure><p>上边的代码输出什么？</p><hr><p>分析的时候我们需要明确什么时候产生了宏任务，什么时候产生了微任务，什么时候是直接执行的，结合上边总结 <code>6</code> 句话和注释可以看一下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>); <span class="comment">//[1]</span></span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">2</span>)); <span class="comment">// 第 1 个宏任务中注册微任务 1 // [5]</span></span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve();</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> resolve()).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">3</span>)); <span class="comment">// 第 2 个宏任务中注册微任务 2 // [10]</span></span><br><span class="line">    &#125;, <span class="number">0</span>); <span class="comment">// 注册宏任务 2</span></span><br><span class="line">  &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="number">4</span>)); <span class="comment">// 第 2 个宏任务中注册微任务 1 // [9]</span></span><br><span class="line">  <span class="keyword">await</span> method3(); <span class="comment">// 第 1 个宏任务中注册微任务 2</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">5</span>); <span class="comment">// 第 1 个宏任务中注册微任务 2 // [6]</span></span><br><span class="line">  <span class="keyword">const</span> n = <span class="keyword">await</span> method2(); <span class="comment">// 第 1 个宏任务中注册微任务 2</span></span><br><span class="line">  <span class="built_in">console</span>.log(n); <span class="comment">// 第 1 个宏任务中注册微任务 2 // 第 3 个宏任务中注册微任务 1 // [12]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">6</span>); <span class="comment">// [7]</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">7</span>); <span class="comment">// [11]</span></span><br><span class="line">      resolve(<span class="number">8</span>);</span><br><span class="line">    &#125;, <span class="number">0</span>); <span class="comment">// 注册宏任务 3</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">9</span>); <span class="comment">//[2]</span></span><br><span class="line">    resolve();</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  method();</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve();</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">10</span>); <span class="comment">// 第 1 个宏任务中注册微任务 3 // [8]</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">11</span>); <span class="comment">//[3]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">12</span>); <span class="comment">//[4]</span></span><br></pre></td></tr></table></figure><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>当然上边的规则也不是黄金原则，归根到底还依赖于我们运行的环境是什么，现在 <code>js</code> 的运行时有 <code>V8</code>、<code>Node.js</code> 等，它们也有各自的版本。</p><p>对于下边的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve();</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> p;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"after:await"</span>);</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">p.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"tick:a"</span>)).then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"tick:b"</span>));</span><br></pre></td></tr></table></figure><p>按照之前规则，先执行 <code>await p</code>  ，因为 <code>p</code>  已经 <code>resolve</code> 了，所以会把后边的代码 <code>console.log(&quot;after:await&quot;);</code> 加入到微任务队列中。</p><p>接着又依次把 <code>() =&gt; console.log(&quot;tick:a&quot;)</code> 、<code>() =&gt; console.log(&quot;tick:b&quot;)</code>  加到微任务队列中。</p><p>所以输出是 <code>after:await，tick:a， tick:b</code> 。</p><p>在浏览器中运行符合我们的想法：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230409083903731.png" alt="image-20230409083903731"></p><p>在 <code>Node.js V16</code> 中运行符合我们的想法：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230409083940125.png" alt="image-20230409083940125"></p><p>但在 <code>Node.js V10</code> 中运行就些许不一样了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230409084009540.png" alt="image-20230409084009540"></p><p>至于为什么就是文章开头说的了，不管输出什么，其实就是其底层代码所决定的了。再具体的原因就需要去看 <code>Node.js</code> 相应的源码了。</p><p>当底层的逻辑影响到我们的业务逻辑的时候，可能就真的得去看这些源码和解决方案了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近看了死月的 &lt;a href=&quot;https://s.juejin.cn/ds/AshEp8U/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;趣学 Node.js&lt;/a&gt; 小册，关于宏任务、微任务部分突然意识到所谓的执行顺序其实就是底层 &lt;code&gt;C+
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="js" scheme="https://windliang.wang/tags/js/"/>
    
  </entry>
  
  <entry>
    <title>https原理及实践</title>
    <link href="https://windliang.wang/2023/01/14/https%E8%AF%81%E4%B9%A6%E5%8E%9F%E7%90%86%E6%8A%93%E5%8C%85%E5%92%8C%E5%AE%9E%E8%B7%B5/"/>
    <id>https://windliang.wang/2023/01/14/https%E8%AF%81%E4%B9%A6%E5%8E%9F%E7%90%86%E6%8A%93%E5%8C%85%E5%92%8C%E5%AE%9E%E8%B7%B5/</id>
    <published>2023-01-14T01:08:21.000Z</published>
    <updated>2023-01-27T02:56:48.584Z</updated>
    
    <content type="html"><![CDATA[<p>网站的证书快要过期了，索性就总结下 <code>HTTPS</code> 相关的东西吧。</p><h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p><code>HTTPS</code>  说白了就是加密传输信息，防止信息泄露，需要提前了解几个概念：</p><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p>先说说最简单的加密，替换法，每个字符都对应到一个新的字符：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116081932963.png" alt="image-20230116081932963"></p><p>比如明文是 <code>windliang</code> ，通过上边的映射关系密文就是 <code>pbgwebtgz</code>。</p><p>古代就使用过这种加密算法，但通过词频的分析，暴力枚举很容易被破解，因此现代已经不会用这种算法了。</p><p>不管什么加密算法，都可以分为明文，密文，和密钥、算法三部分。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116083309471.png" alt="image-20230116083309471"></p><p>这里的密钥就可以理解为上边的映射表，算法就是直接映射。</p><p>现代的加密算法，密钥一般就是一个字符串，算法就比较复杂了，会进行各种计算，或操作、与操作，分组等，然后再应用各种数学知识，质数、模相等… ，大学的时候有学过，这里也忘光了，下边只介绍简单概念了。</p><h2 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h2><p>和古代的加密算法流程是一样的</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116083309471.png" alt="image-20230116083309471"></p><p>只是其中的算法相对于简单的替换会更加复杂。常用的有 DES 算法、AES 算法、3DES 算法、TDEA 算法、Blowfish 算法、RC5 算法、IDEA 算法等。其特点是，加密和解密<strong>使用同一密钥</strong>。</p><h2 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>与之前最大的不同之处是包含了两个密钥，一个称之为公钥，一个称之为私钥。并且算法相对于对称加密会更加复杂。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116220615109.png" alt="image-20230116220615109"></p><p>公钥和私钥都能进行加密，用公钥加密后只能用私钥解密，用私钥加密后只能用公钥解密。</p><p>常见非对称加密算法包括 DSA 算法、RSA 算法、Elgamal 算法、背包算法、Rabin 算法、D-H 算法、ECC 算法等。由于算法非常复杂，因此非对称加解密会<strong>非常耗时</strong>。</p><h2 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h2><p>可以看做一种特殊的加密。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116221214098.png" alt="image-20230116221214098"></p><p>它是单向的，加密后无法再还原。可以将任意长度的明文串映射为较短的（通常是固定长度的）二进制串（<code>Hash</code> 值），并且不同的明文很难映射为相同的 <code>Hash</code> 值。</p><p>目前常见的 <code>Hash</code> 算法包括国际上的 Message Digest（MD）系列和 Secure Hash Algorithm（SHA）系列算法，以及国内的 <code>SM3</code> 算法。</p><p>利用这个特性，我们就可以快速比对文本是否被篡改，将明文和 <code>hash</code>  值一起传输给对方，收到后将明文重新生成 <code>Hash</code> 值，再和收到的 <code>Hash</code> 值比对，如果 <code>Hash</code> 值不同就说明被篡改过了。</p><h1 id="传纸条"><a href="#传纸条" class="headerlink" title="传纸条"></a>传纸条</h1><p>假设教室中第一排的小明想给最后一排的小红传纸条。</p><h2 id="直接传"><a href="#直接传" class="headerlink" title="直接传"></a>直接传</h2><p>第一种最简单的方法就是想传啥直接写到纸上，然后叠起来，让教室中间的人帮助传递过去即可。</p><p>但存在一个最大的问题，不安全，中间的某一个同学如果突发好奇，直接拆开纸条，内容就一览无余了。</p><h2 id="对称加密-1"><a href="#对称加密-1" class="headerlink" title="对称加密"></a>对称加密</h2><p>小明想了想那我和小红约定一个对称加密算法吧，我先把密钥写到纸上传给小红，之后我都加密后写到纸上传给小红，这样就安全了吧。</p><p>中间传纸条的小刚突发好奇，拆开了纸条但这次好奇心没有得到满足，发现纸上写的由于加密过了已经完全看不懂了。</p><p>但小华拆开纸条却突然笑出了声，因为他读懂了纸条内容，在小明第一次传写有密钥的纸条的时候小华就已经拆开并且偷偷记下来了。所以后续的传递，只要小华想看，拆开以后通过密钥解密一下就可以了。</p><h2 id="非对称加密-1"><a href="#非对称加密-1" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>小明和小红想这可不行啊，于是两个人说干脆我们用非对称加密吧，我们的纸条内容都用对方的公钥加密，拿到纸条后用自己的私钥进行解密。这样纸条被别人看到也无所谓了，因为私钥只有我们自己有。</p><p>于是第一次传纸条的时候，小明把自己的公钥写好传给了小红，小红以后拿着这个公钥加密后再写到纸条上。小红也把自己的公钥写好传给了小明，小明以后拿着这个公钥加密后再写到纸条上。</p><p>小明收到小红写的纸条内容后，因为纸条是用小明的公钥加密过的，小明只需要用自己的私钥解密一下即可正常阅读了。</p><p>小红也是同样的道理。</p><p>小华在小红和小明第一次传纸条的时候同样又把两个公钥记了下来，但后续小红和小明的聊天小华却没办法解密了，因为纸条内容都是经过公钥加密的，如果想要解密必须通过私钥，但私钥在小红和小明各自的手里，其他人都无能为力了。</p><p>但小刚此时却偷偷笑出了声，因为第一次用纸条传公钥的时候，小刚偷偷动了手脚。</p><p>小明将公钥传给小红的时候，小刚偷偷将纸条换成了写有自己公钥的纸条，因此小红拿到的是小刚的公钥。</p><p>小红传公钥给小明的时候，小刚同样的将小红的公钥换成了自己的，因此小明拿到的是小刚的公钥。</p><p>当小明用收到的公钥加密后传递到小刚这里的时候，小刚就用自己的私钥进行了解密，然后用小红的公钥进行了加密发给了小红。小红和小明以为在安全的通信，其实被小刚一览无余了。</p><h2 id="签名证书"><a href="#签名证书" class="headerlink" title="签名证书"></a>签名证书</h2><p>此时小红和小明遇到的问题就是无法确认收到的公钥是否是对方的。</p><p>小亮此时站出说，我来把证书内容用我的私钥签名，公钥我直接写到黑板上，具体过程如下：</p><p>证书上写好你们自己的名字和你们的公钥，我会把证书上的内容做一次 <code>Hash</code>，然后把这个 <code>Hash</code>  用我的私钥加密，将加密后的内容也放到证书上。</p><p>现在证书上有你们的名字和你们的公钥，外加一个加密后的 <code>Hash</code>  值。</p><p>你们拿到别人的证书后，先看下名字是不是你们要的人，然后计算一下证书上的内容得到 <code>Hash</code>  值，再用黑板上的公钥把证书上加密的 <code>Hash</code> 值进行解密，看一下这两个值是否相同，如果相同的话就证明证书没有被篡改过，证书上的公钥可以放心使用。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120181352297.png" alt="image-20230120181352297"></p><h2 id="证书链"><a href="#证书链" class="headerlink" title="证书链"></a>证书链</h2><p>自从有了证书，小刚拿到小明传给小红的证书后就无能为力了。</p><p>第一不能修改证书上的任何内容，一修改就会导致最终的 <code>Hash</code> 值不一样，就会被别人发现造假。</p><p>第二他也不能把证书替换成自己的，因为证书写了<strong>自己的名字</strong>，证书传过去以后小红一看这是小刚的证书那直接暴露。</p><p>班上的同学发现这也太棒了 ，再也不会有人读到纸条内容了，但小亮就变的太忙了，越来越多的人跟他要证书。小亮想要不我给小杨发个证书，以后让小杨给别人发证书。</p><p>于是后边的人就找小杨发证书，这样传递纸条的时候，除了自己的证书，也要把小杨的证书写上。收到的人用小杨的证书上的公钥来验证收到的证书是不是真的，而小杨的证书用黑板上的写的小亮的公钥来验证是否是真的。</p><p>未来小杨也觉得太忙了，她可能也授权某个人也能给别人发证书，这样第一次传递纸条的时候就需要把整个链条上的证书都写上，依次确认真假，但最后一次证书一定使用黑板上的公钥来确认，因为这个是大家都能看见的，一定不会是假的。</p><h2 id="非对称加密结合对称加密"><a href="#非对称加密结合对称加密" class="headerlink" title="非对称加密结合对称加密"></a>非对称加密结合对称加密</h2><p>课堂上大家传纸条一段时间后发现过程中用非对称算法加密解密实在是太费时间了，本来原文写了 <code>10</code> 个字，加密加密可能得用一小时，虽然安全但太麻烦了。</p><p>于是小明对小红说：我们是不是能结合下对称加密算法。当我收到你的证书后，并且验证证书是可信的，我就生成一个对称加密的密钥，用证书上你的公钥加密后写到纸条上传给你。你收到后用自己的私钥解密，拿到对称加密算法的密钥后，以后写纸条都通过对称加密进行加密传给我。这样就既保证了传输的安全性，也节省了加解密的时间。</p><p>即使中间有人拿到了加密后的密钥，因为没有你的私钥，他也无能为力。</p><p>小红：赞！就这样搞。</p><h1 id="HTTPS-实际情况"><a href="#HTTPS-实际情况" class="headerlink" title="HTTPS 实际情况"></a>HTTPS 实际情况</h1><h2 id="关于证书"><a href="#关于证书" class="headerlink" title="关于证书"></a>关于证书</h2><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120173638956.png" alt="image-20230120173638956"></p><p>实际证书会包含更多的东西，域名信息，有效期，以及之前说的签名等等。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120173744353.png" alt="image-20230120173744353"></p><p>以及上边的图里的证书链，会通过证书上公钥依次验证证书的有效性。而根证书就相当于黑板上写的公钥，这个会提前内置到系统中，如下图所示，是系统中所有的根证书。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120174128365.png" alt="image-20230120174128365"></p><p>浏览器确认当前域名和证书上的域名一致，并且证书是有效的，就会有一个通过的锁，否则会有一个危险提示。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120174301762.png" alt="image-20230120174301762"></p><h2 id="关于对称加密的密钥"><a href="#关于对称加密的密钥" class="headerlink" title="关于对称加密的密钥"></a>关于对称加密的密钥</h2><p>实际过程中对称加密算法的密钥会通过多次传输最终拼接出一个密钥，过程可以参考 <a href="https://juejin.cn/post/6844904046063517704" target="_blank" rel="noopener">SSL / TLS 工作原理和详细握手过程</a></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20230120183519392.png" alt="image-20230120183519392"></p><p>对称加密的密钥由 <code>client random</code>，<code>server random</code> 和 <code>premaster secret</code> 三部分结合后生成。</p><h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>以阿里云为例，记录下整个过程：</p><p>打开阿里云的 <a href="https://yundun.console.aliyun.com/?spm=5176.12818093.ProductAndResource--ali--widget-product-recent.dre5.56a616d0t5nFY9&amp;p=cas#/certExtend/free" target="_blank" rel="noopener">证书网站</a>，点击创建证书：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115204319376.png" alt="image-20230115204319376"></p><p>每年免费 <code>20</code> 个额度：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115204518817.png" alt="image-20230115204518817"></p><p>点击立即购买，并且完成后续的支付流程。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115204632274.png" alt="image-20230115204632274"></p><p>购买结束后，回到控制台，点击「创建证书」，会在页面中多了一条待申请的证书，接着点击证书申请：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115205205575.png" alt="image-20230115205205575"></p><p>填写自己的域名，然后点击「提交审核」。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115205413799.png" alt="image-20230115205413799"></p><p>如果是阿里云的域名，<code>DNS</code> 记录里会自动加一条下边的 <code>TXT</code> 记录。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115205938916.png" alt="image-20230115205938916"></p><p>可以到自己的 <code>DNS</code>  解析控制台看一眼：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115210039243.png" alt="image-20230115210039243"></p><p>接着只需要等邮箱通知就可以：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115210232162.png" alt="image-20230115210232162"></p><p>刷新一下列表，证书就变为了已签发：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115210337924.png" alt="image-20230115210337924"></p><p>点击右边的下载，会弹出页面选择证书类型，这里我下载 <code>nginx</code> 的：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115210510184.png" alt="image-20230115210510184"></p><p>下来好的两个文件，<code>.pem</code> 就是我们的证书，<code>.key</code> 是我们的私钥。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230115210823709.png" alt="image-20230115210823709"></p><p>接下来登录自己的服务器，前提是你已经按照 <a href="https://windliang.wang/2020/02/23/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA%E7%BD%91%E7%AB%99%E5%85%A8%E8%BF%87%E7%A8%8B/">搭建网站</a> 这个教程配置好了网站。</p><p>我们可以先把上边的两个文件重命名，并且通过任意的方式上传到自己的服务器，我是用 <code>FTP</code>  传上去。</p><p>接着通过 <code>ssh</code> 登录自己的服务器，<code>ssh -p22 root@你的服务器 ip</code>，将刚传上来的服务器证书和密钥移动到 <code>nginx</code> 的相应位置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv -f /var/ftp/pub/windliang.pem /etc/nginx/cert/</span><br><span class="line">mv -f /var/ftp/pub/windliang.key /etc/nginx/cert/</span><br></pre></td></tr></table></figure><p><code>/var/ftp/pub/windliang.pem</code> 和 <code>/var/ftp/pub/windliang.key</code> 需要改成你自己的文件地址。</p><p>还需要在网站的 <code>nginx</code> 的配置文件中加入 <code>https</code> 的配置，监听 <code>443</code> 端口：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl;   #SSL协议访问端口号为443。此处如未添加ssl，可能会造成Nginx无法启动。</span><br><span class="line">        server_name windliang.wang;  #将localhost修改为您证书绑定的域名，例如：www.example.com。</span><br><span class="line">        root html;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        ssl_certificate cert/windliang.pem;   #替换成您证书的文件名。</span><br><span class="line">        ssl_certificate_key cert/windliang.key;   #替换成您证书的密钥文件名。</span><br><span class="line">        ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;  #使用此加密套&gt;</span><br><span class="line">件。</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;   #使用该协议进行配置。</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        location / &#123;</span><br><span class="line">                root /root/myblog;   #站点目录。</span><br><span class="line">                index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    server_name www.windliang.wang;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">301</span> $scheme:<span class="comment">//windliang.wang$request_uri;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来重启 <code>nginx</code> 。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><p>此时重新打开网站证书就设置成功了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20230116063503733.png" alt="image-20230116063503733"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;网站的证书快要过期了，索性就总结下 &lt;code&gt;HTTPS&lt;/code&gt; 相关的东西吧。&lt;/p&gt;
&lt;h1 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h1&gt;&lt;p&gt;&lt;code&gt;HTTPS&lt;/code&gt;
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="https" scheme="https://windliang.wang/tags/https/"/>
    
  </entry>
  
  <entry>
    <title>生日快乐</title>
    <link href="https://windliang.wang/2022/12/31/%E7%94%9F%E6%97%A5%E5%BF%AB%E4%B9%90/"/>
    <id>https://windliang.wang/2022/12/31/%E7%94%9F%E6%97%A5%E5%BF%AB%E4%B9%90/</id>
    <published>2022-12-31T01:31:54.000Z</published>
    <updated>2023-01-01T03:21:40.499Z</updated>
    
    <content type="html"><![CDATA[<p>一直过的农历生日腊月初十，农历的腊月是个比较尴尬的月份：</p><p>– 你属什么？</p><p>– 属猪</p><p>– 那你是 <code>95</code> 年生的咯</p><p>– 我是 <code>96</code> 年生的</p><p>– <code>96</code> 年不是鼠年吗</p><p>– <code>96</code> 年 <code>1</code> 月还没过年，所以是 <code>96</code> 年的🐷</p><p>因为属相是按农历算的，但腊月一般都是第二年的 <code>1</code> 月了，导致每次都得解释下，哈哈。</p><p>今年凑巧和元旦过在了同一天，印象中小时候也有一次赶在了元旦，索性写个小程序来看一下吧。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221231102025214.png" alt="image-20221231102025214"></p><p>上一次生日在元旦已经是快 <code>20</code> 年前的 <code>04</code> 年了，还看到了一个神奇的年份，下一次农历和公历重合的生日是 <code>2033</code> 年。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221231103536072.png" alt="image-20221231103536072"></p><p>因为农历不像公历一样有确切的数学规律，只能由天文台测定后提供，所以一般都是采用「查表法」获取农历数据，我这里就偷懒直接使用别人的库了 <a href="https://www.npmjs.com/package/solarlunar" target="_blank" rel="noopener">https://www.npmjs.com/package/solarlunar</a> 哈哈，这也导致目前只能查 <code>1900 - 2100</code> 年的数据。</p><p>感兴趣的同学也可以试试这个小程序 「农历生日转换」。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E5%BE%AE%E4%BF%A1%E6%A0%87%E5%87%86%E7%BB%BF%E7%89%88.png" alt="扫码_搜索联合传播样式-微信标准绿版"></p><p>说到生日，<a href="https://windliang.wang/2017/01/07/21%E5%B2%81%E7%9A%84%E4%BD%A0%EF%BC%8C%E7%94%9F%E6%97%A5%E5%BF%AB%E4%B9%90/">我的博客</a> 其实也是 <code>17</code> 年生日那天搭建的，现在回过头再看感觉还是很奇妙的，就像和当前的自己产生了连接一样。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一直过的农历生日腊月初十，农历的腊月是个比较尴尬的月份：&lt;/p&gt;
&lt;p&gt;– 你属什么？&lt;/p&gt;
&lt;p&gt;– 属猪&lt;/p&gt;
&lt;p&gt;– 那你是 &lt;code&gt;95&lt;/code&gt; 年生的咯&lt;/p&gt;
&lt;p&gt;– 我是 &lt;code&gt;96&lt;/code&gt; 年生的&lt;/p&gt;
&lt;p&gt;– &lt;code&gt;
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="微信小程序" scheme="https://windliang.wang/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>前端 mock 数据的几种方式</title>
    <link href="https://windliang.wang/2022/12/20/%E5%89%8D%E7%AB%AFmock%E6%95%B0%E6%8D%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/"/>
    <id>https://windliang.wang/2022/12/20/%E5%89%8D%E7%AB%AFmock%E6%95%B0%E6%8D%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/</id>
    <published>2022-12-20T00:08:50.000Z</published>
    <updated>2022-12-25T05:08:39.385Z</updated>
    
    <content type="html"><![CDATA[<p>具体需求开发前，后端往往只提供接口文档，对于前端，最简单的方式就是把想要的数据写死在代码里进行开发，但这样的坏处就是和后端联调前还需要再把写死的数据从代码里删除，最好的方式是无侵入的 <code>mock</code> 。下边介绍几种常用的方式，大家可以结合自己的项目来选取。</p><p>大致分为三类，重写 <code>xhr/fetch</code>、<code>node.js</code> 服务中转、系统层面拦截。</p><h1 id="接口demo"><a href="#接口demo" class="headerlink" title="接口demo"></a>接口demo</h1><p>为了后边方便的安装 <code>node</code> 包，可以用 <code>webpack</code> 进行打包，具体配置可以参考 <a href="https://windliang.wang/2021/08/19/2021%E5%B9%B4%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%8F%91%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%8C%87%E5%8D%97/">2021年从零开发前端项目指南</a>，看到 <code>React</code> 配置的前一步就够了，只需要配置一个 <code>html</code> 和一个接口请求。 需要注意下 <code>webpack</code> 的版本，不同版本后续的配置会不同，这里我用的是 <code>5.75.0</code> 。</p><p>最终目标是通过 <code>mock</code> 让下边还没有开发好的接口正常返回数据：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"/api/data"</span>, &#123;</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123; <span class="attr">id</span>: <span class="number">10</span> &#125;),</span><br><span class="line">  method: <span class="string">"POST"</span>,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">json</span>) =&gt;</span> <span class="built_in">console</span>.log(json));</span><br></pre></td></tr></table></figure><p>现在肯定是 <code>404</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221223093023287.png" alt="image-20221223093023287"></p><h1 id="Better-mock"><a href="#Better-mock" class="headerlink" title="Better-mock"></a>Better-mock</h1><p><strong>better-mock</strong> <code>fork</code> 自 <a href="https://github.com/nuysoft/Mock" target="_blank" rel="noopener">Mock.js</a>，使用方法和 <code>Mock.js</code> 一致，用于 <code>javascript</code> <code>mock</code> 数据生成，它可以拦截 <code>XHR</code> 和 <code>fetch</code> 请求，并返回自定义的数据类型。</p><p>只需要在调用接口前，引入 <code>better-mock</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Mock <span class="keyword">from</span> <span class="string">"better-mock"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock list 返回数组，大小是 1 到 10，对象中的 id 自动加 1</span></span><br><span class="line">Mock.mock(<span class="string">"/api/data"</span>, &#123;</span><br><span class="line">  <span class="string">"list|1-10"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id|+1"</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fetch(<span class="string">"/api/data"</span>, &#123;</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123; <span class="attr">id</span>: <span class="number">10</span> &#125;),</span><br><span class="line">  method: <span class="string">"POST"</span>,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">json</span>) =&gt;</span> <span class="built_in">console</span>.log(json));</span><br></pre></td></tr></table></figure><p>控制台此时就会输出数据了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221224203508017.png" alt="image-20221224203508017"></p><p> <code>better-mock</code> 一个好处就是可以通过它既有的语法来生成一些随机的数据，每次请求都会返回不同的数据。</p><p>坏处是会在请求发送前就拦截，导致在 <code>Chrome</code> 控制台就看不见请求了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221224203741121.png" alt="image-20221224203741121"></p><h1 id="just-mock"><a href="#just-mock" class="headerlink" title="just mock"></a>just mock</h1><p><a href="https://just-mock.vercel.app/" target="_blank" rel="noopener">just mock</a> 是一个浏览器插件，在代码中什么都不需要更改，只需要添加相应的接口和数据即可实现拦截。</p><p>插件安装好后添加相应的域名就可以拦截到相应的请求。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221224212934829.png" alt="image-20221224212934829"></p><p>接着进行相应的编辑添加对应的 <code>mock</code> 数据就好。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221224221427974.png" alt="image-20221224221427974"> </p><p>这样接口就会被拦截，控制台输出预设的数据：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221224223523797.png" alt="image-20221224223523797"></p><p>浏览器插件原理和 <code>Better-mock</code> 是一样的，但会更加轻便，无需融入到代码中。两者的原理是一样的，都是在网络请求前重写了全局的 <code>xhr</code> 和 <code>fetch</code> ，具体可以参考 <a href="https://windliang.wang/2022/08/23/%E6%B2%B9%E7%8C%B4%E8%84%9A%E6%9C%AC%E9%87%8D%E6%96%B0fetch%E5%92%8Cxhr%E8%AF%B7%E6%B1%82/">油猴脚本重写fetch和xhr请求</a>。</p><h1 id="koa"><a href="#koa" class="headerlink" title="koa"></a>koa</h1><p>本地通过 <code>koa</code> 开启一个接口服务。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serve.js</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">"koa-router"</span>)();</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/api/data"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.response.body = &#123;</span><br><span class="line">    status: <span class="literal">true</span>,</span><br><span class="line">    data: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    msg: <span class="string">"获取数据成功"</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// add router middleware:</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>本地开启运行：<code>node server.js</code>，接口提供的地址是 <code>localhost:3000</code>，但是请求的地址是 <code>loacalhost:8080</code> ，当然可以直接修改代码里的地址为 <code>localhost:3000</code> ，但还可以通过 <code>webpack</code>  的配置，将请求转发到 <code>localhost:3000</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: <span class="string">"./src/main.js"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    filename: <span class="string">"bundle.js"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    <span class="keyword">static</span>: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="comment">// 将 /api 开头的 http 请求，都代理到 localhost:3000 上，由 koa 提供 mock 数据</span></span><br><span class="line">      <span class="string">"/api"</span>: &#123;</span><br><span class="line">        target: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">        secure: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这样就可以看到控制台输出了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225101033687.png" alt="image-20221225101033687"></p><p>此外，<code>Chrome</code> 的 <code>Network</code> 也可以正常看到这个请求：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225101326328.png" alt="image-20221225101326328"></p><p>这种方法也可以用来解决跨域问题，举个例子：</p><p>如果本地想访问一个具体域名的接口，比如请求知乎的热榜接口：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">fetch(</span><br><span class="line">  <span class="string">"https://www.zhihu.com/api/v3/feed/topstory/hot-lists/total?limit=50&amp;desktop=true"</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    headers: &#123;</span><br><span class="line">      accept: <span class="string">"*/*"</span>,</span><br><span class="line">      <span class="string">"accept-language"</span>: <span class="string">"zh-CN,zh;q=0.9,en;q=0.8"</span>,</span><br><span class="line">      <span class="string">"sec-ch-ua"</span>:</span><br><span class="line">        <span class="string">'"Not?A_Brand";v="8", "Chromium";v="108", "Google Chrome";v="108"'</span>,</span><br><span class="line">      <span class="string">"sec-ch-ua-mobile"</span>: <span class="string">"?0"</span>,</span><br><span class="line">      <span class="string">"sec-ch-ua-platform"</span>: <span class="string">'"macOS"'</span>,</span><br><span class="line">      <span class="string">"sec-fetch-dest"</span>: <span class="string">"empty"</span>,</span><br><span class="line">      <span class="string">"sec-fetch-mode"</span>: <span class="string">"cors"</span>,</span><br><span class="line">      <span class="string">"sec-fetch-site"</span>: <span class="string">"same-origin"</span>,</span><br><span class="line">      <span class="string">"x-ab-param"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"x-ab-pb"</span>:</span><br><span class="line">        <span class="string">"CpoBCAAbAD8ARwC0AGkBagF0ATsCzALXAtgCoAOhA6IDtwOmBNYEEQVRBYsFjAWeBTAGMQbrBicHdAh2CHkI2gg/CWAJwwnECcUJxgnHCcgJyQnKCcsJzAnRCfQJBApJCmUKawqYCqUKqQq+CsQK1ArdCu0K/go7CzwLQwtGC3ELhwuNC9cL4AvlC+YLLAw4DHEMjwysDMMMyQz4DBJNAQAAAAAAAAAAAAAAAAAAAAAEAAEAAAEAAAEAAAIGAAABAAAAAAAAAAAAAAADAAAAAAEAAAABAQAAAAEAAQAAAAUCAQAABgIEAAACAAA="</span>,</span><br><span class="line">      <span class="string">"x-api-version"</span>: <span class="string">"3.0.76"</span>,</span><br><span class="line">      <span class="string">"x-requested-with"</span>: <span class="string">"fetch"</span>,</span><br><span class="line">      <span class="string">"x-zse-93"</span>: <span class="string">"101_3_3.0"</span>,</span><br><span class="line">      <span class="string">"x-zse-96"</span>:</span><br><span class="line">        <span class="string">"2.0_LYJSVCX+9b1YXp/sG1Azyi5tC5RpabLbkXb3w5s6rv=Gxy9uMXqMXm4LjYWRdoIz"</span>,</span><br><span class="line">      <span class="string">"x-zst-81"</span>:</span><br><span class="line">        <span class="string">"3_2.0aR_sn77yn6O92wOB8hPZnQr0EMYxc4f18wNBUgpTQ6nxERFZfRY0-4Lm-h3_tufIwJS8gcxTgJS_AuPZNcXCTwxI78YxEM20s4PGDwN8gGcYAupMWufIoLVqr4gxrRPOI0cY7HL8qun9g93mFukyigcmebS_FwOYPRP0E4rZUrN9DDom3hnynAUMnAVPF_PhaueTF4C8IhwVIDO_8ioC0JXfW9CKpCwCs4OBQAc0uBefagCKGMo1yroBh9CKe_STVHC1IqLKHJL_chSflqHCOqgYPhYKVwH8M4Lqqq9y1wH967NC7vH80UC8wCHswgHBDgY_ovg9r0wBcJO8s9OCzcLMNgLfkgNByqCLhhUf_veOQRY_dvxmCg_zugS8iBtBFgOZkwNLDw2skTX18XSYuJLqpCYBo_pMWbS8Pv3YtGFBaqL9AwCYhbL9eGVV2rNClDL1wJLmxCgKagNBUwSqYrHBbGp8e8HGggSMQ7xC3rOs"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    referrer: <span class="string">"https://www.zhihu.com/hot"</span>,</span><br><span class="line">    referrerPolicy: <span class="string">"no-referrer-when-downgrade"</span>,</span><br><span class="line">    body: <span class="literal">null</span>,</span><br><span class="line">    method: <span class="string">"GET"</span>,</span><br><span class="line">    mode: <span class="string">"cors"</span>,</span><br><span class="line">    credentials: <span class="string">"include"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>由于本地域名是 <code>http://localhost:8080/</code> ，此时浏览器就会报跨域的错了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225102517407.png" alt="image-20221225102517407"></p><p>此时后端可以通过 <code>CORS</code> 策略解决跨域的问题，但因为是测试环境，后端可能会说你自己解决吧，此时就可以通过 <code>Koa</code> 进行中转。</p><p>改写一下 <code>Koa</code> 的代码，先请求后端的接口，接着将收到的数据拿到后返回。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">"koa"</span>;</span><br><span class="line"><span class="keyword">import</span> fetch <span class="keyword">from</span> <span class="string">"node-fetch"</span>;</span><br><span class="line"><span class="keyword">import</span> Router <span class="keyword">from</span> <span class="string">"koa-router"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line">router.post(<span class="string">"/api/data"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(</span><br><span class="line">    <span class="string">"https://www.zhihu.com/api/v3/feed/topstory/hot-lists/total?limit=50&amp;desktop=true"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      headers: &#123;</span><br><span class="line">        accept: <span class="string">"*/*"</span>,</span><br><span class="line">        <span class="string">"accept-language"</span>: <span class="string">"zh-CN,zh;q=0.9,en;q=0.8"</span>,</span><br><span class="line">        <span class="string">"sec-ch-ua"</span>:</span><br><span class="line">          <span class="string">'"Not?A_Brand";v="8", "Chromium";v="108", "Google Chrome";v="108"'</span>,</span><br><span class="line">        <span class="string">"sec-ch-ua-mobile"</span>: <span class="string">"?0"</span>,</span><br><span class="line">        <span class="string">"sec-ch-ua-platform"</span>: <span class="string">'"macOS"'</span>,</span><br><span class="line">        <span class="string">"sec-fetch-dest"</span>: <span class="string">"empty"</span>,</span><br><span class="line">        <span class="string">"sec-fetch-mode"</span>: <span class="string">"cors"</span>,</span><br><span class="line">        <span class="string">"sec-fetch-site"</span>: <span class="string">"same-origin"</span>,</span><br><span class="line">        <span class="string">"x-ab-param"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"x-ab-pb"</span>:</span><br><span class="line">          <span class="string">"CpoBCAAbAD8ARwC0AGkBagF0ATsCzALXAtgCoAOhA6IDtwOmBNYEEQVRBYsFjAWeBTAGMQbrBicHdAh2CHkI2gg/CWAJwwnECcUJxgnHCcgJyQnKCcsJzAnRCfQJBApJCmUKawqYCqUKqQq+CsQK1ArdCu0K/go7CzwLQwtGC3ELhwuNC9cL4AvlC+YLLAw4DHEMjwysDMMMyQz4DBJNAQAAAAAAAAAAAAAAAAAAAAAEAAEAAAEAAAEAAAIGAAABAAAAAAAAAAAAAAADAAAAAAEAAAABAQAAAAEAAQAAAAUCAQAABgIEAAACAAA="</span>,</span><br><span class="line">        <span class="string">"x-api-version"</span>: <span class="string">"3.0.76"</span>,</span><br><span class="line">        <span class="string">"x-requested-with"</span>: <span class="string">"fetch"</span>,</span><br><span class="line">        <span class="string">"x-zse-93"</span>: <span class="string">"101_3_3.0"</span>,</span><br><span class="line">        <span class="string">"x-zse-96"</span>:</span><br><span class="line">          <span class="string">"2.0_LYJSVCX+9b1YXp/sG1Azyi5tC5RpabLbkXb3w5s6rv=Gxy9uMXqMXm4LjYWRdoIz"</span>,</span><br><span class="line">        <span class="string">"x-zst-81"</span>:</span><br><span class="line">          <span class="string">"3_2.0aR_sn77yn6O92wOB8hPZnQr0EMYxc4f18wNBUgpTQ6nxERFZfRY0-4Lm-h3_tufIwJS8gcxTgJS_AuPZNcXCTwxI78YxEM20s4PGDwN8gGcYAupMWufIoLVqr4gxrRPOI0cY7HL8qun9g93mFukyigcmebS_FwOYPRP0E4rZUrN9DDom3hnynAUMnAVPF_PhaueTF4C8IhwVIDO_8ioC0JXfW9CKpCwCs4OBQAc0uBefagCKGMo1yroBh9CKe_STVHC1IqLKHJL_chSflqHCOqgYPhYKVwH8M4Lqqq9y1wH967NC7vH80UC8wCHswgHBDgY_ovg9r0wBcJO8s9OCzcLMNgLfkgNByqCLhhUf_veOQRY_dvxmCg_zugS8iBtBFgOZkwNLDw2skTX18XSYuJLqpCYBo_pMWbS8Pv3YtGFBaqL9AwCYhbL9eGVV2rNClDL1wJLmxCgKagNBUwSqYrHBbGp8e8HGggSMQ7xC3rOs"</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      referrer: <span class="string">"https://www.zhihu.com/hot"</span>,</span><br><span class="line">      referrerPolicy: <span class="string">"no-referrer-when-downgrade"</span>,</span><br><span class="line">      body: <span class="literal">null</span>,</span><br><span class="line">      method: <span class="string">"GET"</span>,</span><br><span class="line">      mode: <span class="string">"cors"</span>,</span><br><span class="line">      credentials: <span class="string">"include"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> res.json();</span><br><span class="line">  ctx.response.body = &#123;</span><br><span class="line">    status: <span class="literal">true</span>,</span><br><span class="line">    data,</span><br><span class="line">    msg: <span class="string">"获取数据成功"</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">app.use(router.routes());</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>此时还是请求 <code>/api/data</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"/api/data"</span>, &#123;</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123; <span class="attr">id</span>: <span class="number">10</span> &#125;),</span><br><span class="line">  method: <span class="string">"POST"</span>,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">json</span>) =&gt;</span> <span class="built_in">console</span>.log(json));</span><br></pre></td></tr></table></figure><p>依旧让 <code>Webpack</code> 将数据转发到 <code>Koa</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">    <span class="keyword">static</span>: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    proxy: &#123;</span><br><span class="line">      <span class="comment">// 将 `/api` 开头的 http 请求，都代理到 `localhost:3000` 上，由 koa 提供 mock 数据</span></span><br><span class="line">      <span class="string">"/api"</span>: &#123;</span><br><span class="line">        target: <span class="string">"http://localhost:3000"</span>,</span><br><span class="line">        secure: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>现在控制台输出的就是知乎返回的数据了，跨域问题也消失了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225104513837.png" alt="image-20221225104513837"></p><p>当然上边解决跨域只是一个思路，具体的封装还需要结合项目来进行。</p><h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><p>上边可以通过 <code>webpack</code> 进行转发数据，是因为 <code>webpack</code> 也启动了一个 <code>HTTP</code> 服务器，只不过用的不是 <code>Koa</code> ，是更早的一个框架 <code>Express</code> ，而且它们是同一个团队开发的。</p><p>既然已经有了一个 <code>HTTP</code> 服务器，所以也没必要再开启另一个 <code>Koa</code> 的了，通过给 <code>webpack</code> 传递一个函数，重写 <code>Koa</code> 返回的数据即可。</p><p>只需要通过 <code>setupMiddlewares</code> 重写数据即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: <span class="string">"./src/main.js"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    filename: <span class="string">"bundle.js"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: &#123;</span><br><span class="line">    <span class="keyword">static</span>: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    setupMiddlewares: <span class="function">(<span class="params">middlewares, devServer</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!devServer) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"webpack-dev-server is not defined"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      middlewares.unshift(&#123;</span><br><span class="line">        path: <span class="string">"/api/data"</span>,</span><br><span class="line">        middleware: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// mock 数据模拟接口数据</span></span><br><span class="line">          res.send(&#123; <span class="attr">list</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], <span class="attr">msg</span>: <span class="string">"webpack mock"</span> &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> middlewares;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>此时控制台也可以看到输出的内容：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225111041070.png" alt="image-20221225111041070"></p><p>同时 <code>Network</code> 也是可以看到网络请求的。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225111123332.png" alt="image-20221225111123332"></p><h1 id="Charles"><a href="#Charles" class="headerlink" title="Charles"></a>Charles</h1><p>终极必杀 <code>mock</code> 方法，因为它除了可以拦截浏览器中的请求，也可以拦截任意 <code>App</code> 的数据，甚至还可以拦截手机中的 <code>HTTPS</code> 请求，前段时间很火的羊了个羊就可以通过 <code>Charles</code> 抓取请求然后迅速通关。</p><p>需要注意的是 <code>Charles</code> 抓不到 <code>localhost</code> 的请求，访问的时候需要将 <code>localhost</code> 改为 <code>localhost.charlesproxy.com</code>。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225122855681.png" alt="image-20221225122855681"></p><p><code>webpack</code> 需要加一个 <code>allowedHosts</code> 的配置，不然会返回 <code>Invalid Host header</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">  <span class="keyword">static</span>: path.resolve(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">    allowedHosts: <span class="string">"all"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>全部配置好后就可以看到 <code>Charles</code> 抓到的请求了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225115539515.png" alt="image-20221225115539515"></p><p>此时只需要提前写好一个 <code>json</code> 文件，然后将右键选择 <code>Map Local</code> 对应的文件即可。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225115824423.png" alt="image-20221225115824423"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"data"</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="string">"msg"</span>: <span class="string">"from charles"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来就可以在控制台看到 <code>mock</code> 成功了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221225120440472.png" alt="image-20221225120440472"></p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>几种 <code>mock</code> 方式各有优缺点，上边只是提供一个思路，具体的 <code>mock</code> 方案就需要结合项目进行一定的封装了。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;具体需求开发前，后端往往只提供接口文档，对于前端，最简单的方式就是把想要的数据写死在代码里进行开发，但这样的坏处就是和后端联调前还需要再把写死的数据从代码里删除，最好的方式是无侵入的 &lt;code&gt;mock&lt;/code&gt; 。下边介绍几种常用的方式，大家可以结合自己的项目来选取
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端" scheme="https://windliang.wang/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>前端er开发cocos小游戏快速入门</title>
    <link href="https://windliang.wang/2022/11/07/%E5%89%8D%E7%AB%AFer%E5%BC%80%E5%8F%91cocos%E5%B0%8F%E6%B8%B8%E6%88%8F%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"/>
    <id>https://windliang.wang/2022/11/07/%E5%89%8D%E7%AB%AFer%E5%BC%80%E5%8F%91cocos%E5%B0%8F%E6%B8%B8%E6%88%8F%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</id>
    <published>2022-11-07T00:56:38.000Z</published>
    <updated>2022-11-30T00:45:21.369Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间一直在更 <a href="https://vue.windliang.wang/" target="_blank" rel="noopener">vue2的源码系列</a>，最近换了换口味，学了一下 <code>cocos</code> ，照猫画虎的写了一个「挑战1024」小游戏。</p><p>学习一门新语言或者新框架其实就是一个堆时间的过程了，整个过程就是结合已有经验进行不同的猜测，然后验证，搞不定就去官网或者搜索引擎找答案，<code>99.9%</code> 的问题应该都能找到。</p><p><code>cocos</code> 网上很多是视频教程，虽然对新手友好，但是信息密度太低了，这里我总结一下 <code>cocos</code> 专有的或者不太符合直觉的一些点，前端的同学看完以后能更快的进入 <code>cocos</code> 的开发中。</p><p>建议先跟着官方的 <a href="https://docs.cocos.com/creator/manual/zh/getting-started/first-game/" target="_blank" rel="noopener">快速上手</a> 先一步一步实现一个小游戏，再读下边的文章效果会更佳。</p><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>cocos</code> 提供了游戏引擎，一些常用的操作，碰撞检测、重力模拟、变换位置、旋转、缩放、粒子系统等都可以通过配置一键实现，游戏引擎最终会帮我们把界面渲染到 <code>canvas</code> 节点上。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113101837574.png" alt="image-20221113101837574"></p><p>因为是渲染至 <code>canvas</code> ，当然很自然的可以支持跨端，一套代码可以编译至 <code>h5</code>、微信小游戏等平台。</p><p>同一个功能不同平台之间有不同的 <code>api</code> ，比如 <code>localstorage</code> 的使用会有所不同，<code>cocos</code> 会帮我们在上层抹平，只需要按照 <code>cocos</code> 的语法编写，编译的时候选择相应的平台就会转成对应平台的 <code>api</code>。</p><h1 id="编辑器"><a href="#编辑器" class="headerlink" title="编辑器"></a>编辑器</h1><p><code>cocos</code> 开发和平常的前端开发不太一样，它是代码结合 <code>UI</code> 拖拽来实现的，通过拖拽我们可以快速的布局、添加组件、设置属性等。</p><p>基于此，项目和编辑器就有了强绑定的关系，如果下载别人的项目，还需要下载相应的编辑器。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113104527992.png" alt="image-20221113104527992"></p><p>打开项目的时候需要选择相应的编辑器。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113104543991.png" alt="image-20221113104543991"></p><p>当然，如果编辑器差的版本比较小，<code>Cocos</code> 也可以帮我们自动升级项目的编辑器版本。如果是 <code>2.x</code> 升到 <code>3.x</code> 就会有 <code>break changes</code> ，需要手动进行一些代码的兼容。</p><p><code>ps</code>：<code>MAC</code> <code>M1</code> 版本不支持 <code>2.4.5</code> 以下的版本。</p><h1 id="场景-Scene"><a href="#场景-Scene" class="headerlink" title="场景/Scene"></a>场景/Scene</h1><p>游戏的 <code>ui</code> 、逻辑都挂载在某个场景（<code>Scene</code>）下，可以在资源管理器右键创建场景，然后双击打开。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113110410892.png" alt="image-20221113110410892"></p><p>接下来我们就可以在当前 <code>Canvas</code> 添加各种节点和代码逻辑了。</p><p>游戏如果有多个页面，可以新建多个场景各自维护。</p><p>ps：如果从导入网上下载的 <code>cocos</code> 项目，场景不会自动加载，需要双击一下场景然后再预览。</p><h1 id="节点-Node"><a href="#节点-Node" class="headerlink" title="节点/Node"></a>节点/Node</h1><p>我们可以通过右键创建节点，除了空结点，还帮我们预设了其他的很多节点，比如 <code>Label</code> 、<code>Button</code> 等。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113112755384.png" alt="image-20221113112755384"></p><p>节点是树状关系，每个节点可以得到它的父节点，也可以得到它的子节点。</p><p>比如我们可以通过 <code>getChildByName</code> 得到它的子节点。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.node.getChildByName(<span class="string">"message"</span>); <span class="comment">// 得到相应的 Node 节点</span></span><br></pre></td></tr></table></figure><p>通过 <code>this.node.parent</code> 拿到它的父节点。</p><h1 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h1><p>一个空结点只有一些位置、大小属性。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113153540396.png" alt="image-20221113153540396"></p><p>我们可以在 <code>Node</code> 节点上挂载一些组件让 <code>Node</code> 拥有样式和功能。</p><h2 id="Label-组件"><a href="#Label-组件" class="headerlink" title="Label 组件"></a>Label 组件</h2><p>如果我们创建一个 <code>Label</code> 节点，会自动挂一个 <code>Label</code> 组件。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113153748303.png" alt="image-20221113153748303"></p><p>通过 <code>Label</code> 组件我们可以设置文案 、字体大小等，展示到场景中的就是一个普通的 <code>Label</code>。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113153900887.png" alt="image-20221113153900887"></p><h2 id="图片组件"><a href="#图片组件" class="headerlink" title="图片组件"></a>图片组件</h2><p>我们可以通过将「资源管理器」中的图片拖动到「层级管理器」中生成一个带背景的 <code>Node</code> 节点。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113154522620.png" alt="image-20221113154522620"></p><p>拖过去之后会生成一个带有 <code>Sprite</code> 组件的节点，并将该图片设置为 <code>Sprite Frame</code> 属性的值，这样这张图片就会展示到场景中了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113154930782.png" alt="image-20221113154930782"></p><p>如果想要更改图片，只要把 <code>Sprite Frame</code> 属性清空，重新拖一个图片上去即可。</p><h2 id="脚本组件"><a href="#脚本组件" class="headerlink" title="脚本组件"></a>脚本组件</h2><p>这个是最重要的，我们可以编写游戏逻辑，设置一些点击监听、节点之间联动等逻辑，然后挂到 <code>Node</code> 节点上。</p><p>先新建一个 <code>js</code> 文件，会自动帮我们生成带有生命周期的一些代码。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113160458554.png" alt="image-20221113160458554"></p><p>双击打开新建的 <code>js</code> 文件，我们可以把文件和 <code>VSCode</code> 关联，用 <code>VSCode</code> 进行代码的编辑。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Learn cc.Class:</span></span><br><span class="line"><span class="comment">//  - https://docs.cocos.com/creator/manual/en/scripting/class.html</span></span><br><span class="line"><span class="comment">// Learn Attribute:</span></span><br><span class="line"><span class="comment">//  - https://docs.cocos.com/creator/manual/en/scripting/reference/attributes.html</span></span><br><span class="line"><span class="comment">// Learn life-cycle callbacks:</span></span><br><span class="line"><span class="comment">//  - https://docs.cocos.com/creator/manual/en/scripting/life-cycle-callbacks.html</span></span><br><span class="line"></span><br><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        <span class="comment">// foo: &#123;</span></span><br><span class="line">        <span class="comment">//     // ATTRIBUTES:</span></span><br><span class="line">        <span class="comment">//     default: null,        // The default value will be used only when the component attaching</span></span><br><span class="line">        <span class="comment">//                           // to a node for the first time</span></span><br><span class="line">        <span class="comment">//     type: cc.SpriteFrame, // optional, default is typeof default</span></span><br><span class="line">        <span class="comment">//     serializable: true,   // optional, default is true</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">// bar: &#123;</span></span><br><span class="line">        <span class="comment">//     get () &#123;</span></span><br><span class="line">        <span class="comment">//         return this._bar;</span></span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     set (value) &#123;</span></span><br><span class="line">        <span class="comment">//         this._bar = value;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LIFE-CYCLE CALLBACKS:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// onLoad () &#123;&#125;,</span></span><br><span class="line"></span><br><span class="line">    start () &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>properties</code> 是脚本组件的属性，写在这里的属性可以在 <code>Cocos</code> 的界面上看到。</p><p>比较重要是 <code>OnLoad</code> 和 <code>update</code> 两个生命周期，<code>OnLoad</code> 会在组件渲染前进行执行，这里我们可以进行一些初始化的操作，<code>update</code> 生命周期会在每一帧渲染前执行，这里我们就可以更新节点的位置让一些节点动起来。</p><p>文件编写好以后，我们可以以组件的形式逻辑挂载到相应的 <code>Node</code> 节点上。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113161547263.png" alt="image-20221113161547263"></p><h2 id="Widget-组件"><a href="#Widget-组件" class="headerlink" title="Widget 组件"></a>Widget 组件</h2><p>这个比较简单，它可以设置和边界的相对距离。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113173512981.png" alt="image-20221113173512981"></p><h2 id="碰撞组件"><a href="#碰撞组件" class="headerlink" title="碰撞组件"></a>碰撞组件</h2><p>两个 <code>Node</code> 节点相撞，我们可以根据它们的坐标手动进行判断，也可以在 <code>Node</code> 节点上挂载碰撞组件，设置它们的分组，然后在脚本组件中增加 <code>onCollisionEnter</code> 回调函数即可。</p><p>添加 <code>BoxCollider</code> 组件。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113162101123.png" alt="image-20221113162101123"></p><p>设置 <code>Node</code> 中的 <code>Group</code> 属性。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113162143563.png" alt="image-20221113162143563"></p><p><code>Group</code> 我们可以手动进行管理，并且设置哪些 <code>Group</code> 产生碰撞。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113162918517.png" alt="image-20221113162918517"></p><p>接下来还需要在游戏最开始的时候开始碰撞检测，可以给层级节点中的 <code>Canvas</code> 节点添加一个用户脚本组件 <code>game.js</code> ，然后修改脚本组件的 <code>OnLoad</code> 中调用下边的方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> collisionManager = cc.director.getCollisionManager();</span><br><span class="line">collisionManager.enabled = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p>最后在相应的 <code>Node</code> 节点的用户脚本中添加 <code>onCollisionEnter</code> 回调函数进行碰撞后的逻辑即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">onCollisionEnter(other) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.game.continueIng &amp;&amp; other.node.name !== <span class="string">"ground"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">switch</span> (other.node.name) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"star"</span>:</span><br><span class="line">      <span class="keyword">this</span>.handleStar(other);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"meteorites"</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"ground"</span>:</span><br><span class="line">      <span class="keyword">this</span>.game.endGame();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>通过回调参数 <code>other</code> 可以拿到碰撞的节点。</p><h2 id="刚体组件"><a href="#刚体组件" class="headerlink" title="刚体组件"></a>刚体组件</h2><p>这里通过刚体组件我们可以实现物体受到重力的效果。</p><p>首先给节点添加一个 <code>RightBody</code> 组件，并且将类型设置为 <code>Dynamic</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113165834371.png" alt="image-20221113165834371"></p><p>和碰撞组件一样，我们在 <code>Canvas</code> 对应的用户脚本组件的 <code>OnLoad</code> 中调用下边的方法开启重力模拟即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> instance = cc.director.getPhysicsManager();</span><br><span class="line">instance.enabled = <span class="literal">true</span>;</span><br><span class="line">instance.gravity = cc.v2(<span class="number">0</span>, <span class="number">-980</span> * <span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>这样相应的节点就会受到重力的作用了。</p><h2 id="动画组件"><a href="#动画组件" class="headerlink" title="动画组件"></a>动画组件</h2><p>在层级管理器选中相应的节点，点击「动画编辑器」，然后添加一个 <code>Animation</code> 组件</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113165636129.png" alt="image-20221113165636129"></p><p>接着添加一个 <code>Clip</code>，并进行编辑，设置动画的关键帧等，有点像 <code>photoShop</code> 里的动画编辑器。</p><p>保存后将新建的 <code>Clip</code> 拖到到对应的属性上即可。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113170821916.png" alt="image-20221113170821916"></p><h2 id="防穿透组件"><a href="#防穿透组件" class="headerlink" title="防穿透组件"></a>防穿透组件</h2><p><code>button</code> 被弹窗盖住，此时 <code>button</code> 依旧会响应到点击时间，此时可以通过给弹窗增加 <code>BlockInputEvents</code> 防止点击穿透。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221119205327720.png" alt="image-20221119205327720"></p><p>需要点击的时候激活，关闭的时候取消激活。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.node.getComponent(cc.BlockInputEvents).enabled = <span class="literal">true</span>; <span class="comment">// 点击的时候激活</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.node.getComponent(cc.BlockInputEvents).enabled = <span class="literal">false</span>;  <span class="comment">// 关闭的时候取消激活</span></span><br></pre></td></tr></table></figure><h1 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h1><p>设置的 <code>positon</code> 是在父节点坐标系下的位置。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113173906330.png" alt=""></p><p>如果它有子节点，它的子节点设置的 <code>positon</code> 就是基于上边的红线和绿线为坐标轴进行排布。</p><h1 id="脚本组件属性"><a href="#脚本组件属性" class="headerlink" title="脚本组件属性"></a>脚本组件属性</h1><p>我们可以脚本组件中添加一些属性。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">properties: &#123;</span><br><span class="line">       bird: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: Bird,</span><br><span class="line">       &#125;,</span><br><span class="line">       gravity: cc.v2(<span class="number">0</span>, <span class="number">-980</span> * <span class="number">2</span>),</span><br><span class="line">       starPool: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: StarPool,</span><br><span class="line">       &#125;,</span><br><span class="line">       scoreDisplay: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: cc.Label,</span><br><span class="line">       &#125;,</span><br><span class="line">       scoreResult: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: cc.Node,</span><br><span class="line">       &#125;,</span><br><span class="line">       successAudio: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: cc.AudioClip,</span><br><span class="line">       &#125;,</span><br><span class="line">       failAudio: &#123;</span><br><span class="line">           <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">           type: cc.AudioClip,</span><br><span class="line">       &#125;,</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><p>这样在 <code>cocos</code> 编辑器中我们可以通过拖动进行属性的初始化。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113172140746.png" alt="image-20221113172140746"></p><p>值的注意的是，如果我们在 <code>properties</code> 外边写属性，比如下边的 <code>num</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        <span class="comment">// foo: &#123;</span></span><br><span class="line">        <span class="comment">//     // ATTRIBUTES:</span></span><br><span class="line">        <span class="comment">//     default: null,        // The default value will be used only when the component attaching</span></span><br><span class="line">        <span class="comment">//                           // to a node for the first time</span></span><br><span class="line">        <span class="comment">//     type: cc.SpriteFrame, // optional, default is typeof default</span></span><br><span class="line">        <span class="comment">//     serializable: true,   // optional, default is true</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">        <span class="comment">// bar: &#123;</span></span><br><span class="line">        <span class="comment">//     get () &#123;</span></span><br><span class="line">        <span class="comment">//         return this._bar;</span></span><br><span class="line">        <span class="comment">//     &#125;,</span></span><br><span class="line">        <span class="comment">//     set (value) &#123;</span></span><br><span class="line">        <span class="comment">//         this._bar = value;</span></span><br><span class="line">        <span class="comment">//     &#125;</span></span><br><span class="line">        <span class="comment">// &#125;,</span></span><br><span class="line">    &#125;,</span><br><span class="line">  </span><br><span class="line">  num: <span class="number">0</span>, <span class="comment">// 自定义属性</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LIFE-CYCLE CALLBACKS:</span></span><br><span class="line"></span><br><span class="line">    onLoad () &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="keyword">this</span>.num)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start () &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>此时我们在 <code>onLoad</code> 打印该值只会是 <code>undefind</code> ，如果想在当前实例上挂载属性，我们可以选择在 <code>onLoad</code> 中进行值的初始化。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onLoad () &#123;</span><br><span class="line">  <span class="keyword">this</span>.num = <span class="number">2</span>; <span class="comment">// 自定义属性</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>这里需要注意的是如果改变脚本代码，保存后我们需要重新切到 <code>Cocos</code> 的编辑页面 才会重新进行编译。</p><h1 id="Prelab"><a href="#Prelab" class="headerlink" title="Prelab"></a>Prelab</h1><p>节点可以在编辑器生成，当然也可以通过代码动态生成。对于需要重复生成的节点，我们可以将它保存成 <code>Prefab</code>（预制）资源，作为我们动态生成节点时使用的模板。</p><p>做法就是在「层级管理器」随便新建一个 <code>Node</code> 节点，并且添加所需要的组件和自定义的脚本组件，最后将该 <code>node</code> 节点拖动到「资源管理器」即可。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221114064750298.png" alt="image-20221114064750298"></p><p>之后我们就可以层级管理器中刚新建的节点删除。当然，为了后续方便编辑，该 <code>Node</code> 节点也可以保留，但需要将其放到画面外，并且将脚本组件取消勾选一下，不执行逻辑。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221114065217375.png" alt="image-20221114065217375"></p><p>有了预制资源后，我们可以通过下边的代码来动态生成 <code>Node</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> newStar = cc.instantiate(<span class="keyword">this</span>.starPrefab); <span class="comment">// 根据预置资源生成 node 节点</span></span><br><span class="line">newStar.getComponent(<span class="string">"Star"</span>).init(<span class="keyword">this</span>, <span class="keyword">this</span>.game); <span class="comment">// 根据 node 节点的脚本组件进行初始化</span></span><br><span class="line"><span class="keyword">this</span>.node.addChild(newStar); <span class="comment">// 加到当前 node 节点的下面</span></span><br></pre></td></tr></table></figure><p>对于画面中移动的 <code>node</code> ，当移出画面后我们可以进行重复利用，这里可以引入 <code>NodePool</code> ，出画面后加入节点池，需要的时候再从里边拿。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.pool = <span class="keyword">new</span> cc.NodePool();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 放入节点池</span></span><br><span class="line"><span class="keyword">this</span>.pool.put(star);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要的时候从里边拿</span></span><br><span class="line"><span class="keyword">const</span> newStar = <span class="keyword">this</span>.pool.get();</span><br></pre></td></tr></table></figure><p>通过节点池我们可以节省内存的开销。</p><h1 id="Node-和-组件"><a href="#Node-和-组件" class="headerlink" title="Node 和 组件"></a>Node 和 组件</h1><p><code>Node</code> 和组件的关系最开始的时候有点懵逼，慢慢的调试后大致了解了，下边讲一下我的理解。</p><p>在定义 <code>properties</code> 的时候我们需要定义对象的属性，它可以是 <code>type: cc.Node,</code> ，也可以是自带的组件类型 <code>type: cc.Label</code> ，也可以是我们定义的脚本组件类型，可以先将编写的脚本代码引入 <code>const Bird = require(&quot;Bird&quot;);</code> ，然后将其作为一种类型  <code>type: Bird</code>。</p><p>一个节点属于复合类型，它既是本身的 <code>cc.Node</code> 类型，如果添加了相应的组件，它也是相应的组件类型。</p><p>以下图为例，它既是 <code>cc.Node</code> 类型，也是 <code>cc.Label</code> 类型，还是 <code>test</code> 类型。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113174535576.png" alt="image-20221113174535576"></p><p>下边以动态修改 <code>Label</code> 的值，讲一下 <code>Node</code> 和组件之间的关系。</p><p>首先新建一个 <code>canvas</code> 的脚本组件 <code>game.js</code> ，将该组件挂载到 <code>canvas</code> 节点中。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113182122357.png" alt="image-20221113182122357"></p><p><code>game.js</code> 中添加一个 <code>label</code> 属性，类型为 <code>cc.Node</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Node,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>选中 <code>Canvas</code> 节点，将 <code>FirstLabel</code> 节点拖动添加的属性中。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113174930670.png" alt="image-20221113174930670"></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113175131343.png" alt="image-20221113175131343"></p><p>虽然 <code>firstLabel</code> 属于三种类型，但因为我们定义的类型是 <code>cc.Node</code> ，因此拿到的是一个 <code>Node</code> 对象，我们打印看一下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onLoad() &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113175207934.png" alt="image-20221113175207934"></p><p>如果想要在运行的时候改变当前节点的位置，调用 <code>setPositon</code> 即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Node,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.setPosition(cc.v2(<span class="number">0</span>, <span class="number">-200</span>));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>如果我们想改变组件的文案，我们需要先通过 <code>getComponent</code> 拿到 <code>Label</code> 组件的实例对象，然后更新 <code>string</code> 属性即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onLoad() &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">       <span class="keyword">this</span>.label.setPosition(cc.v2(<span class="number">0</span>, <span class="number">-200</span>));</span><br><span class="line">       <span class="keyword">this</span>.label.getComponent(cc.Label).string = <span class="string">"我改变了"</span>;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><p>初值设置的是 <code>设置文案</code>。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113175852560.png" alt="image-20221113175852560"></p><p>运行起来会发现是我们在 <code>onLoad</code> 中设置的值。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113180058709.png" alt="image-20221113180058709"></p><p>当然，我们也可以在开始的时候将组件类型设置为 <code>cc.Label</code> ，这样我们开始拿到的就是 <code>Label</code> 实例对象，就不需要再通过 <code>getComponent</code>  方法了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Label,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.string = <span class="string">"我改变了"</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>改为代码后我们重新拖动，更新下属性的值。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113180445655.png" alt="image-20221113180445655"></p><p>那么如果我们想改变 <code>node</code> 位置该怎么办呢？</p><p>获得的组件实例中有一个 <code>node</code> 属性，我们可以直接拿到当前的 <code>node</code> 对象实例，然后继续调用 <code>setPosition</code> 就可以了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Label,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.string = <span class="string">"我改变了"</span>;</span><br><span class="line">        <span class="keyword">this</span>.label.node.setPosition(cc.v2(<span class="number">0</span>, <span class="number">-300</span>));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>为了更深刻的理解，我们再绕一下，实现通过当前节点的 <code>Node</code> ，调用自定义脚本组件的方法，来动态修改 <code>Label</code> 的值。</p><p>首先编写自定义组件的代码，提供一个方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.js</span></span><br><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// LIFE-CYCLE CALLBACKS:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// onLoad () &#123;&#125;,</span></span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    setLabelValue() &#123;</span><br><span class="line">        <span class="keyword">this</span>.getComponent(cc.Label).string = <span class="string">"我被 test 改变了"</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>当前脚本添加到相应的属性中。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113181717593.png" alt="image-20221113181717593"></p><p>接着我们只需要在 <code>canvas</code> 的脚本组件中调用 <code>getComponent(&quot;test&quot;)</code> 拿到上边的脚本对象实例，调用 <code>setLabelValue</code> 方法即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Node,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.getComponent(<span class="string">"test"</span>).setLabelValue();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>小结一下，使用对象的时候，我们需要明确当前是 <code>cc.Node</code> 类型，还是某种组件类型，每一个种类型都有自己的方法。</p><p>如果想从 <code>cc.Node</code> 对象中拿到相应的组件，调用 <code>getComponent</code> 方法即可。</p><p>如果想从组件中拿到 <code>cc.Node</code> 类型，不管是自带的组件，还是自定义的脚本组件，可以直接通过 <code>this.node</code> 拿到当前的 <code>node</code> 实例对象。</p><h1 id="显示隐藏"><a href="#显示隐藏" class="headerlink" title="显示隐藏"></a>显示隐藏</h1><p>最直接就是设置 <code>node</code> 对象的 <code>active</code> 属性即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Node,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.active = <span class="literal">false</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上边的方式类似于 <code>vue</code> 的 <code>v-if</code> ，会直接把节点销毁掉。</p><p>如果想保留节点，实现 <code>vue</code> 的 <code>v-show</code> ，我们可以设置 <code>opacity</code> 透明度属性弯道实现，只需要将值设置为 <code>0</code> 实现隐藏。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cc.Class(&#123;</span><br><span class="line">    extends: cc.Component,</span><br><span class="line"></span><br><span class="line">    properties: &#123;</span><br><span class="line">        label: &#123;</span><br><span class="line">            <span class="keyword">default</span>: <span class="literal">null</span>,</span><br><span class="line">            type: cc.Node,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    onLoad() &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.label);</span><br><span class="line">        <span class="keyword">this</span>.label.opacity = <span class="number">0</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    start() &#123;&#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update (dt) &#123;&#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>这里需要注意的是，虽然通过透明度可以隐藏组件，但是此时的点击事件还是存在的，需要处理一下。</p><h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><p>编译的时候我们选择微信小游戏，填写 <code>appId</code> ，编译完成后通过微信开发者工具导入 <code>build</code> 出来的文件就可以了。</p><p>菜单 -&gt;项目 -&gt; 构建发布：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113183809044.png" alt="image-20221113183809044"></p><p>我们可以设置初始场景、设备方向等。</p><p>需要注意的是，微信主包有 <code>2M</code> 大小的限制，如果预览的微信小游戏遇到超包的情况，我们可以将没用到的组件在编译设置中去除。</p><p>菜单 -&gt; 项目 -&gt; 项目设置 -&gt; 模块设置：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113184029466.png" alt="image-20221113184029466"></p><h1 id="微信小游戏排行榜"><a href="#微信小游戏排行榜" class="headerlink" title="微信小游戏排行榜"></a>微信小游戏排行榜</h1><p>微信为了防止好友的关系链泄露，提出了一个子域的概念，在子域中可以调用 <code>wx.getFriendCloudStorage</code> 方法拿到好友数据。</p><p>为了实现排行榜，我们需要再创建一个空项目，实现排行榜的显示逻辑，和正常项目开发是一致的。</p><p>添加 <code>message</code> 回调函数，供主项目调用。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private onMessage(msg: any) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.event) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"setScore"</span>:</span><br><span class="line">                <span class="keyword">this</span>.setScore(msg.score);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"showRank"</span>:</span><br><span class="line">                <span class="keyword">this</span>.getRank();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>编译的时候需要选择 <code>微信小游戏开发数据域</code>，名称自己定义，我写的是<code>wxSubContext</code>，路径选择之前项目编译的文件夹。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113184927037.png" alt="image-20221113184927037"></p><p>然后在主项目中我们需要添加一个空节点，并且添加一个 <code>SubContextView</code> 组件，将这个节点作为排行榜项目的容器节点。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113184416196.png" alt="image-20221113184416196"></p><p>如果想要调用排行榜的方法通过 <code>postMessage</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.postMessage(&#123;</span><br><span class="line">  event: <span class="string">"showRank"</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>编译的时候指定一下排行榜项目之前设置的名称 <code>wxSubContext</code>    。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221113184628466.png" alt="image-20221113184628466"></p><p>上边就是实现排行榜的整个逻辑了，详细的可以参考 <a href="https://developers.weixin.qq.com/community/minigame/article/doc/00028ce147c270ac955a031b057813" target="_blank" rel="noopener">这篇文章</a>，相应的 <a href="https://gitee.com/ichenpipi/cocos-case-wxsubcontext" target="_blank" rel="noopener">代码仓库</a>，<code>clone</code> 下来可以直接用。这个项目的 <code>cocos</code> 编辑器是 <code>2.3.3</code> ，如果升级到 <code>2.4.5</code> 会出现无法滚动的情况，谨慎升级。</p><p>需要注意的一点是，当子项目的容器节点显示的时候，子项目才开始初始化，这就会导致主项目 <code>postMessage</code> 先调用，排行榜项目的<code>onMessage</code> 后调用，导致错失了消息。</p><p>解决这个问题的话，我们的显藏可以通过设置透明度的方式实现，让子项目提前加载。</p><h1 id="发布到微信"><a href="#发布到微信" class="headerlink" title="发布到微信"></a>发布到微信</h1><p>个人开发者提交的资料基本不用啥，有个自审资料网上找个模版在 <code>word</code> 填完截图就可以。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/%E8%87%AA%E6%9F%A5.jpg" alt="自查"></p><p>但提交审核的道路比较坎坷，除了慢以外，甚至被拒了两次。</p><p>第一次周日提交，周三还没有结果在微信社区平台催了一下审核，下午收到结果审核失败。</p><blockquote><p>小游戏涉嫌侵权，请参考示例截图标记点全面自查游戏内容，请于下个版本有效整改或举证，在微信公众平台-版本管理-提交审核-授权书/版本更新说明提交，包括但不限于游戏内容说明及对应截图、原创证明或有效授权书 主体信用分扣除-3分</p></blockquote><p>原因是一开始是准备仿 <code>Flappy bird</code> 的，直接用了相应的素材，就被驳回了，客服截图如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221119103132834.png" alt="image-20221119103132834"></p><p>第二次周三早上提交，周五晚上收到结果，又被拒了，这次就无法理解了：</p><blockquote><p>开发者你好，经平台审核，你的小游戏《挑战1024》未通过审核，具体原因如下：</p><p>1、小游戏需具有完整的游戏玩法，不能为简单的素材堆砌</p></blockquote><p>网上搜了搜，可能是因为我的游戏只有一个界面，点击就开始了。据说加个菜单就会好，于是又改了改，不同场景也换了换背景。</p><p>第三次周六晚上提交，周二晚上收到结果，同上次，审核被拒，原因为「小游戏需具有完整的游戏玩法，不能为简单的素材堆砌」。</p><p>已经不知道该怎么改了，周三早上点了审核失败那里的提交反馈，写了一段感人肺腑的话（* 的内容这里就省略了）。</p><blockquote><p>本游戏为益智类游戏，需要分数吃到 1024 才能获得胜利。<br>游戏场景分为菜单、第一关、最终关、好友排行，不同关卡也会通过背景色来区分。<br>菜单提供了分享好友、查看排行的功能。<br>第一关主要是为了体验游戏流程，星星的分数都是×2，因此只需要不停的吃分即可取得胜利。<br>最终关需要通过自己的策略，除了躲避陨石，还需要吃到星星上不同的分数，才能获得胜利。<br>游戏过程中，星星的速度、分数的出现会实时通过当前的状态进行变化，主要涉及到一些算法，也是本游戏的核心。<br>虽然素材都是星星，但结合算法上边的分数会一直变化，同时星星和陨石的比例也在不断变化。<br>除此之外玩家还需要躲避陨石，同时设定了策略，如果******。<br>在用户挑战失败的时候，增设了复活功能、重开功能。<br>游戏名为「挑战1024」，属于*******，来最终取得胜利。<br>希望审核大大可以再看一下，设计整个流程和算法确实花了很多心思。</p></blockquote><p>周四早上显示反馈成功。</p><blockquote><p>开发者你好，感谢你向小游戏审核团队反馈异议，经平台评估：我们已更正你的历史审核记录，如有需求，可重新提交审核</p></blockquote><p>周五早上进行了重新提审，周二下午终于通过了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/image-20221130083045661.png" alt="image-20221130083045661"></p><p>小游戏相比于小程序审核严格好多，前前后后花了有半个多月了，简单游戏竟然不让上线，这是我想不通的。</p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>整体就是这样了，整个 <code>cocos</code> 项目可以理解为一棵树，整个树就是一个场景，根节点是一个包含 <code>Canvas</code> 组件的 <code>node</code> ，接下来可以创建自己的 <code>node</code> ，每个 <code>node</code> 又可以挂载想要的自带组件和用户脚本组件。</p><p>希望对大家有帮助，如果错误也欢迎指出，也可以体验一下我这次开发的小游戏，哈哈：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/gh_dc7db84e6a20_258.jpg" alt="gh_dc7db84e6a20_258"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前段时间一直在更 &lt;a href=&quot;https://vue.windliang.wang/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;vue2的源码系列&lt;/a&gt;，最近换了换口味，学了一下 &lt;code&gt;cocos&lt;/code&gt; ，照猫画虎的写了一个「挑战
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="cocos" scheme="https://windliang.wang/tags/cocos/"/>
    
  </entry>
  
  <entry>
    <title>中后台系统提升质量和效率的一个思路</title>
    <link href="https://windliang.wang/2022/10/27/%E4%B8%AD%E5%90%8E%E5%8F%B0%E7%B3%BB%E7%BB%9F%E6%8F%90%E5%8D%87%E8%B4%A8%E9%87%8F%E5%92%8C%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%B8%AA%E6%80%9D%E8%B7%AF/"/>
    <id>https://windliang.wang/2022/10/27/%E4%B8%AD%E5%90%8E%E5%8F%B0%E7%B3%BB%E7%BB%9F%E6%8F%90%E5%8D%87%E8%B4%A8%E9%87%8F%E5%92%8C%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%B8%AA%E6%80%9D%E8%B7%AF/</id>
    <published>2022-10-26T22:04:20.000Z</published>
    <updated>2022-11-17T00:01:23.938Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>中后台项目中会存在一些配置页面需求的开发，这些需求高度相似，迭代频率低，基本结构为「搜索区域」、「表格区域」、「包含表单的弹窗」三部分组成。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060647741.png" alt="image-20221027060647741"></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060711024.png" alt="image-20221027060711024"></p><p>其中「搜索区域」和「表格区域」的操作区交互固化，比如查询、添加、查看、删除、上线、下线。</p><p>当前开发时大都采用复制类似需求页面继而修改的方式，如下图所示。每个人都形成了自己的代码组织结构，导致虽属同一团队，但代码风格、交互实现逻辑变为了多条平行线。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060727389.png" alt="image-20221027060727389"></p><p>这种迭代方式存在两点坏处：</p><p>a. 重复劳动较多，同时存在漏改的风险。易变的地方分布在页面中各个部分，修改起来不够方便，改动后存在影响到正常逻辑的风险。</p><p>b. 团队内各自抽离的不同交互方式，接手他人页面的时候需要耗费一定的理解成本，同时 <code>code review</code> 时无法快速的理清逻辑。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>中后台项目提效一个直接的想法就是低代码的思路：</p><p>a. 初态：抽离各个组件，定义 <code>json</code> 的格式，通过 <code>json</code> 渲染出页面。</p><p>b. 终态：开发搭建平台，通过拖拽生成 <code>json</code> 并且实时预览页面，开发者也可以通过预定的协议接入自己的组件。</p><p>上述两种方案除去搭建成本大之外，最大的问题就是业务开发灵活性将大大降低。</p><p>开发者将在新的规范下进行开发，不管是通过 <code>json</code> 配置还是配置平台生成页面，上手难度大大增加，不亚于去学习一个新的前端框架。如果新需求的交互框架没有考虑到，将花费大量的时间进行适配， 甚至超过了从零开发需求的时间。极端情况下，如果无法满足需求的交互，还存在推倒重来的风险。</p><p>基于以上考虑，我们采取一个更轻便的方案，以模版代码为基础进行后续开发，并通过脚手架进行模版的配置、拉取。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060745695.png" alt="image-20221027060745695"></p><p>如上图，大家的开发流程从之前的平行线变为了网状，未来的页面的目录格式和交互方式都会统一。</p><p>由于是生成的模版代码页面而且不强依赖于模版，未来需求有大的变化也可以正常迭代。</p><h1 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h1><h2 id="1-模板设计"><a href="#1-模板设计" class="headerlink" title="1.模板设计"></a>1.模板设计</h2><p>考虑到今后有可能增加其他场景模版，设计模版要考虑到未来可以进行无缝扩展，有两种方案：</p><p>a. 按分支来保存不同场景下的模版：</p><p>优点：不同场景下通过分支来拉取不同模版，模版之间完全隔离。</p><p>缺点：缺少了 <code>master</code> 分支，各模版都需要自己的 <code>master</code> 分支进行迭代。分支之间差异较大，完全违背了 <code>git</code> 的迭代初心。</p><p>b. 按文件夹来保存不同场景下的模版：</p><p>优点：所有模版都存在于 <code>master</code> 分支，和普通项目的方式一样从 <code>master</code> 切出分支进行迭代。</p><p>缺点：脚手架需要一次性拉取所有模版，然后复制自己需要的模版。</p><p>考虑到拉取文件速度较快，最终选取了方案 <code>b</code>。</p><p>各个配置页面之间虽然相似，但也会因实际情况存在细微差异，所以模版不能完全写死，需要支持动态编译，这里采用 <code>EJS</code> 进行编译。</p><p><code>EJS</code> 是一套简单的模板语言，它没有再造一套迭代和控制流语法，只需正常的 <code>JavaScript</code> 语法即可实现一些条件编译、变量替换等，因此可以快速上手。</p><p>关于模版内容，核心思想是将<strong>变化与不变的内容进行抽离</strong>。</p><p>我们可以将后端的接口、权限的配置、搜索框的配置、常量抽离出配置文件，将表格、搜索框、表单之间的联动方式预先写好，目录格式如下。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060919512.png" alt="image-20221027060919512"></p><p>开发者只需进行后端接口的配置、搜索框的配置、表单的开发即可快速完成整个需求。</p><h2 id="2-架构设计"><a href="#2-架构设计" class="headerlink" title="2. 架构设计"></a>2. 架构设计</h2><p>考虑到一方面脚手架整体架构和功能实现后迭代频率会逐渐降低，另一方面更新脚手架需要走 <code>npm</code> 包的发布流程，如果将模版内容耦合到脚手架中，每次更新都重新进行发包较为繁琐。</p><p>因此将模版单独放一个仓库，从脚手架中解耦出来，实现脚手架仓库和模版仓库分离，独立迭代，降低更新成本。</p><p>使用者通过输入命令和参数即可生成模版页面代码，脚手架内部实现拉取模版和编译，生成最终页面，架构如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060851382.png" alt="image-20221027060851382"></p><h2 id="3-脚手架实现"><a href="#3-脚手架实现" class="headerlink" title="3. 脚手架实现"></a>3. 脚手架实现</h2><p>提供 <code>ce-cli</code> 命令，结合用户的参数进行进行模版的编译生成，同时提供交互式的形式选择参数，降低使用者的上手难度，交互形式如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20221027060958575.png" alt="image-20221027060958575"></p><p>考虑到模版和脚手架存在强绑定关系，即如果模版更新了，但脚手架没有更新会造成一些模版逻辑未被编译的情况。因此执行命令时需要检查脚手架是否为最新版本，如果版本较低必须强制升级，中断程序的执行。（对于团队内部工具来说，始终保持最新版本才可以及时用到最新功能，这也是强制升级的原因之一）</p><p>为提高命令的执行速度，执行命令时将拉取的模版缓存到本地，并且将最新的 <code>commit</code> 名保存起来。第二次执行命令的时候将目前最新的 <code>commit</code> 和此前保存的 <code>commit</code> 进行比对，如果不相等则覆盖原来的模版，否则使用原来的模版即可，减少一次网络请求耗时。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>经过一段时间的迭代，后续有近 <code>20</code> 个页面用到脚手架，每需求可降低 <code>0.5pd</code> 的时间，更重要的是团队内相关需求的代码结构、交互实现均已统一，提升了代码质量 和 <code>code review</code> 的效率，团队间交替开发需求时的代码认知难度将大大降低。</p><p>在 <code>code review</code> 过程中，团队内提供相关建议，<a href="https://zhuanlan.zhihu.com/p/561275198" target="_blank" rel="noopener">沉淀最佳实践</a>，例如默认对象通过函数返回、公共方法的使用、项目框架一些特有操作都内置到模版中，不断提升代码质量，磨平大家之间的认知差异。</p><p>未来有新同学加入，可以在模版的基础上更快的进入开发，极大的降低对系统框架一些特有操作的认知时间，同时保证代码质量。</p><p>脚手架中的模版对主要对表格和搜索区域固化了代码逻辑，对于表单的使用我们还是通过原始的 <code>element</code> 表单进行开发，一些常用的规则校验、表单的逻辑每次都需要重复进行开发，经过调研目前公司内已经有多种封装好的表单，未来可以进行详细了解，最终引进到模版代码中，进一步提升开发效率。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;中后台项目中会存在一些配置页面需求的开发，这些需求高度相似，迭代频率低，基本结构为「搜索区域」、「表格区域」、「包含表单的弹窗」三部分组成。
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端" scheme="https://windliang.wang/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>前端老项目接入eslint从配置到上线的一些思考</title>
    <link href="https://windliang.wang/2022/09/21/%E5%89%8D%E7%AB%AF%E8%80%81%E9%A1%B9%E7%9B%AE%E6%8E%A5%E5%85%A5eslint%E5%85%A8%E8%BF%87%E7%A8%8B/"/>
    <id>https://windliang.wang/2022/09/21/%E5%89%8D%E7%AB%AF%E8%80%81%E9%A1%B9%E7%9B%AE%E6%8E%A5%E5%85%A5eslint%E5%85%A8%E8%BF%87%E7%A8%8B/</id>
    <published>2022-09-21T00:42:15.000Z</published>
    <updated>2022-11-17T00:01:23.942Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在日常需求迭代中，代码的规范与质量是编码的重要一环。<code>Eslint</code> 作为规则扫描器，能够对前端代码进行有效管控，避免出现低级错误，对于前端项目或多或少肯定都会看到 <code>eslint</code> 的相关配置。</p><p>但目前存在一些老项目， <code>eslint</code> 的配置仅仅停留在了多年前加的一些 <code>eslint</code> 规则上，没有任何其他动作，导致平常开发中有如下痛点：</p><ol><li>本地不方便开启保存自动格式化，因为对于老页面，如果开启的话会造成大量的无关 <code>diff</code>。</li><li>提交代码的时候会受到莫名其妙的卡控。</li><li>过 <code>pr</code> 的时候分号、空格、换行各个地方不对齐，逼死强迫症系列。</li></ol><p>基于此，前段时间对老项目的 <code>eslint</code> 进行了一次完善，分享一下整个配置和思考的过程。</p><h1 id="选取规则"><a href="#选取规则" class="headerlink" title="选取规则"></a>选取规则</h1><h2 id="eslint"><a href="#eslint" class="headerlink" title="eslint"></a>eslint</h2><p><code>eslint</code> 规则可以单独一条条配置，也有一些规则的集合比如官方推荐的 <code>eslint:recommended</code>，框架相关的 <a href="https://eslint.vuejs.org/user-guide/#installation" target="_blank" rel="noopener">plugin:vue/recommended</a>，还有公司开源出来的整套规则比如 <code>Airbnb</code> 的 <a href="https://github.com/airbnb/javascript/tree/master/packages/eslint-config-airbnb" target="_blank" rel="noopener">eslint-config-airbnb</a>，腾讯的 <a href="https://github.com/AlloyTeam/eslint-config-alloy" target="_blank" rel="noopener">eslint-config-alloy</a>。</p><p>选取什么规则不是非常重要，大部分规则集也是类似的，此外本地也可以定义相同的规则名对规则集进行覆盖。</p><p>以 <code>alloy</code> 的规则为例，按照 <a href="https://github.com/AlloyTeam/eslint-config-alloy" target="_blank" rel="noopener">eslint-config-alloy</a> 中的文档安装完相应的 <code>node</code> 包以后，在本地根目录中新建 <code>.eslintrc.js</code> 文件引入相应的规则。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    extends: [<span class="string">'alloy'</span>, <span class="string">'alloy/vue'</span>],</span><br><span class="line">    env: &#123;</span><br><span class="line">        <span class="comment">// 你的环境变量（包含多个预定义的全局变量）</span></span><br><span class="line">    &#125;,</span><br><span class="line">    globals: &#123;</span><br><span class="line">        <span class="comment">// 全局变量</span></span><br><span class="line">        moment: <span class="string">'readonly'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    rules: &#123;</span><br><span class="line">        <span class="comment">// 自定义你的规则 0-关闭，1-warn，2-error</span></span><br><span class="line">        <span class="string">'vue/component-tags-order'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'vue/no-deprecated-slot-attribute'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'vue/no-deprecated-slot-scope-attribute'</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">'vue/no-duplicate-attributes'</span>: [</span><br><span class="line">            <span class="string">'error'</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                allowCoexistClass: <span class="literal">true</span>,</span><br><span class="line">                allowCoexistStyle: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'no-param-reassign'</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">'no-console'</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">'no-magic-numbers'</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">'default-case'</span>: <span class="number">2</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如上所示，我们可以在 <code>rules</code> 中定义或者覆盖一些规则。</p><h2 id="Prettier"><a href="#Prettier" class="headerlink" title="Prettier"></a>Prettier</h2><p><code>Prettier</code> 是一个代码格式化工具，相比于 <code>eslint</code> 中的代码格式规则，它提供了更少的选项，却更加专业。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220923090302423.png" alt="image-20220923090302423"></p><p>相比于 <code>eslint</code>， <code>Prettier</code>  主要格式样式相关的，比如有没有分号、空格数、一行最大字符数等等，而 <code>eslint</code> 通过解析出代码的 <code>AST</code> ，可以自动格式化或者检测出一些潜在的问题，比如是否允许使用 <code>console</code>、变量声明但未使用、<code>switch</code> 缺少 <code>defaut</code> 等。</p><p>当然 <code>eslint</code> 也可以配置样式相关的规则，但存在一些情况 <code>eslint</code> 无法胜任，因此格式化相关的我们都交给更专业的 <code>Prettier</code> ，安装 <code>Prettier</code> 的 <code>node</code> 包，并且根目录增加配置文件 <code>.prettierrc.js</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .prettierrc.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">// 一行最多 120 字符</span></span><br><span class="line">    printWidth: <span class="number">120</span>,</span><br><span class="line">    <span class="comment">// 使用 4 个空格缩进</span></span><br><span class="line">    tabWidth: <span class="number">4</span>,</span><br><span class="line">    <span class="comment">// 不使用缩进符，而使用空格</span></span><br><span class="line">    useTabs: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 行尾需要有分号</span></span><br><span class="line">    semi: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 使用单引号</span></span><br><span class="line">    singleQuote: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 对象的 key 仅在必要时用引号</span></span><br><span class="line">    quoteProps: <span class="string">'as-needed'</span>,</span><br><span class="line">    <span class="comment">// jsx 不使用单引号，而使用双引号</span></span><br><span class="line">    jsxSingleQuote: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 末尾需要有逗号</span></span><br><span class="line">    trailingComma: <span class="string">'all'</span>,</span><br><span class="line">    <span class="comment">// 大括号内的首尾需要空格</span></span><br><span class="line">    bracketSpacing: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// jsx 标签的反尖括号需要换行</span></span><br><span class="line">    bracketSameLine: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 箭头函数，只有一个参数的时候，也需要括号</span></span><br><span class="line">    arrowParens: <span class="string">'always'</span>,</span><br><span class="line">    <span class="comment">// 每个文件格式化的范围是文件的全部内容</span></span><br><span class="line">    rangeStart: <span class="number">0</span>,</span><br><span class="line">    rangeEnd: <span class="literal">Infinity</span>,</span><br><span class="line">    <span class="comment">// 不需要写文件开头的 @prettier</span></span><br><span class="line">    requirePragma: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 不需要自动在文件开头插入 @prettier</span></span><br><span class="line">    insertPragma: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 使用默认的折行标准</span></span><br><span class="line">    proseWrap: <span class="string">'preserve'</span>,</span><br><span class="line">    <span class="comment">// 根据显示样式决定 html 要不要折行</span></span><br><span class="line">    htmlWhitespaceSensitivity: <span class="string">'css'</span>,</span><br><span class="line">    <span class="comment">// vue 文件中的 script 和 style 内不用缩进</span></span><br><span class="line">    vueIndentScriptAndStyle: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// 换行符使用 lf</span></span><br><span class="line">    endOfLine: <span class="string">'lf'</span>,</span><br><span class="line">    <span class="comment">// 格式化内嵌代码</span></span><br><span class="line">    embeddedLanguageFormatting: <span class="string">'auto'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="编辑器自动修复"><a href="#编辑器自动修复" class="headerlink" title="编辑器自动修复"></a>编辑器自动修复</h1><p><strong>这一步我认为是推动 <code>eslint</code> 最重要的一步</strong>，大家抗拒项目添加 <code>eslint</code> 一个很大的原因就是本地没有开启实时检查和自动修复，当提交 <code>commit</code> 的时候遇到 <code>eslint</code> 规则卡控就很难受了。</p><p>团队内都使用的 <code>VSCode</code> 进行开发，可以安装 <code>Eslint</code> 和 <code>Prettier</code> 插件。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220925113210716.png" alt="image-20220925113210716"></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220925113256543.png" alt="image-20220925113256543"></p><p>在本地新增 <code>.vscode/settings.json</code> 文件进行插件的配置，并且该文件不忽略 <code>git</code> ，所有人共享。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"editor.defaultFormatter"</span>: <span class="string">"esbenp.prettier-vscode"</span>, <span class="comment">// 用 Prettier 格式化</span></span><br><span class="line">    <span class="string">"editor.codeActionsOnSave"</span>: &#123;</span><br><span class="line">        <span class="string">"source.fixAll.eslint"</span>: <span class="literal">true</span> <span class="comment">// 保存时自动进行 eslint 的修复</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"editor.formatOnSave"</span>: <span class="literal">true</span> <span class="comment">// 保存时自动格式化</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个文件是 <code>VSCode</code> 针对当前工程的配置，配置后保存文件的时候插件会自动帮助我们格式化，同时有实时的错误提示。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comKapture%202022-09-25%20at%2015.41.13.gif" alt="Kapture 2022-09-25 at 15.41.13"></p><p>这里需要注意的一点是，保存的时候会同时进行 <code>prettier</code> 和 <code>eslint</code> 的修复，如果 <code>eslint</code> 也配置了样式相关的规则，此时可能发生冲突，导致自动格式化后会有 <code>eslint</code> 的报错，此时可以将相应的 <code>eslint</code> 规则手动关闭，也可以引入 <a href="https://github.com/prettier/eslint-config-prettier" target="_blank" rel="noopener">eslint-config-prettier</a> 这个规则集批量关闭。</p><h1 id="commit-卡控"><a href="#commit-卡控" class="headerlink" title="commit 卡控"></a>commit 卡控</h1><p>为了保证 <code>eslint</code> 规则的有效，需要在提交 <code>commit</code> 的时候进行检查，如果存在没有修复的 <code>eslint</code> 问题直接终止提交。</p><p>直接使用 <code>&quot;husky&quot;: &quot;^1.3.1&quot;</code> 和 <code>&quot;lint-staged&quot;: &quot;^8.1.5&quot;</code>  两个 <code>node</code> 包，需要注意下版本号，最新的配置有些不同了，下边是该版本下的配置。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"husky"</span>: &#123;</span><br><span class="line">  <span class="string">"hooks"</span>: &#123;</span><br><span class="line">    <span class="string">"pre-commit"</span>: <span class="string">"lint-staged"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">  <span class="string">"lint-staged"</span>: &#123;</span><br><span class="line">    <span class="string">"linters"</span>: &#123;</span><br><span class="line">      <span class="string">"src/**/*.&#123;js,vue&#125;"</span>: [</span><br><span class="line">        <span class="string">"eslint --fix"</span>,</span><br><span class="line">        <span class="string">"git add"</span></span><br><span class="line">      ],</span><br><span class="line">        <span class="string">"src/**/*.&#123;js,vue,html,css,scss,sass&#125;"</span>: [</span><br><span class="line">          <span class="string">"prettier --write"</span>,</span><br><span class="line">          <span class="string">"git add"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p><code>husky</code> 提供了 <code>pre-commit</code> 的钩子，然后 <code>lint-staged</code> 对暂存区代码自动进行格式化，如果出错的话会直接退出。</p><p>这样当我们提交 <code>commit</code> 的时候就会运行 <code>eslint</code> 和 <code>prettier</code> 进行代码的格式化。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220925162909689.png" alt="image-20220925162909689"></p><h1 id="流水线卡控"><a href="#流水线卡控" class="headerlink" title="流水线卡控"></a>流水线卡控</h1><p>虽然上一步对 <code>commit</code> 进行了卡控，但如果 <code>git commit</code> 的时候添加了 <code>-n</code> 参数，卡控检查也就直接跳过了。</p><p>如果想彻底的卡控，我们可以在打包流水线上增加一个 <code>lint</code> 的插件进行检查。</p><p>这里实现卡控有两种思路：</p><ol><li><p>发布分支和 <code>master</code> 做 <code>diff</code>，仅仅对 <code>diff</code> 出的 <code>commit</code> 进行 <code>eslint</code> 的检查。</p><p>但这里可能存在两个问题需要注意：</p><p>如果本地合并 <code>master</code> 的时候产生了冲突，然后解决冲突会新提交一个 <code>commit</code> 。 此时 <code>diff</code> 出来的 <code>commit</code> 可能会包含其他人的代码，如果之前的代码没有 <code>lint</code> ，此时就需要自己 <code>lint</code> 了。</p><p>如果上线流程是先合并 <code>master</code> ，那么上线的时候 <code>master</code> 已经有了自己的代码，此时上线分支和 <code>master</code> 就没有任何 <code>diff</code> 了，所以也就起不到卡控的作用了。</p></li><li><p>卡控分支前 <code>n</code> 天的 <code>commit</code> 。</p><p>理想情况下，前 <code>n</code> 天只包含自己的 <code>commit</code> 和已经 <code>lint</code> 过的 <code>commit</code> ， <code>merge master</code> 的 <code>commit</code> 可以自动过滤掉，因此可以很好的对新加的代码进行卡控。</p><p>当然还是无法完全避免遇到别人没有 <code>lint</code> 过的代码，此时还是需要自己进行修复了。</p><p>具体逻辑可以参考这个 <a href="https://github.com/wyntau/lint-recently#readme" target="_blank" rel="noopener">node 包</a>。</p></li></ol><p>不管是哪种方法，因为是在老项目引入的 <code>lint</code> ，前期如果在流水线加 <code>lint</code> 卡控的话一定会遇到明明不是自己代码，却被 <code>lint</code> 卡控拦截的情况。</p><p>我个人看法是流水线 <code>lint</code> 其实不加也可以，如果编辑器自动修复添加了、<code>commit</code> 卡控也添加了，这已经足够了，如果真有人通过 <code>-n</code> 绕过卡控，那肯定是有理由的，也没必要走流水线再卡控。</p><h1 id="上线"><a href="#上线" class="headerlink" title="上线"></a>上线</h1><p>因为老项目中会有大量的不符合 <code>eslint</code> 规则的代码，因此上线有两种方案。</p><ol><li><p>本地进行全量文件的 <code>eslint --fix</code> 后上线：</p><p>优点：未来开发时原有文件的 <code>lint</code> 问题不用关心，开发者只需关注原有 <code>error</code> 和自己当前的 <code>lint</code> 问题即可。</p><p>缺点：由于改动文件数较多，<code>eslint</code> 不可完全信任，贸然上线可能会造成线上问题。</p></li><li><p>仅仅上线 <code>eslint</code> 的卡控和保存时自动 <code>lint</code> 的配置：</p><p>优点：未改动代码逻辑，不会存在引发线上问题的隐患。</p><p>缺点：当开发者修改、保存老文件后，会自动触发 <code>lint</code> 修复，从而污染混淆本身的修改，增加后续 <code>code review</code> 工作负担。</p></li></ol><p>我是偏向于第 <code>2</code> 个方案的，虽然 <code>eslint</code> 自动修复一般不会引起问题，但程序肯定是不能 <code>100%</code> 相信的，如果造成了线上问题反而得不偿失。</p><p>如果采用第 <code>2</code> 个方案，后续开发老页面保存的时候一定会出现大面积的自动 <code>lint</code>，我们可以在添加新代码前先保存一下触发 <code>lint</code> 并且提交一个 <code>msg</code> 为 <code>lint auto fix</code> 的  <code>commit</code> 。这样做有两个好处：</p><ol><li>后续其他人遇到问题代码排查的时候看到 <code>lint fix</code> 就知道了这行代码不是你写的，他需要再往前找一个 <code>commit</code> 的提交人。</li><li>过 <code>pr</code> 的时候我们可以按 <code>commit</code> 看，第一个 <code>lint</code> 的 <code>commit</code> 如果没什么问题可以直接跳过，减轻 <code>cr</code> 的负担。</li></ol><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>在业务迭代繁忙的时候，想在老项目中引入 <code>eslint</code> 其实还挺难的，毕竟业务价值很难讲清楚，一个反向逻辑就是现在项目没有 <code>eslint</code> 也运行的好好的，但加入 <code>eslint</code> 有什么收益呢？</p><p>另一方面，当有人推动项目 <code>eslint</code> 的规则的时候仅仅添加规则和卡控，其他的步骤不去推动，当越来越多人遇到需要手动修复 <code>eslint</code> 或者因为 <code>eslint</code> 的问题被卡控提交，内心就会不断地增加对 <code>eslint</code> 的抗拒。</p><p>在安装相关插件、<code>node</code> 包的时候<strong>需要注意下版本号</strong>，找到匹配自己包的版本号的配置，不然可能会遇到配置了但不生效的问题。</p><p>当有新项目开发的时候，一定要把 <code>eslint</code> 的自动修复、相关配置都搞好，这样开发的时候也舒服，未来也不用再进行 <code>eslint</code> 的治理了。</p><p>未来也可以结合平时开发的经验和发生的线上问题，逐步完善 <code>eslint</code> 中的 <code>rules</code> 规则，使得项目代码质量越来越高。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;在日常需求迭代中，代码的规范与质量是编码的重要一环。&lt;code&gt;Eslint&lt;/code&gt; 作为规则扫描器，能够对前端代码进行有效管控，避免
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="eslint" scheme="https://windliang.wang/tags/eslint/"/>
    
  </entry>
  
  <entry>
    <title>提升前端开发质量的十点经验沉淀</title>
    <link href="https://windliang.wang/2022/09/05/%E5%89%8D%E7%AB%AF%E5%AE%9E%E9%99%85%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C%E6%B2%89%E6%B7%80/"/>
    <id>https://windliang.wang/2022/09/05/%E5%89%8D%E7%AB%AF%E5%AE%9E%E9%99%85%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E7%BB%8F%E9%AA%8C%E6%B2%89%E6%B7%80/</id>
    <published>2022-09-04T23:50:41.000Z</published>
    <updated>2022-11-17T00:01:23.941Z</updated>
    
    <content type="html"><![CDATA[<p>分享一下平常开发经常出现问题，增加代码质量的十个小点：</p><h1 id="记得错误处理"><a href="#记得错误处理" class="headerlink" title="记得错误处理"></a>记得错误处理</h1><p>特别是网络请求或者其他异步操作中，<code>await</code> 记得包裹 <code>try catch</code>，可以给用户一个友好提示，同时可以考虑 <code>catch</code> 中需要做什么兜底处理，必要时进行上传日志。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.loading = <span class="keyword">this</span>.$loading(&#123;</span><br><span class="line">    lock: <span class="literal">true</span>,</span><br><span class="line">    text: <span class="string">'加载中...'</span>,</span><br><span class="line">    spinner: <span class="string">'el-icon-loading'</span>,</span><br><span class="line">    background: <span class="string">'rgba(0, 0, 0, 0.7)'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> info = <span class="keyword">await</span> resDistributeService(&#123; <span class="attr">taskTicketId</span>: <span class="keyword">this</span>.id &#125;);</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">this</span>.$message(&#123;</span><br><span class="line">    type: <span class="string">'error'</span>,</span><br><span class="line">    message: e.msg || e.message || <span class="string">'失败'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.loading.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以结合 <code>finally</code>，处理 <code>loading</code> 等。</p><h1 id="数字-0-的校验"><a href="#数字-0-的校验" class="headerlink" title="数字 0 的校验"></a>数字 0 的校验</h1><p>前端经常使用 <code>!v</code> ，来判断 <code>v</code> 是不是有值。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!v)&#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">doSomething()</span><br></pre></td></tr></table></figure><p>但如果 <code>0</code> 是 <code>v</code> 的有效值 ，此时本该处理，但会提前结束，最终引发错误。此时需要显示的判断是否是 <code>null</code> 或者 <code>undefined</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(v === <span class="literal">null</span> || v=== <span class="literal">undefined</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">doSomething()</span><br></pre></td></tr></table></figure><h1 id="默认对象采用函数返回"><a href="#默认对象采用函数返回" class="headerlink" title="默认对象采用函数返回"></a>默认对象采用函数返回</h1><p>由于 <code>js</code> 中的对象是引用，因此赋默认值的时候最好通过函数，每次都返回一个新对象。</p><p>bad:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultCondition = &#123;</span><br><span class="line">  name: <span class="string">''</span>,</span><br><span class="line">  conditionList: [</span><br><span class="line">    &#123;</span><br><span class="line">      conditionCode: <span class="string">''</span>,</span><br><span class="line">      conditionValue: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            condition: &#123;...defaultCondition&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        closeDialog() &#123;</span><br><span class="line">            <span class="keyword">this</span>.condition =  &#123;...defaultCondition&#125;;</span><br><span class="line">            <span class="keyword">this</span>.configId = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.$refs.form.resetFields();</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>good:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getDefaultCondition = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">  name: <span class="string">''</span>,</span><br><span class="line">  conditionList: [</span><br><span class="line">    &#123;</span><br><span class="line">      conditionCode: <span class="string">''</span>,</span><br><span class="line">      conditionValue: <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            condition: getDefaultCondition(),</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        closeDialog() &#123;</span><br><span class="line">            <span class="keyword">this</span>.condition = getDefaultCondition();</span><br><span class="line">            <span class="keyword">this</span>.configId = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.$refs.form.resetFields();</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="接口地址单独存放"><a href="#接口地址单独存放" class="headerlink" title="接口地址单独存放"></a>接口地址单独存放</h1><p>将接口的定义放到统一文件中，未来变动改动起来会比较方便，如果各个 <code>url</code> 都写死在页面中以后就很麻烦了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service.js</span></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'utils/request'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> service = <span class="keyword">new</span> (request(<span class="string">'/api/m/mallorder/exp/compensation/customer'</span>))();</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> listService = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> service.post(<span class="string">'/queryRuleList'</span>, params);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> listDataKey = <span class="string">'ruleVOList'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> idKey = <span class="string">'ruleId'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> dialogEnumService = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> service.get(<span class="string">'/info'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> saveService = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> service.post(<span class="string">'/saveRule'</span>, params);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> detailService = <span class="function">(<span class="params">params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> service.get(<span class="string">'/detail'</span>, params);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>此外，网络请求一般都会在 <code>npm</code> 包的基础上自己再包一层，一方面可以注入共用参数，另一方面可以对返回数据进行统一的错误处理。</p><h1 id="函数多参数采用对象"><a href="#函数多参数采用对象" class="headerlink" title="函数多参数采用对象"></a>函数多参数采用对象</h1><p>如果定义一个函数需要 3 个以上的参数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">a,b,c,d</span>)</span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时可以考虑采用对象解构，改为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">&#123;a=<span class="number">1</span>,b,c,d&#125;=&#123;&#125;</span>)</span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>好处是未来需要扩展参数的时候，不需要太担心其他地方调用时候传参是否会引起问题。</p><p>当然，如果参数过多也需要思考一下当前函数是否承载了太多的功能，进行一下功能上的拆分。</p><h1 id="函数单一职责"><a href="#函数单一职责" class="headerlink" title="函数单一职责"></a>函数单一职责</h1><p>当我们已经定义了一个函数，比如去初始一些变量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initOptions</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  a = xxx</span><br><span class="line">  b = xxx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时我们需要做另一件无关的事 【A】，虽然它和 <code>initOptions</code> 调用的时机一致，但最好不要直接放到 <code>initOptions</code> 中，而是新建一个函数单独调用。</p><p>不然未来如果其他地方也要调 <code>initOptions</code>，但此时可能并不需要做【A】这件事情就会引起 <code>bug</code>。</p><h1 id="参数合法性判断"><a href="#参数合法性判断" class="headerlink" title="参数合法性判断"></a>参数合法性判断</h1><p>由于 <code>js</code> 语言的灵活性，函数传入的参数很可能不符合预期，必要时我们需要进行判断并且进行兜底处理，不可完全信任调用方。</p><p>团队合作中，该函数在未来极大可能会被其他人调用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSomeThing</span>(<span class="params">params1, params2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(params1 === <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(params2)&#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 再去做我们的事情</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果后边的流程强依赖于 <code>params</code>，我们可以直接 <code>return</code>，必要时也可以上报日志或者 <code>throw Error</code>。</p><h1 id="整数的处理"><a href="#整数的处理" class="headerlink" title="整数的处理"></a>整数的处理</h1><p><code>js</code> 中没有整数类型，即 <code>java</code> 中的 <code>int</code>、<code>long</code> 这些，所有数字都遵循 <code>IEEE 754</code> 标准，即 <code>java</code> 中的 <code>double</code> 类型，详细的可参考 <a href="https://zhuanlan.zhihu.com/p/75581822" target="_blank" rel="noopener">浮点数详解。</a></p><p>可以精确表示的最大整数是 <code>9007199254740991</code>，共 <code>16</code> 位，超过这个数精度可能会丢失，对于新接口，可以问一下后端相应数字字段的最大值会是多少。</p><p>对于浮点数的处理，除了众所周知的 <code>0.1 + 0.2 === 0.3</code> 的值为<code>false</code> 外，当我们对数字进行运算的时候也需要注意。</p><p>常见的将 <code>9.04</code> 元转为 <code>904</code> 分：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.com1661472877631-d41092fa-913c-40f8-89a0-154c7fd2fcc8.png" alt="img"></p><p>我们需要对结果进行取整处理。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.com1661472888799-0efa6ca3-5337-42ef-b623-1f999757f209.png" alt="img"></p><h1 id="可选链"><a href="#可选链" class="headerlink" title="可选链"></a>可选链</h1><p>可选链操作符，参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Optional_chaining" target="_blank" rel="noopener">MDN</a> ，用的比较多。</p><p>和后端定的数组或者对象，后端有时候返回来的很可能是 <code>null</code> 甚至没有该字段，因此前端可以用可选链操作符用于数组、对象、函数，防止出现错误直接阻断后续流程。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> nestedProp = obj.first?.second; <span class="comment">// 等效于 obj.first &amp;&amp; obj.fisrt.second</span></span><br><span class="line"><span class="comment">//后续流程</span></span><br></pre></td></tr></table></figure><p>但不要过度使用可选链，如果某些地方理论上不会出问题，比如 <code>let test = obj.first?.second</code>，如果 <code>second</code> 一定能取到，我们直接 <code>let test = obj.first.second</code> 即可。</p><p>不然未来如果这里由于某种原因出了问题导致 <code>obj.first</code> 是 <code>null</code>，但我们使用了可选链，所以 <code>obj.first?.second</code> 也不会报错，我们就永远不会知道这里出现问题了。</p><p>当然也需要权衡下，不加可选链造成<code>js Error</code> 会不会影响业务逻辑。</p><h1 id="对象or数组引用"><a href="#对象or数组引用" class="headerlink" title="对象or数组引用"></a>对象or数组引用</h1><p>修改或者使用对象、数组时，时刻切记它们为引用，一处修改会造成处处修改。</p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>以上的点应该算已经融入血液中了，平常开发和帮同事过 <code>pr</code> 的时候会格外注意，和业务逻辑没有关系，但可以提升代码质量。还有 <code>Vue</code> 一些常见的点也总结了一下，在语雀建了一个文档，未来有其他想法也会再更新一下，感兴趣的同学可以收藏一下，<a href="https://www.yuque.com/books/share/4946f854-2cac-4918-b70f-223fb173b7c2" target="_blank" rel="noopener">前端实践沉淀</a>。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220905081810640.png" alt="image-20220905081810640"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;分享一下平常开发经常出现问题，增加代码质量的十个小点：&lt;/p&gt;
&lt;h1 id=&quot;记得错误处理&quot;&gt;&lt;a href=&quot;#记得错误处理&quot; class=&quot;headerlink&quot; title=&quot;记得错误处理&quot;&gt;&lt;/a&gt;记得错误处理&lt;/h1&gt;&lt;p&gt;特别是网络请求或者其他异步操作中，&lt;c
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>油猴脚本重写fetch和xhr请求</title>
    <link href="https://windliang.wang/2022/08/23/%E6%B2%B9%E7%8C%B4%E8%84%9A%E6%9C%AC%E9%87%8D%E6%96%B0fetch%E5%92%8Cxhr%E8%AF%B7%E6%B1%82/"/>
    <id>https://windliang.wang/2022/08/23/%E6%B2%B9%E7%8C%B4%E8%84%9A%E6%9C%AC%E9%87%8D%E6%96%B0fetch%E5%92%8Cxhr%E8%AF%B7%E6%B1%82/</id>
    <published>2022-08-22T23:35:02.000Z</published>
    <updated>2022-11-17T00:01:23.988Z</updated>
    
    <content type="html"><![CDATA[<p>写过几个油猴脚本，经常对页面请求返回的数据进行拦截或者覆盖，这篇文章就做个总结，涉及到 <code>fetch</code> 和 <code>xhr</code> 两种类型的请求。</p><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>先简单写个 <code>html</code> 页面，搭一个 <code>koa</code> 服务进行测试。</p><p><code>html</code> 页面提供一个 <code>id=json</code> 的 <code>dom</code> 用来加数据，后边我们补充 <code>test.js</code> 文件来请求接口。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        我运行了</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"json"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"test.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>将 <code>html</code> 通过 <code>VSCode</code> 的 <code>live-server</code> 插件运行在 <code>http://127.0.0.1:5500/</code> 上。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220823080047006.png" alt="image-20220823080047006"></p><p>安装 <code>koa</code> 和 <code>koa-route</code> 的 <code>node</code> 包，提供一个接口。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">"koa"</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> koa();</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">"koa-router"</span>)();</span><br><span class="line">router.get(<span class="string">"/api/query"</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        data: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],</span><br><span class="line">        code: <span class="number">0</span>,</span><br><span class="line">        msg: <span class="string">"成功"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 跨域</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    ctx.set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"http://127.0.0.1:5500"</span>);</span><br><span class="line">    ctx.set(</span><br><span class="line">        <span class="string">"Access-Control-Allow-Headers"</span>,</span><br><span class="line">        <span class="string">"Content-Type, Content-Length, Authorization, Accept, X-Requested-With"</span></span><br><span class="line">    );</span><br><span class="line">    ctx.set(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"PUT, POST, GET, DELETE, OPTIONS"</span>);</span><br><span class="line">    <span class="keyword">if</span> (ctx.method === <span class="string">"OPTIONS"</span>) &#123;</span><br><span class="line">        ctx.body = <span class="number">200</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 启动路由</span></span><br><span class="line">app.use(router.routes());</span><br><span class="line"><span class="comment">// 设置响应头</span></span><br><span class="line">app.use(router.allowedMethods());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听端口</span></span><br><span class="line">app.listen(<span class="number">3002</span>);</span><br></pre></td></tr></table></figure><p>提供了 <code>/api/query</code> 接口，返回 <code>data: [1,2,3],</code> 。运行在本地的 <code>3002</code> 端口上，并且设置跨域，允许从 <code>http://127.0.0.1:5500</code> 访问。</p><h1 id="油猴脚本"><a href="#油猴脚本" class="headerlink" title="油猴脚本"></a>油猴脚本</h1><p>先简单写一个插入 <code>我是油猴脚本的文本</code> 的脚本，后边再进行修改。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         网络拦截测试</span></span><br><span class="line"><span class="comment">// @namespace    https://windliang.wang/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  测试</span></span><br><span class="line"><span class="comment">// @author       windliang</span></span><br><span class="line"><span class="comment">// @match        http://127.0.0.1:5500/index.html</span></span><br><span class="line"><span class="comment">// @run-at       document-start</span></span><br><span class="line"><span class="comment">// @grant        unsafeWindow</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.unsafeWindow)</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">    dom.innerText = <span class="string">'我是油猴脚本的文本'</span></span><br><span class="line">    <span class="built_in">document</span>.getElementsByTagName(<span class="string">"body"</span>)[<span class="number">0</span>].append(dom);</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>此时页面已经被成功拦截：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220823101447976.png" alt="image-20220823101447976"></p><p>这里提一句，油猴脚本如果使用 <code>@grant</code> 申请了权限，此时脚本会运行在一个沙箱环境中，如果想访问原始的 <code>window</code> 对象，可以通过 <code>window.unsafeWindow</code> 。</p><p>并且我们加了 <code>@run-at</code> ，让脚本尽快执行。</p><h1 id="fetch-请求"><a href="#fetch-请求" class="headerlink" title="fetch 请求"></a>fetch 请求</h1><p>在 <code>html</code> 请求的 <code>test.js</code> 中添加 <code>fetch</code> 的代码。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">"http://localhost:3002/api/query"</span>)</span><br><span class="line">  .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> dom = <span class="built_in">document</span>.getElementById(<span class="string">"json"</span>); </span><br><span class="line">  dom.innerText = res.data;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>看下页面，此时就会把 <code>data</code> 显示出来。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220823102924464.png" alt="image-20220823102924464"></p><p>如果想更改返回的数据，我们只需要在油猴脚本中重写 <code>fetch</code> 方法，将原数据拿到以后再返回即可。 </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         网络拦截测试</span></span><br><span class="line"><span class="comment">// @namespace    https://windliang.wang/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  测试</span></span><br><span class="line"><span class="comment">// @author       windliang</span></span><br><span class="line"><span class="comment">// @match        http://127.0.0.1:5500/index.html</span></span><br><span class="line"><span class="comment">// @run-at       document-start</span></span><br><span class="line"><span class="comment">// @grant        unsafeWindow</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">window</span>.unsafeWindow)</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">    dom.innerText = <span class="string">'我是油猴脚本的文本'</span></span><br><span class="line">    <span class="built_in">document</span>.getElementsByTagName(<span class="string">"body"</span>)[<span class="number">0</span>].append(dom);</span><br><span class="line">    <span class="keyword">const</span> originFetch = fetch;</span><br><span class="line">    <span class="built_in">console</span>.log(originFetch)</span><br><span class="line">    <span class="built_in">window</span>.unsafeWindow.fetch = <span class="function">(<span class="params">url, options</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> originFetch(url, options).then(<span class="keyword">async</span> (response) =&gt; &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(url)</span><br><span class="line">            <span class="keyword">if</span>(url === <span class="string">'http://localhost:3002/api/query'</span>)&#123;</span><br><span class="line">                <span class="keyword">const</span> responseClone = response.clone();</span><br><span class="line">                <span class="keyword">let</span> res = <span class="keyword">await</span> responseClone.json();</span><br><span class="line">                res.data.push(<span class="string">'油猴脚本修改数据'</span>)</span><br><span class="line">                <span class="keyword">const</span> responseNew = <span class="keyword">new</span> Response(<span class="built_in">JSON</span>.stringify(res), response);</span><br><span class="line">                <span class="keyword">return</span> responseNew;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>对 <code>response</code> 的处理有点绕，当时也是试了好多次才试出了这种方案。</p><p>做的事情就是把原来返回的 <code>respones</code> 复制，通过 <code>json</code> 方法拿到数据，进行修改数据，最后新生成一个 <code>Response</code> 进行返回。</p><p>看下效果：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220823173813341.png" alt="image-20220823173813341"></p><p>成功修改了返回的数据。</p><h1 id="xhr"><a href="#xhr" class="headerlink" title="xhr"></a>xhr</h1><p>我们将 <code>fetch</code> 改为用 <code>xhr</code> 发送请求，因为页面简单所以请求可能在油猴脚本重写之前就发送了，正常网站不会这么快，所以这里加一个 <code>setTimeout</code> 进行延时。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">'GET'</span>, <span class="string">'http://localhost:3002/api/query'</span>);</span><br><span class="line">    xhr.send();</span><br><span class="line">    xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">        <span class="keyword">const</span> dom = <span class="built_in">document</span>.getElementById(<span class="string">"json"</span>);</span><br><span class="line">        dom.innerText = res.data;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>和 <code>fetch</code> 的思路一样，我们可以在返回前更改 <code>responseText</code> 。</p><p>重写 <code>XMLHttpRequest</code> 原型对象的 <code>open</code> 或者 <code>send</code> 方法，在函数内拿到用户当前的 <code>xhr</code> 实例，监听 <code>readystatechange</code> 事件，然后重写 <code>responseText</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> originOpen = XMLHttpRequest.prototype.open;</span><br><span class="line">XMLHttpRequest.prototype.open = <span class="function"><span class="keyword">function</span> (<span class="params">_, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (url === <span class="string">"http://localhost:3002/api/query"</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.addEventListener(<span class="string">"readystatechange"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.readyState === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">        res.data.push(<span class="string">"油猴脚本修改数据"</span>);</span><br><span class="line">        <span class="keyword">this</span>.responseText = <span class="built_in">JSON</span>.stringify(res);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  originOpen.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>运行一下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220824084014585.png" alt="image-20220824084014585"></p><p>拦截失败了，网上搜寻下答案，原因是  <code>responseText</code> 不是可写的，我们将原型对象上的 <code>responseText</code> 属性描述符打印一下。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220824084726967.png" alt="image-20220824084726967"></p><p>可以看到 <code>set</code> 属性是 <code>undefined</code> ，因此我们重写 <code>responseText</code> 失败了。</p><p>我们无法修改原型对象上的 <code>responseText</code> ，我们可以在当前 <code>xhr</code> 对象，也就是 <code>this</code> 上边定义一个同名的 <code>responseText</code> 属性，赋值的话有两种思路。</p><h2 id="1、直接赋值"><a href="#1、直接赋值" class="headerlink" title="1、直接赋值"></a>1、直接赋值</h2><p>我们定义一个 <code>writable: true,</code> 的属性，然后直接赋值为我们修改后的数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> originOpen = XMLHttpRequest.prototype.open;</span><br><span class="line">XMLHttpRequest.prototype.open = <span class="function"><span class="keyword">function</span> (<span class="params">_, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (url === <span class="string">"http://localhost:3002/api/query"</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.addEventListener(<span class="string">"readystatechange"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.readyState === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="built_in">JSON</span>.parse(<span class="keyword">this</span>.responseText);</span><br><span class="line">        <span class="comment">// 当前 xhr 对象上定义 responseText</span></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, <span class="string">"responseText"</span>, &#123; </span><br><span class="line">          writable: <span class="literal">true</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        res.data.push(<span class="string">"油猴脚本修改数据"</span>);</span><br><span class="line">        <span class="keyword">this</span>.responseText = <span class="built_in">JSON</span>.stringify(res);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  originOpen.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>看下页面会发现成功拦截了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220824085203088.png" alt="image-20220824085203088"></p><h2 id="2、重写-get"><a href="#2、重写-get" class="headerlink" title="2、重写 get"></a>2、重写 get</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> originOpen = XMLHttpRequest.prototype.open;</span><br><span class="line">XMLHttpRequest.prototype.open = <span class="function"><span class="keyword">function</span> (<span class="params">_, url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (url === <span class="string">"http://localhost:3002/api/query"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> xhr = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> getter = <span class="built_in">Object</span>.getOwnPropertyDescriptor(</span><br><span class="line">      XMLHttpRequest.prototype,</span><br><span class="line">      <span class="string">"response"</span></span><br><span class="line">    ).get;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(xhr, <span class="string">"responseText"</span>, &#123;</span><br><span class="line">      get: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = getter.call(xhr);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> res = <span class="built_in">JSON</span>.parse(result);</span><br><span class="line">          res.data.push(<span class="string">'油猴脚本修改数据'</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(res);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  originOpen.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们拿到原型对象的 <code>get</code> ，然后在当前对象上定义 <code>responseText</code> 的 <code>get</code>属性，修改数据后返回即可。</p><p>相比于第一种方案，这种方案无需等待  <code>readystatechange</code> ，在开始的时候重写即可。</p><p>需要注意的是，上边方案都只是重写了 <code>responseText</code> 字段，不排除有的网站读取的是 <code>response</code> 字段，但修改的话和上边是一样的，这里就不写了。</p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>通过对 <code>fetch</code> 和 <code>xhr</code> 的重写，我们基本上可以对网页「为所欲为」了，发挥想象力通过油猴脚本应该可以做很多有意思的事情。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;写过几个油猴脚本，经常对页面请求返回的数据进行拦截或者覆盖，这篇文章就做个总结，涉及到 &lt;code&gt;fetch&lt;/code&gt; 和 &lt;code&gt;xhr&lt;/code&gt; 两种类型的请求。&lt;/p&gt;
&lt;h1 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="油猴" scheme="https://windliang.wang/tags/%E6%B2%B9%E7%8C%B4/"/>
    
  </entry>
  
  <entry>
    <title>elementUI中el-tabs或者说Vue现存的一个bug排查</title>
    <link href="https://windliang.wang/2022/08/14/elementUI%E4%B8%ADel-tabs%E7%9A%84%E4%B8%80%E4%B8%AAbug%E5%88%86%E6%9E%90/"/>
    <id>https://windliang.wang/2022/08/14/elementUI%E4%B8%ADel-tabs%E7%9A%84%E4%B8%80%E4%B8%AAbug%E5%88%86%E6%9E%90/</id>
    <published>2022-08-13T23:26:13.000Z</published>
    <updated>2022-11-17T00:01:23.933Z</updated>
    
    <content type="html"><![CDATA[<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p> <code>element-ui</code> 版本是 <code>2.15.9</code>，<code>vue</code> 版本是 <code>2.7.8</code> 。</p><p>在 <code>el-dialog</code> 中使用 <code>el-tabs</code> ，并且 <code>el-dialog</code> 添加 <code>destroy-on-close</code> 属性，当关闭弹窗的时候页面就直接无响应了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">        &lt;el-dialog</span><br><span class="line">            title=<span class="string">"提示"</span></span><br><span class="line">            :visible.sync=<span class="string">"dialogVisible"</span></span><br><span class="line">            width=<span class="string">"30%"</span></span><br><span class="line">            destroy-on-close</span><br><span class="line">        &gt;</span><br><span class="line">            &lt;el-tabs type=<span class="string">"border-card"</span>&gt;</span><br><span class="line">                &lt;el-tab-pane label=<span class="string">"用户管理"</span>&gt;用户管理&lt;<span class="regexp">/el-tab-pane&gt;</span></span><br><span class="line"><span class="regexp">                &lt;el-tab-pane label="配置管理"&gt;配置管理&lt;/</span>el-tab-pane&gt;</span><br><span class="line">                &lt;el-tab-pane label=<span class="string">"角色管理"</span>&gt;角色管理&lt;<span class="regexp">/el-tab-pane&gt;</span></span><br><span class="line"><span class="regexp">                &lt;el-tab-pane label="定时任务补偿"&gt;定时任务补偿&lt;/</span>el-tab-pane&gt;</span><br><span class="line">            &lt;<span class="regexp">/el-tabs&gt;</span></span><br><span class="line"><span class="regexp">            &lt;span slot="footer" class="dialog-footer"&gt;</span></span><br><span class="line"><span class="regexp">                &lt;el-button @click="dialogVisible = false"&gt;取 消&lt;/</span>el-button&gt;</span><br><span class="line">                &lt;el-button type=<span class="string">"primary"</span> @click=<span class="string">"dialogVisible = false"</span></span><br><span class="line">                    &gt;确 定&lt;<span class="regexp">/el-button</span></span><br><span class="line"><span class="regexp">                &gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>span&gt;</span><br><span class="line">        &lt;<span class="regexp">/el-dialog&gt;</span></span><br><span class="line"><span class="regexp">        &lt;el-button @click="dialogVisible = true"&gt;打开弹窗&lt;/</span>el-button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">"App"</span>,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            dialogVisible: <span class="literal">false</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>效果如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.com11.gif" alt="11"></p><p>再等一会儿 <code>Chrome</code> 就直接抛错了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220814073751320.png" alt="image-20220814073751320"></p><p>操作过程中控制台也没有任何报错，去 <code>github</code> 的 <code>issues</code> 看一眼发现已经有 <code>3</code> 个人遇到过这个问题了：</p><p><a href="https://github.com/ElemeFE/element/issues/21114" target="_blank" rel="noopener">[bug report] El dialog [destroy on close] El tabs page crashes #21114</a></p><p><a href="https://github.com/ElemeFE/element/issues/20974" target="_blank" rel="noopener">[Bug Report] When set a attribute “destory-on-close=’true’” on a el-dialog which has a child el-tabs component will cause the browser crash #20974</a></p><p><a href="https://github.com/ElemeFE/element/issues/20947" target="_blank" rel="noopener">[Bug Report] el-tabs in el-dialog with destroy-on-close=‘true’ ,dialog can’t be closed</a></p><p>看表现应该是哪里陷入了死循环，猜测是 <code>el-tabs</code> 的 <code>render</code> 函数在无限执行。</p><p>为了证实这个猜测，我们直接在 <code>node_modules</code> 中 <code>el-tabs</code> 的 <code>render</code> 函数添加 <code>console</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220814080300663.png" alt="image-20220814080300663"></p><p>打开控制台观察一下是否有输出：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comKapture%202022-08-14%20at%2008.05.56.gif" alt="Kapture 2022-08-14 at 08.05.56"></p><p>直接原因找到了，下边需要排查一下 <code>render</code> 进入死循环的原因。</p><h1 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h1><p>可能出现问题的点，<code>el-dialog</code>、<code>el-tabs</code>、<code>el-tab-pane</code>，当然如果上述都没问题的话，也不排除 <code>Vue</code> 的问题，虽然可能性很低。</p><h2 id="el-dialog"><a href="#el-dialog" class="headerlink" title="el-dialog"></a>el-dialog</h2><p>如果我们把 <code>destroy-on-close</code> 属性去掉，然后一切就恢复正常了。所以我们先看一下 <code>destroy-on-close</code>  做了什么。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;transition</span><br><span class="line">    name=<span class="string">"dialog-fade"</span></span><br><span class="line">    @after-enter=<span class="string">"afterEnter"</span></span><br><span class="line">    @after-leave=<span class="string">"afterLeave"</span>&gt;</span><br><span class="line">    &lt;div</span><br><span class="line">      v-show=<span class="string">"visible"</span></span><br><span class="line">      <span class="class"><span class="keyword">class</span></span>=<span class="string">"el-dialog__wrapper"</span></span><br><span class="line">      @click.self=<span class="string">"handleWrapperClick"</span>&gt;</span><br><span class="line">      &lt;div</span><br><span class="line">        role=<span class="string">"dialog"</span></span><br><span class="line">        :key=<span class="string">"key"</span></span><br><span class="line">        :style=<span class="string">"style"</span>&gt;</span><br><span class="line">        ...</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"el-dialog__body"</span> v-<span class="keyword">if</span>=<span class="string">"rendered"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        ...</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  &lt;<span class="regexp">/transition&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br></pre></td></tr></table></figure><p>最关键的的是 <code>&lt;el-dialog__body&gt;</code> 的外层 <code>div</code> 中设置了一个 <code>key</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">watch: &#123;</span><br><span class="line">  visible(val) &#123;</span><br><span class="line">    <span class="keyword">if</span> (val) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.$el.removeEventListener(<span class="string">'scroll'</span>, <span class="keyword">this</span>.updatePopper);</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.closed) <span class="keyword">this</span>.$emit(<span class="string">'close'</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.destroyOnClose) &#123;</span><br><span class="line">        <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.key++;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>当我们把 <code>dialog</code> 的 <code>visible</code> 置为 <code>false</code> 的时候，会判断 <code>this.destroyOnClose</code> 的值，然后修改 <code>key</code> 的值。</p><p>当 <code>key</code> 值修改以后，<code>div</code> 中的元素就会整个重新渲染了，这就是官网中所说明 <code>this.destroyOnClose</code> 的作用。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220814095416654.png" alt="image-20220814095416654"></p><p>为了排除 <code>el-dialog</code> 的问题，我们写一个自定义组件来替代 <code>el-dialog</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div v-show=<span class="string">"showDialog"</span> :key=<span class="string">"key"</span>&gt;</span><br><span class="line">        &lt;slot&gt;<span class="xml"><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    components: &#123;&#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            key: <span class="number">1</span>,</span><br><span class="line">            showDialog: <span class="literal">false</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        open() &#123;</span><br><span class="line">            <span class="keyword">this</span>.showDialog = <span class="literal">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        close() &#123;</span><br><span class="line">            <span class="keyword">this</span>.key += <span class="number">1</span></span><br><span class="line">            <span class="keyword">this</span>.showDialog = <span class="literal">false</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style scoped&gt;&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure><p>接着我们将 <code>el-dialog</code>  换为上边的组件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">        &lt;wrap ref=<span class="string">"wrap"</span>&gt;</span><br><span class="line">            &lt;el-tabs type=<span class="string">"border-card"</span>&gt;</span><br><span class="line">                &lt;el-tab-pane label=<span class="string">"用户管理"</span>&gt;用户管理&lt;<span class="regexp">/el-tab-pane&gt;</span></span><br><span class="line"><span class="regexp">                &lt;el-tab-pane label="配置管理"&gt;配置管理&lt;/</span>el-tab-pane&gt;</span><br><span class="line">                &lt;el-tab-pane label=<span class="string">"角色管理"</span>&gt;角色管理&lt;<span class="regexp">/el-tab-pane&gt;</span></span><br><span class="line"><span class="regexp">                &lt;el-tab-pane label="定时任务补偿"&gt;定时任务补偿&lt;/</span>el-tab-pane&gt;</span><br><span class="line">            &lt;<span class="regexp">/el-tabs&gt;</span></span><br><span class="line"><span class="regexp">            &lt;el-button @click="close"&gt;关闭&lt;/</span>el-button&gt;</span><br><span class="line">        &lt;<span class="regexp">/wrap&gt;</span></span><br><span class="line"><span class="regexp">        &lt;el-button @click="open"&gt;打开弹窗&lt;/</span>el-button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> Wrap <span class="keyword">from</span> <span class="string">"./Wrap.vue"</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">"App"</span>,</span><br><span class="line">    components: &#123;</span><br><span class="line">        Wrap,</span><br><span class="line">    &#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        open() &#123;</span><br><span class="line">            <span class="keyword">this</span>.$refs.wrap.open();</span><br><span class="line">        &#125;,</span><br><span class="line">        close() &#123;</span><br><span class="line">            <span class="keyword">this</span>.$refs.wrap.close();</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style&gt;</span></span><br><span class="line"><span class="regexp">#app &#123;</span></span><br><span class="line"><span class="regexp">    font-family: Avenir, Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="regexp">    -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="regexp">    -moz-osx-font-smoothing: grayscale;</span></span><br><span class="line"><span class="regexp">    text-align: center;</span></span><br><span class="line"><span class="regexp">    color: #2c3e50;</span></span><br><span class="line"><span class="regexp">    margin-top: 60px;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure><p>运行之后发现问题依旧存在，因此我们可以排除是 <code>el-dialog</code> 的问题了。</p><h2 id="el-tabs-el-tab-pane"><a href="#el-tabs-el-tab-pane" class="headerlink" title="el-tabs el-tab-pane"></a>el-tabs el-tab-pane</h2><p>接下来就是一个二选一问题了，问题代码是在 <code>el-tabs</code> 还是 <code>el-tab-pane</code> 中。</p><p>我们把 <code>el-tab-pane</code> 从 <code>el-tabs</code> 去掉再来看一下还有没有问题。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">wrap</span> <span class="attr">ref</span>=<span class="string">"wrap"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-tabs</span> <span class="attr">type</span>=<span class="string">"border-card"</span>&gt;</span></span><br><span class="line">                hello World</span><br><span class="line">            <span class="tag">&lt;/<span class="name">el-tabs</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">el-button</span> @<span class="attr">click</span>=<span class="string">"close"</span>&gt;</span>关闭<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">wrap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-button</span> @<span class="attr">click</span>=<span class="string">"open"</span>&gt;</span>打开弹窗<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行一下发现一切正常了：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comKapture%202022-08-14%20at%2010.07.33.gif" alt="Kapture 2022-08-14 at 10.07.33"></p><p>至此，可以基本确认是 <code>el-tab-pane</code> 问题了。</p><h1 id="直接原因"><a href="#直接原因" class="headerlink" title="直接原因"></a>直接原因</h1><p>我们来定位是哪行代码出现了问题，看一下 <code>el-tab-pane</code> 的整个代码。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div</span><br><span class="line">    <span class="class"><span class="keyword">class</span></span>=<span class="string">"el-tab-pane"</span></span><br><span class="line">    v-<span class="keyword">if</span>=<span class="string">"(!lazy || loaded) || active"</span></span><br><span class="line">    v-show=<span class="string">"active"</span></span><br><span class="line">    role=<span class="string">"tabpanel"</span></span><br><span class="line">    :aria-hidden=<span class="string">"!active"</span></span><br><span class="line">    :id=<span class="string">"`pane-$&#123;paneName&#125;`"</span></span><br><span class="line">    :aria-labelledby=<span class="string">"`tab-$&#123;paneName&#125;`"</span></span><br><span class="line">  &gt;</span><br><span class="line">    &lt;slot&gt;<span class="xml"><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span></span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">'ElTabPane'</span>,</span><br><span class="line"></span><br><span class="line">    componentName: <span class="string">'ElTabPane'</span>,</span><br><span class="line"></span><br><span class="line">    props: &#123;</span><br><span class="line">      label: <span class="built_in">String</span>,</span><br><span class="line">      labelContent: <span class="built_in">Function</span>,</span><br><span class="line">      name: <span class="built_in">String</span>,</span><br><span class="line">      closable: <span class="built_in">Boolean</span>,</span><br><span class="line">      disabled: <span class="built_in">Boolean</span>,</span><br><span class="line">      lazy: <span class="built_in">Boolean</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    data() &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        index: <span class="literal">null</span>,</span><br><span class="line">        loaded: <span class="literal">false</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    computed: &#123;</span><br><span class="line">      isClosable() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.closable || <span class="keyword">this</span>.$parent.closable;</span><br><span class="line">      &#125;,</span><br><span class="line">      active() &#123;</span><br><span class="line">        <span class="keyword">const</span> active = <span class="keyword">this</span>.$parent.currentName === (<span class="keyword">this</span>.name || <span class="keyword">this</span>.index);</span><br><span class="line">        <span class="keyword">if</span> (active) &#123;</span><br><span class="line">          <span class="keyword">this</span>.loaded = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> active;</span><br><span class="line">      &#125;,</span><br><span class="line">      paneName() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name || <span class="keyword">this</span>.index;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    updated() &#123;</span><br><span class="line">      <span class="keyword">this</span>.$parent.$emit(<span class="string">'tab-nav-update'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>定位 <code>bug</code> 所在行数一般无脑采取二分注释法很快就出来了，经过两次尝试，我们只需要把 <code>updated</code> 中的代码注释掉就一切正常了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updated() &#123;</span><br><span class="line">  <span class="comment">// this.$parent.$emit('tab-nav-update');</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因"></a>根本原因</h1><p>子组件发送了 <code>tab-nav-update</code> 事件，看一下父组件 <code>el-tabs</code> 接收  <code>tab-nav-update</code> 事件的代码。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">created() &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.currentName) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setCurrentName(<span class="string">'0'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.$on(<span class="string">'tab-nav-update'</span>, <span class="keyword">this</span>.calcPaneInstances.bind(<span class="literal">null</span>, <span class="literal">true</span>));</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>这里会执行 <code>calcPaneInstances</code> 方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">calcPaneInstances(isForceUpdate = <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.$slots.default) &#123;</span><br><span class="line">    <span class="keyword">const</span> paneSlots = <span class="keyword">this</span>.$slots.default.filter(<span class="function"><span class="params">vnode</span> =&gt;</span> vnode.tag &amp;&amp;</span><br><span class="line">                                                 vnode.componentOptions &amp;&amp; vnode.componentOptions.Ctor.options.name === <span class="string">'ElTabPane'</span>);</span><br><span class="line">    <span class="comment">// update indeed</span></span><br><span class="line">    <span class="keyword">const</span> panes = paneSlots.map(<span class="function">(<span class="params">&#123; componentInstance &#125;</span>) =&gt;</span> componentInstance);</span><br><span class="line">    <span class="keyword">const</span> panesChanged = !<span class="function">(<span class="params">panes.length === <span class="keyword">this</span>.panes.length &amp;&amp; panes.every((pane, index</span>) =&gt;</span> pane === <span class="keyword">this</span>.panes[index]));</span><br><span class="line">    <span class="keyword">if</span> (isForceUpdate || panesChanged) &#123;</span><br><span class="line">      <span class="keyword">this</span>.panes = panes;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.panes.length !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.panes = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>主要是比较前后的 <code>panes</code> 是否一致，如果不一致就直接用新的覆盖旧的 <code>this.panes</code> 。</p><p>由于 <code>render</code> 函数中使用了 <code>panes</code> ，当修改 <code>panes</code> 的值的时候就会触发 <code>el-tabs</code> 的 <code>render</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">render(h) &#123;</span><br><span class="line">      <span class="keyword">let</span> &#123;</span><br><span class="line">        type,</span><br><span class="line">        handleTabClick,</span><br><span class="line">        handleTabRemove,</span><br><span class="line">        handleTabAdd,</span><br><span class="line">        currentName,</span><br><span class="line">        panes, <span class="comment">// 这里用到了</span></span><br><span class="line">        editable,</span><br><span class="line">        addable,</span><br><span class="line">        tabPosition,</span><br><span class="line">        stretch</span><br><span class="line">      &#125; = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure><p>打印一下关闭弹窗的时候发生了什么：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816063309490.png" alt="image-20220816063309490"></p><p>当关闭弹窗的时候，触发了 <code>el-tabs</code> 的 <code>render</code> ，但此时除了触发了 <code>el-tabs</code> 的 <code>updated</code> ，同时也触发到了 <code>el-tabs-pane</code> 的 <code>updated</code> 。</p><p>在 <code>el-tab-pane</code> 的 <code>updated</code> 中我们发送 <code>tab-nav-update</code> 事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updated() &#123;</span><br><span class="line">  <span class="keyword">this</span>.$parent.$emit(<span class="string">'tab-nav-update'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tab-nav-update</code> 事件的回调是 <code>calcPaneInstances</code> ，除了改变 <code>this</code> 指向，同时传了一个默认参数 <code>true</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$on(<span class="string">'tab-nav-update'</span>, <span class="keyword">this</span>.calcPaneInstances.bind(<span class="literal">null</span>, <span class="literal">true</span>));</span><br></pre></td></tr></table></figure><p>对于 <code>calcPaneInstances</code> 第一个参数的含义是 <code>isForceUpdate</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">calcPaneInstances(isForceUpdate = <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.$slots.default) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (isForceUpdate || panesChanged) &#123;</span><br><span class="line">      <span class="keyword">this</span>.panes = panes;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.panes.length !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.panes = [];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>如果 <code>isForceUpdate</code> 为 <code>true</code> 就会更新 <code>panes</code> 的值，接着又触发 <code>el-tabs</code> 的 <code>render</code> 函数，又一次引发 <code>el-tab-pane</code> 的 <code>updated</code> ，最终造成了 <code>render</code> 的死循环，使得浏览器卡死。</p><h1 id="bug-最小说明"><a href="#bug-最小说明" class="headerlink" title="bug 最小说明"></a>bug 最小说明</h1><p>一句话总结：某些场景下如果父组件重新 <code>render</code>，即使子组件没有变化，但子组件传递了 <code>slot</code> ，此时就会触发子组件的 <code>updated</code> 函数。</p><p>上边的逻辑确实不符合直觉，我们将代码完全从 <code>Element</code> 中抽离，举一个简单的例子来复现这个问题：</p><p><code>App.vue</code> 代码，依旧用 <code>wrap</code> 包裹。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">        &lt;wrap ref=<span class="string">"wrap"</span>&gt;</span><br><span class="line">            &lt;tabs&gt;</span><br><span class="line">                &lt;pane&gt;我来自pane的slot&lt;<span class="regexp">/pane&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>tabs&gt;</span><br><span class="line">            &lt;el-button @click=<span class="string">"close"</span>&gt;关闭&lt;<span class="regexp">/el-button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>wrap&gt;</span><br><span class="line">        &lt;el-button @click=<span class="string">"open"</span>&gt;打开弹窗&lt;<span class="regexp">/el-button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import Wrap from "./</span>Wrap.vue<span class="string">";</span></span><br><span class="line"><span class="string">import Pane from "</span>./Pane.vue<span class="string">";</span></span><br><span class="line"><span class="string">import Tabs from "</span>./Tabs.vue<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default &#123;</span></span><br><span class="line"><span class="string">    name: "</span>App<span class="string">",</span></span><br><span class="line"><span class="string">    components: &#123;</span></span><br><span class="line"><span class="string">        Wrap,</span></span><br><span class="line"><span class="string">        Pane,</span></span><br><span class="line"><span class="string">        Tabs,</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    data() &#123;</span></span><br><span class="line"><span class="string">        return &#123;</span></span><br><span class="line"><span class="string">            show: false,</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    methods: &#123;</span></span><br><span class="line"><span class="string">        open() &#123;</span></span><br><span class="line"><span class="string">            this.$refs.wrap.open();</span></span><br><span class="line"><span class="string">            this.show = true;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        close() &#123;</span></span><br><span class="line"><span class="string">            this.$refs.wrap.close();</span></span><br><span class="line"><span class="string">            this.show = false;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;style&gt;</span></span><br><span class="line"><span class="string">#app &#123;</span></span><br><span class="line"><span class="string">    font-family: Avenir, Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="string">    -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="string">    -moz-osx-font-smoothing: grayscale;</span></span><br><span class="line"><span class="string">    text-align: center;</span></span><br><span class="line"><span class="string">    color: #2c3e50;</span></span><br><span class="line"><span class="string">    margin-top: 60px;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure><p><code>Tabs.vue</code> ，提供一个 <code>slot</code> ，并且提供一个方法更新自己包含的 <code>data</code> 属性 <code>i</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;div&gt;我是 Tabs，第 &#123;&#123; i &#125;&#125; 次渲染&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;slot&gt;&lt;/</span>slot&gt;</span><br><span class="line">        &lt;el-button @click=<span class="string">"change"</span>&gt;触发 Tabs 重新渲染&lt;<span class="regexp">/el-button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">export default &#123;</span></span><br><span class="line"><span class="regexp">    data() &#123;</span></span><br><span class="line"><span class="regexp">        return &#123;</span></span><br><span class="line"><span class="regexp">            i: 0,</span></span><br><span class="line"><span class="regexp">        &#125;;</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    methods: &#123;</span></span><br><span class="line"><span class="regexp">        change() &#123;</span></span><br><span class="line"><span class="regexp">            this.i++;</span></span><br><span class="line"><span class="regexp">        &#125;,</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    updated() &#123;</span></span><br><span class="line"><span class="regexp">        console.log("Tabs:updated");</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    mounted() &#123;</span></span><br><span class="line"><span class="regexp">        console.log("Tabs:mounted");</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;<span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><code>Pane.vue</code> ，提供一个 <code>slot</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;<span class="xml"><span class="tag">&lt;<span class="name">slot</span>&gt;</span><span class="tag">&lt;/<span class="name">slot</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">    export default &#123;</span></span><br><span class="line"><span class="regexp">mounted() &#123;</span></span><br><span class="line"><span class="regexp">  console.log("Pane:mounted");</span></span><br><span class="line"><span class="regexp">&#125;,</span></span><br><span class="line"><span class="regexp">  updated() &#123;</span></span><br><span class="line"><span class="regexp">    console.log("Pane:updated");</span></span><br><span class="line"><span class="regexp">  &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;<span class="xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>操作路径：</p><p>打开弹窗 -&gt; 关闭弹窗 -&gt; 再打开弹窗（此时 <code>pane</code> 就会触发 <code>updated</code> ） -&gt; 更新 <code>Tabs</code> 的值，会发现 <code>pane</code> 一直触发 <code>updated</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.com3.gif" alt="3"></p><p>如果我们在 <code>Pane</code> 的 <code>updated</code> 中引发 <code>Tabs</code> 的 <code>render</code> ，就会造成死循环了。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>关于这个问题网上前几年已经讨论过了：</p><p><a href="https://segmentfault.com/q/1010000040171066" target="_blank" rel="noopener">https://segmentfault.com/q/1010000040171066</a></p><p><a href="https://github.com/vuejs/vue/issues/8342" target="_blank" rel="noopener">https://github.com/vuejs/vue/issues/8342</a></p><p><a href="https://stackoverflow.com/questions/57536067/why-vue-need-to-forceupdate-components-when-they-include-static-slot" target="_blank" rel="noopener">https://stackoverflow.com/questions/57536067/why-vue-need-to-forceupdate-components-when-they-include-static-slot</a></p><p>但是上边网站的例子试了下已经不能复现了，看起来这个问题被修过一次了，但没有完全解决，可能是当做 <code>feature</code> 了。</p><h2 id="Vue-2-6"><a href="#Vue-2-6" class="headerlink" title="Vue 2.6+"></a>Vue 2.6+</h2><p>如果你的版本是 <code>Vue 2.6</code> 以上，当时尤大提过了一个<a href="https://github.com/vuejs/vue/pull/9371" target="_blank" rel="noopener">解决方案</a>：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816085852972.png" alt="image-20220816085852972"></p><p>指明 <code>slot</code> 的名字，这里就是 <code>default</code> 。</p><p>代码中我们在 <code>Pane</code> 中包裹一层 <code>template</code> 指明 <code>default</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">        &lt;wrap ref=<span class="string">"wrap"</span>&gt;</span><br><span class="line">            &lt;tabs&gt;</span><br><span class="line">                &lt;pane&gt;</span><br><span class="line">                    &lt;template v-slot:<span class="keyword">default</span>&gt; 我来自pane的slot &lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp">                &lt;/</span>pane&gt;</span><br><span class="line">            &lt;<span class="regexp">/tabs&gt;</span></span><br><span class="line"><span class="regexp">            &lt;el-button @click="close"&gt;关闭&lt;/</span>el-button&gt;</span><br><span class="line">        &lt;<span class="regexp">/wrap&gt;</span></span><br><span class="line"><span class="regexp">        &lt;el-button @click="open"&gt;打开弹窗&lt;/</span>el-button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br></pre></td></tr></table></figure><p>再运行一下会发现 <code>pane</code> 的 <code>updated</code> 就不会触发了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816082327739.png" alt="image-20220816082327739"></p><h2 id="Vue-2-6-以下"><a href="#Vue-2-6-以下" class="headerlink" title="Vue 2.6 以下"></a>Vue 2.6 以下</h2><p>仔细想一下，我们第一次渲染的时候并不会出现问题，因此我们干脆在关闭弹窗的时候把 <code>Pane</code> 销毁掉（<code>Pane</code> 添加 <code>v-if</code> ），再打开弹窗的时候现场就和第一次保持一致，就不会引起 <code>Element</code> 的死循环了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"app"</span>&gt;</span><br><span class="line">        &lt;wrap ref=<span class="string">"wrap"</span>&gt;</span><br><span class="line">            &lt;tabs&gt;</span><br><span class="line">                &lt;pane v-<span class="keyword">if</span>=<span class="string">"show"</span>&gt; 我来自pane的slot &lt;<span class="regexp">/pane&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>tabs&gt;</span><br><span class="line">            &lt;el-button @click=<span class="string">"close"</span>&gt;关闭&lt;<span class="regexp">/el-button&gt;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>wrap&gt;</span><br><span class="line">        &lt;el-button @click=<span class="string">"open"</span>&gt;打开弹窗&lt;<span class="regexp">/el-button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import Wrap from "./</span>Wrap.vue<span class="string">";</span></span><br><span class="line"><span class="string">import Pane from "</span>./Pane.vue<span class="string">";</span></span><br><span class="line"><span class="string">import Tabs from "</span>./Tabs.vue<span class="string">";</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export default &#123;</span></span><br><span class="line"><span class="string">    name: "</span>App<span class="string">",</span></span><br><span class="line"><span class="string">    components: &#123;</span></span><br><span class="line"><span class="string">        Wrap,</span></span><br><span class="line"><span class="string">        Pane,</span></span><br><span class="line"><span class="string">        Tabs,</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    data() &#123;</span></span><br><span class="line"><span class="string">        return &#123;</span></span><br><span class="line"><span class="string">            show: false,</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    methods: &#123;</span></span><br><span class="line"><span class="string">        open() &#123;</span></span><br><span class="line"><span class="string">            this.$refs.wrap.open();</span></span><br><span class="line"><span class="string">            this.show = true;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        close() &#123;</span></span><br><span class="line"><span class="string">            this.$refs.wrap.close();</span></span><br><span class="line"><span class="string">            this.show = false;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure><p>同样的，<code>Pane</code> 的 <code>updated</code> 也不会被触发了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816083018335.png" alt="image-20220816083018335"></p><h2 id="等-Element-兼容"><a href="#等-Element-兼容" class="headerlink" title="等 Element 兼容"></a>等 Element 兼容</h2><p>讲道理，这个问题其实也不能算作是 <code>Element</code> 的，但在 <code>updated</code> 生命周期触发渲染其实 <code>Vue</code> 官方已经给出过警告了。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816083227156.png" alt="image-20220816083227156"></p><p><code>Element</code> 兼容的话，需要分析一下当时为什么在 <code>updated</code> 更新父组件状态，然后换一种方式了。</p><h2 id="等-Vue-修复？"><a href="#等-Vue-修复？" class="headerlink" title="等 Vue 修复？"></a>等 Vue 修复？</h2><p>应该不会再修复了，毕竟有方案可以绕过这个问题，强制更新子组件应该是某些场景确实需要更新。</p><p>但 <code>slot</code> 为什么会引发这个问题，源代码到时候我会再研究下，最近也一直在看源代码相关的，目前 <code>Vue2</code> 响应式系统和虚拟 <code>dom</code> 两大块原理解析已经完成了，模版编译已经开始写了，关于 <code>slot</code> 应该也快写到了，感兴趣的同学也可以到 <a href="https://vue.windliang.wang/" target="_blank" rel="noopener">vue.windliang.wang</a> 一起学习，文章会将 <code>Vue</code> 的每个点都拆出来并且配有相应的源代码进行调试。</p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>在业务开发中，如果业务方能解决的问题，一般就自己解决了，一方面底层包团队更新速度确实慢，另一方面，因为业务代码依赖的包可能和最新版本差很多了，即使底层库修复了，我们也不会去更新库版本，罗老师镇楼。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220816084114944.png" alt="image-20220816084114944"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;现象&quot;&gt;&lt;a href=&quot;#现象&quot; class=&quot;headerlink&quot; title=&quot;现象&quot;&gt;&lt;/a&gt;现象&lt;/h1&gt;&lt;p&gt; &lt;code&gt;element-ui&lt;/code&gt; 版本是 &lt;code&gt;2.15.9&lt;/code&gt;，&lt;code&gt;vue&lt;/code&gt; 版本是 
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="elementUI" scheme="https://windliang.wang/tags/elementUI/"/>
    
      <category term="vue" scheme="https://windliang.wang/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>在美团工作的第二年</title>
    <link href="https://windliang.wang/2022/06/30/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%BA%8C%E5%B9%B4/"/>
    <id>https://windliang.wang/2022/06/30/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%BA%8C%E5%B9%B4/</id>
    <published>2022-06-29T23:31:12.000Z</published>
    <updated>2022-11-17T00:01:23.942Z</updated>
    
    <content type="html"><![CDATA[<p>不知不觉入职两周年了，<a href="https://windliang.wang/2021/05/29/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B9%B4/">在美团工作的第一年</a> 里主要介绍了一下平时的工作内容，这次就记录下当下的感受和一些思考吧。</p><h2 id="互联网低谷"><a href="#互联网低谷" class="headerlink" title="互联网低谷"></a>互联网低谷</h2><p>自己 <code>20</code> 年入职那几个月可谓互联网巅峰了，之后随着疫情的持续和政策的影响，互联网就开始一泄千丈。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220630074404498.png" alt="image-20220630074404498"></p><p>网上的裁员消息也是不停歇，今年即将秋招的同学应该会感受更加强烈。</p><p>互联网就此不行了吗？股市除了公司的盈利外，也反映着大家对未来发展的信心程度。互联网本身其实没有变化，反而大家越来越依赖于互联网，微信、短视频、游戏、快递外卖，互联网的应用已经和生活交融在了一起。随着疫情的结束，当大家的生活重新恢复正常，重拾信心，相信互联网依旧会继续向上发展。</p><p>自己 <code>14</code> 年进入大学接触计算机的时候，其实当前互联网并不火爆，计算机学院很多同学是调剂过来的，但到毕业的时候计算机学院的录取分反而成了学校最高的学院。因此，大家选专业、选行业的时候，第一位一定要基于兴趣，没有人能准确预测这个行业未来会怎么样。</p><p>准备进入互联网技术岗位的话，需要做好随时学习新技术的准备，<code>PHP</code>、<code>Flash</code> 、<code>.NET</code> 开发，过去也都火爆一时，但现在也逐步走向小众甚至消失，对于前端，从 <code>jQuery</code> ，到 <code>React</code> 、<code>Vue</code>，到现在的小程序，也就十几年，框架却不断更迭。</p><p>未来漫漫几十年出现新旧技术的更迭是必然的，我们能做的就是持续学习，不要过于关心外部环境的变化，终会有自己的一席之地。当然最重要还是热爱，不管是工作还是什么，唯有热爱，方能抵御岁月漫长。</p><h2 id="技术方向"><a href="#技术方向" class="headerlink" title="技术方向"></a>技术方向</h2><p>从前端的角度来看，可以分为技术前端和业务前端。</p><p>技术前端做的事情主要是公司的一些基础设施，比如 CI/CD 流水线、小程序编辑器、项目的编译优化、UI 组件库，做的东西更像是地基，不面向具体业务。公司的各个业务团队都会用到这些基建，有问题的话就去向相应负责人反馈。</p><p>换句话讲，技术前端面对的用户更多的是开发者。</p><p>业务前端更多的会跟产品经理交流，围绕具体的业务，比如营销活动、直播、发票、内部系统等，产品经理会进行业务数据的分析，然后提出相应的需求，交由业务前端来实现。bug 由测试人员或者开发者自己寻找，或者通过大盘监控异常，最差的情况就是由用户反馈上来。</p><p>相应的，业务前端的产品面向的就是普通人。</p><p>对于找工作的话，这两个大方向就可以确定一个，面试的时候也可以向面试官询问具体的方向。</p><h2 id="业务与技术"><a href="#业务与技术" class="headerlink" title="业务与技术"></a>业务与技术</h2><p>说到业务与技术的关系， @冴羽 <a href="https://mp.weixin.qq.com/s/M9YS_S2uDt3xhYdtDeclkw" target="_blank" rel="noopener">这篇文章</a> 写的非常详细，我就不班门弄斧了。</p><p>一句话总结就是除了技术，我们需要有意识的去理解当前业务各项指标，理解各个需求的目的和联系，从技术的角度为产品赋能。</p><p>除了日常的需求迭代外，我们还需要寻找平时业务或者开发上的痛点，比如开发效率、日志排查、质量建设等，从技术的角度提出解决方案，最终落地实施。</p><p>当然上边说的东西我也还没做到，只能说朝上边的方向努力吧，哈哈。</p><h2 id="关于英语"><a href="#关于英语" class="headerlink" title="关于英语"></a>关于英语</h2><p>英语真的是从小学开始接触到现在也一直在学的东西，虽然现在还是很菜，但值得安慰的是心里一直有这个事情。</p><p>自己看过真的是很多很多关于英语学习的方法了，女朋友每次看到我看英文学习的英文视频就调侃一次，「你现在看这些视频是不是都能无字幕」，哈哈，确实有那么点，毕竟教英语学习方法的单词就那么些。</p><p>多年学习怎么学习英语的方法经验有两点。</p><p>第一点就是坚持，英语不像程序一样有实时反馈，注定就是一个慢慢积累的过程，甚至很长时间看不到进步，但还是需要坚持。</p><p>第二点就是去用，要把英语当成工具，需要自己构造英文环境。简单的比如逛 quora、Twitter 等一些国外应用，再比如看到生活中的物品去想想英语怎么说，看美剧遮住英文字幕，看中文字幕一句一句去翻译校对等。方法很多，重要的还是第一点。</p><p>为什么学英语呢？因为全世界都是在用英语交流，翻译出来的东西和原文一定是有 gap 的，最生动的例子就是古诗翻译成英语，很大程度失去了韵味。从技术来讲，当迈出中文圈的那一步，一定是技术继续向上迈进的必经之步。</p><p>把英语当成工具去探索世界，无论是网上探索还是实地探索，不管是技术还是价值观一定都会有新的认识。</p><p>对于我的话，未来如果我的博客变成了英文来写，那一定是人生中一个值得纪念的时刻。</p><h2 id="关于人生"><a href="#关于人生" class="headerlink" title="关于人生"></a>关于人生</h2><p>当每天重复的两点一线，工作吃饭回家睡觉工作…总会情不自禁的去思考人生的意义是什么。过去一年看了些哲学、心理学方面的东西，人确实是一个神奇的存在，即使是自己也不一定完全了解自己。</p><p>三年前秋招的过程中也产生过迷茫，详见 <a href="https://mp.weixin.qq.com/s/o5U4YG101IJXVsgBiMG_xw" target="_blank" rel="noopener">面完腾讯阿里后对人生的思考</a>。当时对于人生意义有了一定的感触，三年过去了当时的观念也没有变化。仔细探讨的话，人生确实没有意义，一切都需要我们自己赋予。我们现在可以感受身边的一切，就已经是最大的幸福了。</p><p>至于世俗上的成功，每个人的定义也会不一样，人的欲望是无止境的，成功了一次，又想着下一次成功。我们不妨多听听内心的声音，保持 stay hungry stay foolish ，寻找自己的节奏。</p><p>自己太菜了也讲不了太多的东西，这里就推荐几个书吧。「得到」的「刘擎西方现代思想」、「刘玮存在主义哲学20讲」，微信读书的「哲学家们都干了些什么」、「五种时间：重建人生秩序」，「认知觉醒：开启自我改变的原动力」。</p><p>心理学方面的：「思考，快与慢」，「稀缺：我们是如何陷入贫穷与忙碌的」。</p><h2 id="总"><a href="#总" class="headerlink" title="总"></a>总</h2><p>零零碎碎记录了一下，如果对你有所启发，那就更好了。越努力，越幸运，共勉～</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;不知不觉入职两周年了，&lt;a href=&quot;https://windliang.wang/2021/05/29/%E5%9C%A8%E7%BE%8E%E5%9B%A2%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%AC%AC%E4%B8%80%E5%B9%B4/&quot;
      
    
    </summary>
    
    
      <category term="随想" scheme="https://windliang.wang/categories/%E9%9A%8F%E6%83%B3/"/>
    
    
      <category term="美团" scheme="https://windliang.wang/tags/%E7%BE%8E%E5%9B%A2/"/>
    
  </entry>
  
  <entry>
    <title>Element使用的async-validator表单校验库源码解析</title>
    <link href="https://windliang.wang/2022/05/17/async-validator%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C%E5%BA%93%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <id>https://windliang.wang/2022/05/17/async-validator%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C%E5%BA%93%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</id>
    <published>2022-05-17T00:13:34.000Z</published>
    <updated>2022-11-17T00:01:23.933Z</updated>
    
    <content type="html"><![CDATA[<p>平常开发写 <code>element</code> 表单的时候，肯定少不了表单的校验，<code>element</code> 使用的是 <a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">async-validator</a> 这个开源库。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220517090312952.png" alt="image-20220517090312952"></p><p>这篇文章详细分析一下 <code>async-validator</code> 的主流程。</p><h1 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Schema <span class="keyword">from</span> <span class="string">'async-validator'</span>;</span><br><span class="line"><span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">  list: &#123;</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    type: <span class="string">'number'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  limit: [</span><br><span class="line">    &#123;</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      message: <span class="string">'数量必填'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      validator(r, v, cb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'数量不能小于 100'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cb();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> validator = <span class="keyword">new</span> Schema(descriptor);</span><br><span class="line">validator.validate(</span><br><span class="line">  &#123; <span class="attr">list</span>: <span class="string">'12'</span>, <span class="attr">limit</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">firstFields</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  (errors, fields) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'错误列表'</span>, errors);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>我们需要定义 <code>descriptor</code> ，也就是我们在 <code>element</code> 中定义的 <code>rules</code> ，然后创建一个 <code>Schema</code> 对象。</p><p>最后调用 <code>validate</code> 函数，传递三个参数：</p><p>第一个参数是要校验的对象</p><p>第二个参数是 <code>options</code> 对象， <code>firstFields</code> 为 <code>true</code> ，表示同一个字段如果有多个校验规则，一旦出现校验不通过的规则后边的规则就不执行了。</p><p>还可以设置 <code>first</code> 为 <code>true</code>，这个是针对整个校验对象的，如果某个字段校验不通过，那么后边所有的字段就不再校验了。</p><p>第三个参数是校验结束后的回调函数，<code>erros</code> 保存了所有校验失败的字段以及 <code>message</code> 信息。</p><p>因此，上边代码的输出如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220519081546339.png" alt="image-20220519081546339"></p><p><code>list</code> 对应结果的 <code>message</code> 是默认为我们添加的，<code>limit</code> 对应结果的 <code>message</code> 是我们自己设置的，会覆盖默认的 <code>message</code>。</p><p>因为我们设置了 <code>firstFields</code> 为 <code>true</code> ，所以只校验了 <code>limit</code> 的第一个规则，第二个规则就没有走到。</p><p>我们给 <code>limit</code> 设置一个值，让它走到第二个校验规则。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">validator.validate(</span><br><span class="line">  &#123; <span class="attr">list</span>: <span class="string">'12'</span>, <span class="attr">limit</span>: <span class="number">3</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">firstFields</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  (errors, fields) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'错误列表'</span>, errors);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>输出如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220519081840212.png" alt="image-20220519081840212"></p><p>此时 <code>limit</code> 对应结果就是一个 <code>Error</code> 对象了，<code>Error</code> 对象除了本身的 <code>message</code> 属性，默认还为我们添加了 <code>field</code> 和 <code>filedValue</code> 属性。</p><h1 id="预处理-descriptor"><a href="#预处理-descriptor" class="headerlink" title="预处理 descriptor"></a>预处理 descriptor</h1><p>校验前  <code>async-validator</code>  会将传入的 <code>descriptor</code> 规范化。</p><p>我们传进入的是下边的样子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">  list: &#123;</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    type: <span class="string">'number'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  limit: [</span><br><span class="line">    &#123;</span><br><span class="line">      required: <span class="literal">true</span>,</span><br><span class="line">      message: <span class="string">'数量必填'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      validator(r, v, cb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'数量不能小于 100'</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cb();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>预处理后会变成下边的样子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  list: [</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        type: <span class="string">'number'</span>,</span><br><span class="line">        field: <span class="string">'list'</span>,</span><br><span class="line">        fullField: <span class="string">'list'</span>,</span><br><span class="line">        validator: <span class="function">(<span class="params">rule, value, callback, source, options</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> errors = [];</span><br><span class="line">          <span class="keyword">const</span> validate =</span><br><span class="line">            rule.required ||</span><br><span class="line">            (!rule.required &amp;&amp; source.hasOwnProperty(rule.field));</span><br><span class="line">          <span class="keyword">if</span> (validate) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value === <span class="string">''</span>) &#123;</span><br><span class="line">              value = <span class="literal">undefined</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isEmptyValue(value) &amp;&amp; !rule.required) &#123;</span><br><span class="line">              <span class="keyword">return</span> callback();</span><br><span class="line">            &#125;</span><br><span class="line">            rules.required(rule, value, source, errors, options);</span><br><span class="line">            <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">              rules.type(rule, value, source, errors, options);</span><br><span class="line">              rules.range(rule, value, source, errors, options);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          callback(errors);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="string">'12'</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'list'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  limit: [</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        message: <span class="string">'数量必填'</span>,</span><br><span class="line">        field: <span class="string">'limit'</span>,</span><br><span class="line">        fullField: <span class="string">'limit'</span>,</span><br><span class="line">        type: <span class="string">'string'</span>,</span><br><span class="line">        validator: <span class="function">(<span class="params">rule, value, callback, source, options</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> errors = [];</span><br><span class="line">          <span class="keyword">const</span> type = <span class="built_in">Array</span>.isArray(value) ? <span class="string">'array'</span> : <span class="keyword">typeof</span> value;</span><br><span class="line">          rules.required(rule, value, source, errors, options, type);</span><br><span class="line">          callback(errors);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="number">3</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'limit'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        field: <span class="string">'limit'</span>,</span><br><span class="line">        fullField: <span class="string">'limit'</span>,</span><br><span class="line">        type: <span class="string">'string'</span>,</span><br><span class="line">        validator(r, v, cb) &#123;</span><br><span class="line">          <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'数量不能小于 100'</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          cb();</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="number">3</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'limit'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>主要做了三件事情：</p><ol><li>把每个字段的校验规则统一成了一个数组对象</li><li>把原本的校验对象放到了 <code>rule</code> 属性中，并且添加了 <code>value</code>、<code>source</code>、<code>field</code> 属性</li><li>根据 <code>required</code> 和 <code>type</code> 补充了默认的 <code>validator</code> 校验函数</li></ol><h1 id="预处理-descriptor-对应的源码"><a href="#预处理-descriptor-对应的源码" class="headerlink" title="预处理 descriptor 对应的源码"></a>预处理 descriptor 对应的源码</h1><p>让我们过一下这部分源码。</p><p>在构造函数中，把 <code>descriptor</code> 所有字段的 <code>rule</code> 转为了数组，保存到 <code>rules</code> 对象中。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(descriptor: Rules) &#123;</span><br><span class="line">  <span class="keyword">this</span>.define(descriptor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define(rules: Rules) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!rules) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Cannot configure a schema with no rules'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rules !== <span class="string">'object'</span> || <span class="built_in">Array</span>.isArray(rules)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Rules must be an object'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.rules = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(rules).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> item: Rule = rules[name];</span><br><span class="line">    <span class="keyword">this</span>.rules[name] = <span class="built_in">Array</span>.isArray(item) ? item : [item];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>剩下的处理都在 <code>validate</code> 函数中了，可以跟随下边的注释看一下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> validate(source_: Values, <span class="attr">o</span>: any = &#123;&#125;, <span class="attr">oc</span>: any = <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;): <span class="built_in">Promise</span>&lt;Values&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> source: Values = source_;</span><br><span class="line">    <span class="keyword">let</span> options: ValidateOption = o;</span><br><span class="line">    <span class="keyword">let</span> callback: ValidateCallback = oc;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">'function'</span>) &#123;</span><br><span class="line">      callback = options;</span><br><span class="line">      options = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    function complete(results: (ValidateError | ValidateError[])[]) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> series: Record&lt;string, RuleValuePackage[]&gt; = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> keys = options.keys || <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.rules); <span class="comment">// 得到所有的要校验的 key</span></span><br><span class="line">    keys.forEach(<span class="function"><span class="params">z</span> =&gt;</span> &#123; <span class="comment">// 遍历所有字段</span></span><br><span class="line">      <span class="keyword">const</span> arr = <span class="keyword">this</span>.rules[z];</span><br><span class="line">      <span class="keyword">let</span> value = source[z];</span><br><span class="line">      arr.forEach(<span class="function"><span class="params">r</span> =&gt;</span> &#123; <span class="comment">// 遍历每个字段的所有 rule</span></span><br><span class="line">        <span class="keyword">let</span> rule: InternalRuleItem = r;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// 如果是函数，放到 validator 属性中</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> rule === <span class="string">'function'</span>) &#123;</span><br><span class="line">          rule = &#123;</span><br><span class="line">            validator: rule,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          rule = &#123; ...rule &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填充 validator 属性</span></span><br><span class="line">        rule.validator = <span class="keyword">this</span>.getValidationMethod(rule);</span><br><span class="line">        <span class="keyword">if</span> (!rule.validator) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填充其他属性</span></span><br><span class="line">        rule.field = z;</span><br><span class="line">        rule.fullField = rule.fullField || z;</span><br><span class="line">        rule.type = <span class="keyword">this</span>.getType(rule);</span><br><span class="line">        series[z] = series[z] || [];</span><br><span class="line">        <span class="comment">// 保存到 series 中</span></span><br><span class="line">        series[z].push(&#123;</span><br><span class="line">          rule,</span><br><span class="line">          value,</span><br><span class="line">          source,</span><br><span class="line">          field: z,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> errorFields = &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看下上边的 <code>getValidationMethod</code> 方法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">getValidationMethod(rule: InternalRuleItem) &#123;</span><br><span class="line">  <span class="comment">// 如果用户自定了，直接返回自定义的</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rule.validator === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> rule.validator;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(rule);</span><br><span class="line">  <span class="keyword">const</span> messageIndex = keys.indexOf(<span class="string">'message'</span>);</span><br><span class="line">  <span class="keyword">if</span> (messageIndex !== <span class="number">-1</span>) &#123;</span><br><span class="line">    keys.splice(messageIndex, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果只有一个 required 字段，返回 required 的校验函数</span></span><br><span class="line">  <span class="keyword">if</span> (keys.length === <span class="number">1</span> &amp;&amp; keys[<span class="number">0</span>] === <span class="string">'required'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> validators.required;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 否则的根据 type 去返回校验函数</span></span><br><span class="line">  <span class="keyword">return</span> validators[<span class="keyword">this</span>.getType(rule)] || <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所有的校验函数都是提前定义好的：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220519094003441.png" alt="image-20220519094003441"></p><p>在 <a href="https://pattern.windliang.wang/posts/%E5%89%8D%E7%AB%AF%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%B3%BB%E5%88%97-%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.html" target="_blank" rel="noopener">前端的设计模式中-策略模式</a> 中我们也提到过上边的逻辑。</p><h1 id="循环校验"><a href="#循环校验" class="headerlink" title="循环校验"></a>循环校验</h1><p>当我们有了预处理好的所有字段的校验规则。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> series = &#123;</span><br><span class="line">  list: [</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        type: <span class="string">'number'</span>,</span><br><span class="line">        field: <span class="string">'list'</span>,</span><br><span class="line">        fullField: <span class="string">'list'</span>,</span><br><span class="line">        validator: <span class="function">(<span class="params">rule, value, callback, source, options</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> errors = [];</span><br><span class="line">          <span class="keyword">const</span> validate =</span><br><span class="line">            rule.required ||</span><br><span class="line">            (!rule.required &amp;&amp; source.hasOwnProperty(rule.field));</span><br><span class="line">          <span class="keyword">if</span> (validate) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value === <span class="string">''</span>) &#123;</span><br><span class="line">              value = <span class="literal">undefined</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isEmptyValue(value) &amp;&amp; !rule.required) &#123;</span><br><span class="line">              <span class="keyword">return</span> callback();</span><br><span class="line">            &#125;</span><br><span class="line">            rules.required(rule, value, source, errors, options);</span><br><span class="line">            <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">              rules.type(rule, value, source, errors, options);</span><br><span class="line">              rules.range(rule, value, source, errors, options);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          callback(errors);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="string">'12'</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'list'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  limit: [</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        message: <span class="string">'数量必填'</span>,</span><br><span class="line">        field: <span class="string">'limit'</span>,</span><br><span class="line">        fullField: <span class="string">'limit'</span>,</span><br><span class="line">        type: <span class="string">'string'</span>,</span><br><span class="line">        validator: <span class="function">(<span class="params">rule, value, callback, source, options</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> errors = [];</span><br><span class="line">          <span class="keyword">const</span> type = <span class="built_in">Array</span>.isArray(value) ? <span class="string">'array'</span> : <span class="keyword">typeof</span> value;</span><br><span class="line">          rules.required(rule, value, source, errors, options, type);</span><br><span class="line">          callback(errors);</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="number">3</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'limit'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      rule: &#123;</span><br><span class="line">        field: <span class="string">'limit'</span>,</span><br><span class="line">        fullField: <span class="string">'limit'</span>,</span><br><span class="line">        type: <span class="string">'string'</span>,</span><br><span class="line">        validator(r, v, cb) &#123;</span><br><span class="line">          <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'数量不能小于 100'</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          cb();</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      value: <span class="number">3</span>,</span><br><span class="line">      source: &#123;</span><br><span class="line">        list: <span class="string">'12'</span>,</span><br><span class="line">        limit: <span class="number">3</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      field: <span class="string">'limit'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>接下来只需要搞一个双重循环，执行所有的字段和每个字段的所有校验函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> field <span class="keyword">of</span> <span class="built_in">Object</span>.keys(series)) &#123; <span class="comment">// 遍历每一个字段</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> data <span class="keyword">of</span> series[field]) &#123; <span class="comment">// 每一个规则</span></span><br><span class="line">    <span class="keyword">const</span> rule = data.rule;</span><br><span class="line">    <span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rule</code> 、<code>data.value</code>、<code>data.source</code> 就是当前规则相关的变量，<code>options</code> 是最开始调用校验的时候传进来的 <code>{ firstFields: true },</code>，那么 <code>cb</code> 是什么？</p><p><code>cb</code> 函数接受一个错误数据列表，如果返回的不是数组会包装为数组，然后对错误进行填充。</p><p>最后调用 <code>doIt</code> 函数，将校验结果传入，后边会介绍这个方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cb</span>(<span class="params">e = []</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> errorList = <span class="built_in">Array</span>.isArray(e) ? e : [e];</span><br><span class="line">  <span class="keyword">if</span> (errorList.length &amp;&amp; rule.message !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    errorList = [].concat(rule.message); <span class="comment">// 错误列表优先使用 message 字段</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Fill error info</span></span><br><span class="line">  <span class="keyword">let</span> filledErrors = errorList.map(complementError(rule, source));</span><br><span class="line">  doIt(filledErrors); <span class="comment">// 将当前字段的错误列表保存起来</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>complementError</code> 会返回一个函数，将错误列表进行填充，主要就是补充了 <code>field</code> 和 <code>fieldValue</code> 属性。 </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">complementError</span>(<span class="params">rule: InternalRuleItem, source: Values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">oe: ValidateError | ((</span>) =&gt;</span> string) | string): <span class="function"><span class="params">ValidateError</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> fieldValue;</span><br><span class="line">    <span class="keyword">if</span> (rule.fullFields) &#123;</span><br><span class="line">      fieldValue = getValue(source, rule.fullFields);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fieldValue = source[(oe <span class="keyword">as</span> any).field || rule.fullField];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isErrorObj(oe)) &#123;</span><br><span class="line">      oe.field = oe.field || rule.fullField;</span><br><span class="line">      oe.fieldValue = fieldValue;</span><br><span class="line">      <span class="keyword">return</span> oe;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      message: <span class="keyword">typeof</span> oe === <span class="string">'function'</span> ? oe() : oe,</span><br><span class="line">      fieldValue,</span><br><span class="line">      field: ((oe <span class="keyword">as</span> unknown) <span class="keyword">as</span> ValidateError).field || rule.fullField,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>收到的错误列表分为两种情况：</p><p>处理前如果 <code>cb</code> 收到的是 <code>Error</code> 列表，比如这样调用 <code>cb(new Error(&#39;数量不能小于 100&#39;));</code> 。</p><p>那么处理前是下图：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521082112809.png" alt="image-20220521082112809"></p><p>处理后，就会往 <code>Error</code> 对象中塞入 <code>field</code> 和 <code>fieldValue</code> 属性。 </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521082219018.png" alt="image-20220521082219018"></p><p>处理前如果<code>cb</code> 是字符串列表，比如这样调用 <code>cb([&#39;list is required&#39;, &#39;list is not a number&#39;])</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521082345013.png" alt="image-20220521082345013"></p><p>同样的，处理后也是塞入 <code>field</code> 和 <code>fieldValue</code> 属性。 </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521082457313.png" alt="image-20220521082457313"></p><p>再回到我们的双重循环中。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> field <span class="keyword">of</span> <span class="built_in">Object</span>.keys(series)) &#123; <span class="comment">// 遍历每一个字段</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> data <span class="keyword">of</span> series[field]) &#123; <span class="comment">// 每一个规则</span></span><br><span class="line">    <span class="keyword">const</span> rule = data.rule;</span><br><span class="line">    <span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>validator</code> 函数就是我们自己定义的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validator(r, v, cb) &#123;</span><br><span class="line">  <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'数量不能小于 100'</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  cb();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>由于 <code>Element</code> 官方示例是上边的样子，所以我们一般都按照上边的样子写，但其实我们也可以不调用 <code>cb</code> 函数，而是仅仅 <code>return</code> 字符串数组，或者 <code>boolean</code> 值，调用 <code>cb</code> 函数交给双重循环。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validator(r, v, cb) &#123;</span><br><span class="line">  <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'数量不能小于 100'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>双重循环中来处理 <code>validator</code> 的返回值去调用 <code>cb</code> 函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> field <span class="keyword">of</span> <span class="built_in">Object</span>.keys(series)) &#123; <span class="comment">// 遍历每一个字段</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">const</span> data <span class="keyword">of</span> series[field]) &#123; <span class="comment">// 每一个规则</span></span><br><span class="line">    <span class="keyword">const</span> rule = data.rule;</span><br><span class="line">    <span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">    <span class="comment">// 根据返回的结果，去调用 cb 函数</span></span><br><span class="line">    <span class="keyword">if</span> (res === <span class="literal">true</span>) &#123;</span><br><span class="line">      cb();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res === <span class="literal">false</span>) &#123;</span><br><span class="line">      cb(</span><br><span class="line">        <span class="keyword">typeof</span> rule.message === <span class="string">'function'</span></span><br><span class="line">        ? rule.message(rule.fullField || rule.field)</span><br><span class="line">        : rule.message || <span class="string">`<span class="subst">$&#123;rule.fullField || rule.field&#125;</span> fails`</span>,</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">      cb(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">      cb(res.message);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="asyncMap"><a href="#asyncMap" class="headerlink" title="asyncMap"></a>asyncMap</h1><p>向上边我们直接粗暴的写双重循环去依次校验也没有问题，但因为校验库还支持一些参数，比如前边介绍的：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521083746778.png" alt="image-20220521083746778"></p><p>如果是 <code>for</code> 循环中去处理 <code>firstFields</code> 和 <code>first</code> 的逻辑，就过于耦合了，未来再扩充其他逻辑，双重循环中的逻辑就会越来越复杂。</p><p> <code>async-validator</code>  的处理方式在这里就比较优雅了，实现了 <code>asyncMap</code> 方法，作用就是遍历 <code>series</code> 数组，并且处理了 <code>firstFields</code> 和 <code>first</code> 参数的逻辑。</p><p>下边来分析一下实现：</p><p>看一下 <code>asyncMap</code> 的入口参数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncMap</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  objArr: Record&lt;string, RuleValuePackage[]&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  option: ValidateOption,</span></span></span><br><span class="line"><span class="function"><span class="params">  func: ValidateFunc,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: (errors: ValidateError[]</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">source</span>: <span class="title">Values</span>,</span></span><br><span class="line"><span class="function">)</span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接受 <code>5</code> 个参数：</p><p><code>objArr</code>：要遍历的 <code>rule</code> 规则，就是我们前边生成的 <code>series</code> 数组，即双重循环遍历的对象。</p><p><code>option</code> ：最开始传入的 <code>option</code>，可能包含 <code>firstFields</code> 和 <code>first</code> 属性。</p><p><code>func</code>：遍历过程的中会调用这个函数，会传入当前遍历的 <code>rule</code> 和一个 <code>doIt</code> 函数，<code>doIt</code> 函数需要接收处理好的校验结果。这里就需要我们之前 <code>for</code> 循环内部的处理逻辑。</p><p><code>callback</code> : 全部检验结束后调用，会传入所有的校验结果。</p><p><code>source</code>：要校验的对象。</p><p>这样我们就可以把 <code>for</code> 循环改为直接调用 <code>asyncMap</code> 函数了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">asyncMap(</span><br><span class="line">  series,</span><br><span class="line">  options,</span><br><span class="line">  (data, doIt) =&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;,</span><br><span class="line">  results =&gt; &#123;</span><br><span class="line">    complete(results);</span><br><span class="line">  &#125;,</span><br><span class="line">  source,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>第三个参数就是需要我们去处理 <code>data</code> 这个校验规则，也就是之前 <code>for</code> 循环中的逻辑移动过来。</p><p>其中 <code>doIt</code> 函数我们在之前讲的 <code>cb</code> 函数中调用即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(data, doIt) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> rule = data.rule;</span><br><span class="line">  rule.field = data.field;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">cb</span>(<span class="params">e: SyncErrorType | SyncErrorType[] = []</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> errorList = <span class="built_in">Array</span>.isArray(e) ? e : [e];</span><br><span class="line">    <span class="keyword">if</span> (errorList.length &amp;&amp; rule.message !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      errorList = [].concat(rule.message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Fill error info</span></span><br><span class="line">    <span class="keyword">let</span> filledErrors = errorList.map(complementError(rule, source));</span><br><span class="line">    doIt(filledErrors); <span class="comment">// 将当前字段的错误列表保存起来</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/******** for 循环中的逻辑 *****************/</span></span><br><span class="line">  <span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">  <span class="keyword">if</span> (res === <span class="literal">true</span>) &#123;</span><br><span class="line">    cb();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res === <span class="literal">false</span>) &#123;</span><br><span class="line">    cb(</span><br><span class="line">      <span class="keyword">typeof</span> rule.message === <span class="string">'function'</span></span><br><span class="line">      ? rule.message(rule.fullField || rule.field)</span><br><span class="line">      : rule.message || <span class="string">`<span class="subst">$&#123;rule.fullField || rule.field&#125;</span> fails`</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    cb(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">    cb(res.message);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/***************************************/</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>最后就是全部遍历结束后的 <code>complete</code> 函数，我们只需要把 <code>results</code> 列表传到外边即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complete</span>(<span class="params">results</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> fields: ValidateFieldsError = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (!results.length) &#123;</span><br><span class="line">    callback(<span class="literal">null</span>, source);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fields = convertFieldsError(results);</span><br><span class="line">    callback (results, fields);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上边的 <code>callback</code> 函数就是我们调用校验函数时候外部传入的：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validator = <span class="keyword">new</span> Schema(descriptor);</span><br><span class="line">validator.validate(</span><br><span class="line">  &#123; <span class="attr">list</span>: <span class="string">'12'</span>, <span class="attr">limit</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">firstFields</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  <span class="comment">//***** 上边的 callback ********************/</span></span><br><span class="line">  (errors, fields) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'错误列表'</span>, errors);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//*********************************************/</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h1 id="内层循环"><a href="#内层循环" class="headerlink" title="内层循环"></a>内层循环</h1><p>双重循环的的外层是遍历所有字段，内层是遍历该字段的所有规则。</p><p>我们来先看一下内层循环的实现：</p><p> <code>async-validator</code>  库提供了 <code>asyncParallelArray</code> 方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncParallelArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  arr: RuleValuePackage[],</span></span></span><br><span class="line"><span class="function"><span class="params">  func: ValidateFunc,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: (errors: ValidateError[]</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> results: ValidateError[] = [];</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> arrLength = arr.length;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params">errors: ValidateError[]</span>) </span>&#123;</span><br><span class="line">    results.push(...(errors || []));</span><br><span class="line">    total++;</span><br><span class="line">    <span class="keyword">if</span> (total === arrLength) &#123;</span><br><span class="line">      callback(results);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  arr.forEach(<span class="function"><span class="params">a</span> =&gt;</span> &#123;</span><br><span class="line">    func(a, count);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接受三个参数：</p><p><code>arr</code> 就是当前字段要遍历的规则列表。</p><p><code>func</code> 是处理 <code>rule</code> 规则的函数，内部会调用这里的 <code>count</code> 方法，接受当前 <code>a</code> 的校验结果。</p><p>传入的 <code>func</code> 其实就是我们前边介绍过的 <code>for</code> 循环内部逻辑，<code>a</code> 是下边的 <code>data</code> 参数，<code>count</code> 就是下边的 <code>doIt</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">(data, doIt) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> rule = data.rule;</span><br><span class="line">  rule.field = data.field;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">cb</span>(<span class="params">e: SyncErrorType | SyncErrorType[] = []</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> errorList = <span class="built_in">Array</span>.isArray(e) ? e : [e];</span><br><span class="line">    <span class="keyword">if</span> (errorList.length &amp;&amp; rule.message !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      errorList = [].concat(rule.message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Fill error info</span></span><br><span class="line">    <span class="keyword">let</span> filledErrors = errorList.map(complementError(rule, source));</span><br><span class="line">    doIt(filledErrors);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">  <span class="keyword">if</span> (res === <span class="literal">true</span>) &#123;</span><br><span class="line">    cb();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res === <span class="literal">false</span>) &#123;</span><br><span class="line">    cb(</span><br><span class="line">      <span class="keyword">typeof</span> rule.message === <span class="string">'function'</span></span><br><span class="line">      ? rule.message(rule.fullField || rule.field)</span><br><span class="line">      : rule.message || <span class="string">`<span class="subst">$&#123;rule.fullField || rule.field&#125;</span> fails`</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    cb(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">    cb(res.message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>第三个参数 <code>callback</code> 是当前 <code>arr</code> 全部校验结束后的回调，代表当前字段的所有校验规则都判断结束。</p><p>这里需要注意的是，我们是通过 <code>count</code> 进入的次数来判断是否去调用 <code>callback</code> 函数，而不是 <code>arr</code> 遍历结束后调用 <code>callback</code>。</p><p>除了 <code>asyncParallelArray</code> 方法，因为有 <code>firstFields</code> 属性的存在，也就是遍历某个字段的所有规则时，如果出现校验不通过的规则就直接结束，后边的规则不再进行判断。</p><p>因此， <code>async-validator</code>  还提供了 <code>asyncSerialArray</code> 方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncSerialArray</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  arr: RuleValuePackage[],</span></span></span><br><span class="line"><span class="function"><span class="params">  func: ValidateFunc,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: (errors: ValidateError[]</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> arrLength = arr.length;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">errors: ValidateError[]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (errors &amp;&amp; errors.length) &#123;</span><br><span class="line">      callback(errors);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> original = index;</span><br><span class="line">    index = index + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (original &lt; arrLength) &#123;</span><br><span class="line">      func(arr[original], next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      callback([]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next([]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>入口参数和 <code>asyncParallelArray</code> 是一致的，区别在于对于 <code>arr</code> 是顺序执行，如果过程中出现了校验不通过的规则，就直接调用 <code>callback</code> 结束。</p><h1 id="外层循环"><a href="#外层循环" class="headerlink" title="外层循环"></a>外层循环</h1><p>外层循环和上边很类似，其实就是遍历所有字段，然后把每个字段的校验列表传给内层循环即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">asyncMap</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  objArr: Record&lt;string, RuleValuePackage[]&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  option: ValidateOption,</span></span></span><br><span class="line"><span class="function"><span class="params">  func: ValidateFunc,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: (errors: ValidateError[]</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">source</span>: <span class="title">Values</span>,</span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> firstFields =</span><br><span class="line">    option.firstFields === <span class="literal">true</span></span><br><span class="line">      ? <span class="built_in">Object</span>.keys(objArr)</span><br><span class="line">      : option.firstFields || [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> objArrKeys = <span class="built_in">Object</span>.keys(objArr);</span><br><span class="line">  <span class="keyword">const</span> objArrLength = objArrKeys.length;</span><br><span class="line">  <span class="keyword">let</span> total = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> results: ValidateError[] = [];</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function">(<span class="params">errors: ValidateError[]</span>) =&gt;</span> &#123;</span><br><span class="line">    results.push.apply(results, errors);</span><br><span class="line">    total++;</span><br><span class="line">    <span class="keyword">if</span> (total === objArrLength) &#123;</span><br><span class="line">      callback(results);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (!objArrKeys.length) &#123;</span><br><span class="line">    callback(results);</span><br><span class="line">  &#125;</span><br><span class="line">  objArrKeys.forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> arr = objArr[key];</span><br><span class="line">    <span class="keyword">if</span> (firstFields.indexOf(key) !== <span class="number">-1</span>) &#123;</span><br><span class="line">      asyncSerialArray(arr, func, next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      asyncParallelArray(arr, func, next);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>入口参数前边已经介绍过了，可以看到我们做的就是遍历 <code>objArrKeys</code> 数组，然后根据 <code>firstFields</code> 的值去调用 <code>asyncSerialArray</code> 和 <code>asyncParallelArray</code> 。内存循环判断结束后会调用上边的 <code>next</code> 方法。</p><p><code>next</code> 同样也是通过进入的次数，来判断是否调用 <code>callback</code> 函数，也就是前边介绍的 <code>complete</code> 方法。</p><p>和内层循环类似，因为有 <code>first</code> 属性的存在，也就是遍历某个字段时，存在校验不通过的字段就直接结束，后边的字段就不再进行判断。</p><p>我们只需要把所有规则打平，然后调用 <code>asyncSerialArray</code> 方法即可。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (option.first) &#123;</span><br><span class="line">  <span class="keyword">const</span> next = <span class="function">(<span class="params">errors: ValidateError[]</span>) =&gt;</span> &#123;</span><br><span class="line">    callback(errors);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> flattenArr = flattenObjArr(objArr);</span><br><span class="line">  asyncSerialArray(flattenArr, func, next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenObjArr</span>(<span class="params">objArr: Record&lt;string, RuleValuePackage[]&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ret: RuleValuePackage[] = [];</span><br><span class="line">  <span class="built_in">Object</span>.keys(objArr).forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">    ret.push(...(objArr[k] || []));</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="代码总"><a href="#代码总" class="headerlink" title="代码总"></a>代码总</h1><p>以上就是  <code>async-validator</code> 源码的主要流程了，说起来也简单，先预处理所有规则，然后通过 <code>asyncMap</code> 方法双层循环遍历所有校验规则即可，这个双层循环的抽离确实很优雅，避免了循环中耦合太多逻辑。</p><p>除了上边介绍的代码，因为 <code>async-validator</code> 还支持 <code>Promise</code> 的调用风格，校验函数支持 <code>Promise</code> 函数等其他功能，大家感兴趣也可以到 <a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">async-validator</a> 看一下更详细的源码。</p><p>值得一提的点是，双层循环是通过计数来判断是否结束的，而进入计数其实就是调用 <code>cb</code> 函数。因此如果我们规则是下边的样子：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Schema <span class="keyword">from</span> <span class="string">'../src/index'</span>;</span><br><span class="line"><span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">  limit: [</span><br><span class="line">    &#123;</span><br><span class="line">      validator(r, v, cb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">          cb(<span class="string">'校验1'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        cb();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      validator(r, v, cb) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v &lt; <span class="number">50</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> cb(<span class="string">'校验2'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        cb();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> validator = <span class="keyword">new</span> Schema(descriptor);</span><br><span class="line">validator.validate(</span><br><span class="line">  &#123; <span class="attr">limit</span>: <span class="number">3</span> &#125;,</span><br><span class="line">  (errors, fields) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (errors) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'错误列表'</span>, errors);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>因为我们没有传递 <code>firstFields</code> 属性，所以我们期望的是将 <code>limit</code> 所有的校验都进行了，<code>limit</code> 的值是 <code>3</code> ，所以两个校验都没通过，应该输出下边的内容：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521103342907.png" alt="image-20220521103342907"></p><p>但其实只进行了第一个的校验：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521103508233.png" alt="image-20220521103508233"></p><p>原因就在于第一个 <code>validator</code> 进行了两次 <code>cb</code> ，然后内层循环的 <code>callback</code> 就提前调用了。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validator(r, v, cb) &#123;</span><br><span class="line">  <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    cb(<span class="string">'校验1'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  cb();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>因此我们最好保证一个 <code>validator</code> 只进行一次 <code>cb</code> ，走到 <code>cb</code> 后就直接 <code>return</code>。（因为 <code>Element</code> 会设置 <code>firstFields</code> 为 <code>true</code>，所以其实有多个 <code>cb</code> 也不影响最终结果）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validator(r, v, cb) &#123;</span><br><span class="line">  <span class="keyword">if</span> (v &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> cb(<span class="string">'校验1'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  cb();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>并且一定要有一个 <code>cb</code> ，不然最终的回调函数永远也不会执行了，这就是为什么 <code>Element</code> 提示我们要进行 <code>cb</code> 。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220521103841307.png" alt="image-20220521103841307"></p><p>但这里说的也不够严谨，我们也可以返回字符串，或者字符串数组、布尔值等， <code>async-validator</code> 内部会根据 <code>validator</code> 返回的结果去调用 <code>cb</code> 函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> res = rule.validator(rule, data.value, cb, data.source, options);</span><br><span class="line">  <span class="keyword">if</span> (res === <span class="literal">true</span>) &#123;</span><br><span class="line">    cb();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res === <span class="literal">false</span>) &#123;</span><br><span class="line">    cb(</span><br><span class="line">      <span class="keyword">typeof</span> rule.message === <span class="string">'function'</span></span><br><span class="line">      ? rule.message(rule.fullField || rule.field)</span><br><span class="line">      : rule.message || <span class="string">`<span class="subst">$&#123;rule.fullField || rule.field&#125;</span> fails`</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">    cb(res);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res <span class="keyword">instanceof</span> <span class="built_in">Error</span>) &#123;</span><br><span class="line">    cb(res.message);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p> <code>async-validator</code>  用计数的方式来判断是否去调用回调，就是为了实现异步的校验，当异步过程结束后才去调用 <code>cb</code> ，代表校验完成。</p><h1 id="其他属性"><a href="#其他属性" class="headerlink" title="其他属性"></a>其他属性</h1><p>平时写代码直接参照前人的校验规则去仿照着写了，大家也基本上是按照 <code>Element</code> 的样例来写校验规则，如果去  <a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">async-validator</a>  看一下的话，会发现一些其他没听过的属性，这里也记录下。</p><p><code>validator</code> 校验函数最多能接收到 <code>5</code> 个参数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">validator(rule, value, callback, source, options) &#123;</span><br><span class="line">  <span class="keyword">const</span> errors = [];</span><br><span class="line">  <span class="comment">// test if email address already exists in a database</span></span><br><span class="line">  <span class="comment">// and add a validation error to the errors array if it does</span></span><br><span class="line">  <span class="keyword">return</span> errors;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>我们可以通过第四个参数 <code>source</code> 拿到整个表单的对象，如果想校验一些联动的逻辑，我们就可以通过 <code>source</code> 拿到其他字段的值。</p><p>对对象字段的校验，如果校验字段是个对象，我们可以通过 <code>fields</code> 来校验对象中的字段。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">  address: &#123;</span><br><span class="line">    type: <span class="string">'object'</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    fields: &#123;</span><br><span class="line">      street: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      city: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      zip: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">len</span>: <span class="number">8</span>, <span class="attr">message</span>: <span class="string">'invalid zip'</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="string">'string'</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> validator = <span class="keyword">new</span> Schema(descriptor);</span><br><span class="line">validator.validate(&#123; <span class="attr">address</span>: &#123;&#125; &#125;, (errors, fields) =&gt; &#123;</span><br><span class="line">  <span class="comment">// errors for address.street, address.city, address.zip</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>transform</code> 函数，可以将值先进行一次转换，然后再进行校验。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="string">'string'</span>,</span><br><span class="line">    required: <span class="literal">true</span>,</span><br><span class="line">    pattern: <span class="regexp">/^[a-z]+$/</span>,</span><br><span class="line">    transform(value) &#123;</span><br><span class="line">      <span class="keyword">return</span> value.trim();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>asyncValidator</code>，校验函数内部是用 <code>Promise</code> 或者直接返回一个 <code>Promise</code>。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fields = &#123;</span><br><span class="line">  asyncField: &#123;</span><br><span class="line">    asyncValidator(rule, value, callback) &#123;</span><br><span class="line">      ajax(&#123;</span><br><span class="line">        url: <span class="string">'xx'</span>,</span><br><span class="line">        value: value,</span><br><span class="line">      &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        callback();</span><br><span class="line">      &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">        callback(<span class="keyword">new</span> <span class="built_in">Error</span>(error));</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  promiseField: &#123;</span><br><span class="line">    asyncValidator(rule, value) &#123;</span><br><span class="line">      <span class="keyword">return</span> ajax(&#123;</span><br><span class="line">        url: <span class="string">'xx'</span>,</span><br><span class="line">        value: value,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>上边就是   <code>async-validator</code>  开源库的核心源码了，希望对你有帮助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;平常开发写 &lt;code&gt;element&lt;/code&gt; 表单的时候，肯定少不了表单的校验，&lt;code&gt;element&lt;/code&gt; 使用的是 &lt;a href=&quot;https://github.com/yiminghe/async-validator&quot; target=&quot;_blan
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="element" scheme="https://windliang.wang/tags/element/"/>
    
  </entry>
  
  <entry>
    <title>echarts 画中国地图及省份切换</title>
    <link href="https://windliang.wang/2022/05/10/echarts%E7%94%BB%E4%B8%AD%E5%9B%BD%E5%9C%B0%E5%9B%BE/"/>
    <id>https://windliang.wang/2022/05/10/echarts%E7%94%BB%E4%B8%AD%E5%9B%BD%E5%9C%B0%E5%9B%BE/</id>
    <published>2022-05-10T00:41:10.000Z</published>
    <updated>2022-11-17T00:01:23.933Z</updated>
    
    <content type="html"><![CDATA[<p>最近用 <code>ehcarts</code> 写了一个有关中国地图的需求，这篇文章来总结下基本的原理和用法。</p><h1 id="Geojson"><a href="#Geojson" class="headerlink" title="Geojson"></a>Geojson</h1><p>首先了解一下 <code>GeoJSON</code> ，看下 <a href="https://zh.wikipedia.org/wiki/GeoJSON" target="_blank" rel="noopener">维基百科</a> 的定义：</p><blockquote><p><strong>GeoJSON </strong>是一种基于 <a href="https://zh.wikipedia.org/wiki/JSON" target="_blank" rel="noopener">JSON</a> 的地理空间数据交换格式，它定义了几种类型 JSON 对象以及它们组合在一起的方法，以表示有关地理要素、属性和它们的空间范围的数据。</p><p>2015年，互联网工程任务组（<a href="https://zh.wikipedia.org/wiki/互联网工程任务组" target="_blank" rel="noopener">IETF</a>）与原始规范作者组建了一个 GeoJSON 工作组，一起规范 GeoJSON 标准。在2016年8月，推出了最新的GeoJSON数据格式标准规范(<a href="https://tools.ietf.org/html/rfc7946" target="_blank" rel="noopener">RFC 7946</a>)。</p><p>GeoJSON 使用唯一地理坐标参考系统 WGS1984 和十进制度单位，一个 GeoJSON 对象可以是 Geometry, Feature 或者FeatureCollection.</p><p>其几何对象包括有点（表示地理位置）、线（表示街道、公路、边界）、<a href="https://zh.wikipedia.org/wiki/多边形" target="_blank" rel="noopener">多边形</a>（表示国家、省、领土），以及由以上类型组合成的复合几何图形。</p></blockquote><p>简单说就是通过坐标系来描述点、线、面，看几个例子就明白它们是什么了。</p><p>单个点：<code>&quot;type&quot;: &quot;Point&quot;</code> </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510095405517.png" alt="image-20220510095405517"></p><p>多个点，<code>&quot;type&quot;: &quot;MultiPoint&quot;</code> </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510095158715.png" alt="image-20220510095158715"></p><p>多个线：<code>&quot;type&quot;: &quot;MultiLineString&quot;</code> </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510095241321.png" alt="image-20220510095241321"></p><p>多个面：<code>&quot;type&quot;: &quot;MultiPolygon&quot;</code> </p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510095257874.png" alt="image-20220510095257874"></p><h1 id="地图-Geojson"><a href="#地图-Geojson" class="headerlink" title="地图 Geojson"></a>地图 Geojson</h1><p> 中国地图和省份的 <code>geoJson</code> 可以在 <a href="https://github.com/echarts-maps" target="_blank" rel="noopener">echarts-map</a> 或者阿里的 <a href="https://datav.aliyun.com/portal/school/atlas/area_selector" target="_blank" rel="noopener">数据可视化中心</a> 进行下载。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510101045037.png" alt="image-20220510101045037"></p><p><code>echarts 4.x</code> 的版本自带了一些 <code>Geojson</code> 的数据，在 <code>node_modules/echarts/map/json</code> 目录，但可能考虑到一些省区数据不能及时更新，<code>echarts 5</code> 版本就没有自带数据了。</p><p>让我们看一下全国地图中山西省的 <code>geoJson</code> 长什么样子。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"FeatureCollection"</span>,</span><br><span class="line">    <span class="attr">"features"</span>: [</span><br><span class="line">      ...</span><br><span class="line">        &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"Feature"</span>,</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"adcode"</span>: <span class="number">140000</span>,</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"山西省"</span>,</span><br><span class="line">                <span class="attr">"center"</span>: [<span class="number">112.549248</span>, <span class="number">37.857014</span>],</span><br><span class="line">                <span class="attr">"centroid"</span>: [<span class="number">112.304436</span>, <span class="number">37.618179</span>],</span><br><span class="line">                <span class="attr">"childrenNum"</span>: <span class="number">11</span>,</span><br><span class="line">                <span class="attr">"level"</span>: <span class="string">"province"</span>,</span><br><span class="line">                <span class="attr">"parent"</span>: &#123; <span class="attr">"adcode"</span>: <span class="number">100000</span> &#125;,</span><br><span class="line">                <span class="attr">"subFeatureIndex"</span>: <span class="number">3</span>,</span><br><span class="line">                <span class="attr">"acroutes"</span>: [<span class="number">100000</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"geometry"</span>: &#123;</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"MultiPolygon"</span>,</span><br><span class="line">                <span class="attr">"coordinates"</span>: [</span><br><span class="line">                    [</span><br><span class="line">                        [</span><br><span class="line">                            [<span class="number">110.379257</span>, <span class="number">34.600612</span>],</span><br><span class="line">                            [<span class="number">110.424837</span>, <span class="number">34.588295</span>],</span><br><span class="line">                            [<span class="number">110.488279</span>, <span class="number">34.610956</span>],</span><br><span class="line">                            [<span class="number">110.533242</span>, <span class="number">34.583368</span>],</span><br><span class="line">                            [<span class="number">110.610851</span>, <span class="number">34.607508</span>],</span><br><span class="line">                            [<span class="number">110.710017</span>, <span class="number">34.605045</span>],</span><br><span class="line">                            [<span class="number">110.749437</span>, <span class="number">34.65232</span>],</span><br><span class="line">                            [<span class="number">110.791937</span>, <span class="number">34.649858</span>],</span><br><span class="line">                            [<span class="number">110.824582</span>, <span class="number">34.615881</span>],</span><br><span class="line">                            [<span class="number">110.883712</span>, <span class="number">34.64395</span>],</span><br><span class="line">                            [<span class="number">110.903422</span>, <span class="number">34.669056</span>],</span><br><span class="line">                            [<span class="number">110.920052</span>, <span class="number">34.730068</span>],</span><br><span class="line">                            ...</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">&#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整体是一个 <code>&quot;type&quot;: &quot;FeatureCollection&quot;</code> ，然后有一个 <code>features</code> 数组保存所有省份，每一个都是 <code>&quot;type&quot;: &quot;Feature&quot;</code> ，代表单个省份。包含 <code>properties</code> 属性和 <code>geometry</code> 属性。<code>geometry</code> 属性就是所有的坐标信息。</p><p>根据坐标信息，计算最大值和最小值的差值，按比例映射到 <code>canvas</code> 上的坐标，然后就可以画出来了，细节的话可以参考 <a href="https://www.bilibili.com/video/BV13V411J7kg/" target="_blank" rel="noopener">b 站</a> 的这个视频。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220510102224426.png" alt="image-20220510102224426" style="width:30%;"></p><h1 id="echarts-画地图"><a href="#echarts-画地图" class="headerlink" title="echarts 画地图"></a>echarts 画地图</h1><p>安装 <code>vue</code> 和 <code>echarts</code> ，先来个简单的正方形。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"FeatureCollection"</span>,</span><br><span class="line">    <span class="attr">"features"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"Feature"</span>,</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"name"</span>: <span class="string">"正方形"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"geometry"</span>: &#123;</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"MultiPolygon"</span>,</span><br><span class="line">                <span class="attr">"coordinates"</span>: [</span><br><span class="line">                    [</span><br><span class="line">                        [</span><br><span class="line">                            [<span class="number">100.0</span>, <span class="number">0.0</span>],</span><br><span class="line">                            [<span class="number">101.0</span>, <span class="number">0.0</span>],</span><br><span class="line">                            [<span class="number">101.0</span>, <span class="number">1.0</span>],</span><br><span class="line">                            [<span class="number">100.0</span>, <span class="number">1.0</span>],</span><br><span class="line">                            [<span class="number">100.0</span>, <span class="number">0.0</span>]</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后用 <code>echarts</code> 做引入我们的 <code>json</code> 文件、通过 <code>echarts.registerMap</code> 注册 <code>json</code> 文件、设置 <code>opitons</code> 的<code>series</code> 属性。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div id=<span class="string">"main"</span> style=<span class="string">"width: 600px; height: 600px"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">import * as echarts from "echarts";</span></span><br><span class="line"><span class="regexp">import test from '../</span>data/test<span class="string">'</span></span><br><span class="line"><span class="string">export default &#123;</span></span><br><span class="line"><span class="string">    name: "HelloWorld",</span></span><br><span class="line"><span class="string">    props: &#123;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    mounted() &#123;</span></span><br><span class="line"><span class="string">        var myChart = echarts.init(document.getElementById("main"));</span></span><br><span class="line"><span class="string">        echarts.registerMap('</span>mapName<span class="string">', test); // 注册地图</span></span><br><span class="line"><span class="string">        let option = &#123;</span></span><br><span class="line"><span class="string">            series: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    type: "map",</span></span><br><span class="line"><span class="string">                    map: '</span>mapName<span class="string">', // 引入地图数据</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">        &#125;;</span></span><br><span class="line"><span class="string">        myChart.setOption(option);</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;!-- Add "scoped" attribute to limit CSS to this component only --&gt;</span></span><br><span class="line"><span class="string">&lt;style scoped&gt;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220511080857038.png" alt="image-20220511080857038"></p><p>然后我们只需要到阿里的 <a href="https://datav.aliyun.com/portal/school/atlas/area_selector" target="_blank" rel="noopener">数据可视化中心</a> 把中国地图的 <code>Geojson</code> 数据下载下来，替换上边的 <code>test.json</code> 即可。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220511081044461.png" alt="image-20220511081044461" style="width:50%;"></p><p>值得注意的是，如果我们设置注册的名字为 <code>china</code> ，<code>echarts</code> 会自动给我们加上南沙群岛的放大图：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> echarts <span class="keyword">from</span> <span class="string">"echarts"</span>;</span><br><span class="line"><span class="keyword">import</span> china <span class="keyword">from</span> <span class="string">'../data/china'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">"HelloWorld"</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line">        <span class="keyword">var</span> myChart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>));</span><br><span class="line">        echarts.registerMap(<span class="string">'china'</span>, china);</span><br><span class="line">        <span class="keyword">let</span> option = &#123;</span><br><span class="line">            series: [</span><br><span class="line">                &#123;</span><br><span class="line">                    type: <span class="string">"map"</span>,</span><br><span class="line">                    map: <span class="string">'china'</span>, <span class="comment">// 引入地图数据</span></span><br><span class="line">                &#125;,</span><br><span class="line">            ],</span><br><span class="line">        &#125;;</span><br><span class="line">        myChart.setOption(option);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220511082046489.png" alt="image-20220511082046489" style="zoom:50%;"></p><h1 id="可能会用到的-options-属性"><a href="#可能会用到的-options-属性" class="headerlink" title="可能会用到的 options 属性"></a>可能会用到的 options 属性</h1><p>地图画出来以后，接下来可以照着 <a href="https://echarts.apache.org/zh/option.html#geo" target="_blank" rel="noopener">echarts 官网</a> 变身为「<code>echarts</code> 配置工程师」了，记得注意一下自己当前的 <code>eharts</code> 版本。</p><h2 id="设置悬浮上的数据"><a href="#设置悬浮上的数据" class="headerlink" title="设置悬浮上的数据"></a>设置悬浮上的数据</h2><p>我们在 <code>series</code> 中引入 <code>data</code> ，加一点随机数据，其中 <code>name</code> 值是 <code>json</code> 数据中的 <code>properties</code> 对应的 <code>name</code> ，名字一定要一致。</p> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> option = &#123;</span><br><span class="line">  ...</span><br><span class="line">  series: [</span><br><span class="line">    &#123;</span><br><span class="line">      type: <span class="string">"map"</span>,</span><br><span class="line">      map: <span class="string">"china"</span>, <span class="comment">// 引入地图数据</span></span><br><span class="line">      name: <span class="string">"省份随机数据"</span>,</span><br><span class="line">      data: [</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"北京市"</span>,</span><br><span class="line">          value: <span class="number">21</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"天津市"</span>,</span><br><span class="line">          value: <span class="number">12</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"上海市"</span>,</span><br><span class="line">          value: <span class="number">99</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"重庆市"</span>,</span><br><span class="line">          value: <span class="number">98</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"河北省"</span>,</span><br><span class="line">          value: <span class="number">99</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"河南省"</span>,</span><br><span class="line">          value: <span class="number">29</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"云南省"</span>,</span><br><span class="line">          value: <span class="number">79</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"辽宁省"</span>,</span><br><span class="line">          value: <span class="number">38</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"黑龙江省"</span>,</span><br><span class="line">          value: <span class="number">4</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"湖南省"</span>,</span><br><span class="line">          value: <span class="number">32</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"安徽省"</span>,</span><br><span class="line">          value: <span class="number">84</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"山东省"</span>,</span><br><span class="line">          value: <span class="number">72</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"新疆维吾尔自治区"</span>,</span><br><span class="line">          value: <span class="number">99</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"江苏省"</span>,</span><br><span class="line">          value: <span class="number">70</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"浙江省"</span>,</span><br><span class="line">          value: <span class="number">85</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"江西省"</span>,</span><br><span class="line">          value: <span class="number">11</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"湖北省"</span>,</span><br><span class="line">          value: <span class="number">62</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"广西壮族自治区"</span>,</span><br><span class="line">          value: <span class="number">13</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"甘肃省"</span>,</span><br><span class="line">          value: <span class="number">74</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"山西省"</span>,</span><br><span class="line">          value: <span class="number">78</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"内蒙古自治区"</span>,</span><br><span class="line">          value: <span class="number">74</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"陕西省"</span>,</span><br><span class="line">          value: <span class="number">40</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"吉林省"</span>,</span><br><span class="line">          value: <span class="number">9</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"福建省"</span>,</span><br><span class="line">          value: <span class="number">90</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"贵州省"</span>,</span><br><span class="line">          value: <span class="number">57</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"广东省"</span>,</span><br><span class="line">          value: <span class="number">6</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"青海省"</span>,</span><br><span class="line">          value: <span class="number">52</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"西藏自治区"</span>,</span><br><span class="line">          value: <span class="number">10</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"四川省"</span>,</span><br><span class="line">          value: <span class="number">98</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"宁夏回族自治区"</span>,</span><br><span class="line">          value: <span class="number">11</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"海南省"</span>,</span><br><span class="line">          value: <span class="number">25</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"台湾省"</span>,</span><br><span class="line">          value: <span class="number">86</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"香港特别行政区"</span>,</span><br><span class="line">          value: <span class="number">8</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          name: <span class="string">"澳门特别行政区"</span>,</span><br><span class="line">          value: <span class="number">50</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再补上 <code>tooltip</code> 选项。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> option = &#123;</span><br><span class="line">  ...</span><br><span class="line">  tooltip: &#123;</span><br><span class="line">    trigger: <span class="string">"item"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512084334737.png" alt="image-20220512084334737" style="zoom:50%;"></p><h2 id="视觉映射"><a href="#视觉映射" class="headerlink" title="视觉映射"></a>视觉映射</h2><p>我们可以通过 <code>visualMap</code> 选项，将数据分组。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> option = &#123;</span><br><span class="line">  ...</span><br><span class="line">  visualMap: &#123;</span><br><span class="line">    left: <span class="string">"right"</span>,</span><br><span class="line">    min: <span class="number">0</span>,</span><br><span class="line">    max: <span class="number">100</span>,</span><br><span class="line">    inRange: &#123;</span><br><span class="line">      color: [</span><br><span class="line">        <span class="string">"#313695"</span>,</span><br><span class="line">        <span class="string">"#4575b4"</span>,</span><br><span class="line">        <span class="string">"#74add1"</span>,</span><br><span class="line">        <span class="string">"#abd9e9"</span>,</span><br><span class="line">        <span class="string">"#e0f3f8"</span>,</span><br><span class="line">        <span class="string">"#ffffbf"</span>,</span><br><span class="line">        <span class="string">"#fee090"</span>,</span><br><span class="line">        <span class="string">"#fdae61"</span>,</span><br><span class="line">        <span class="string">"#f46d43"</span>,</span><br><span class="line">        <span class="string">"#d73027"</span>,</span><br><span class="line">        <span class="string">"#a50026"</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    text: [<span class="string">"High"</span>, <span class="string">"Low"</span>],</span><br><span class="line">    calculable: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>设置后之后，我们可以滑动右下角的范围来选取不同的省份。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512084634727.png" alt="image-20220512084634727" style="zoom:50%;"></p><p>除了滑块的映射，还支持分区间的，类似下边这种。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512084908512.png" alt="image-20220512084908512"></p><h2 id="其他选项"><a href="#其他选项" class="headerlink" title="其他选项"></a>其他选项</h2><p>其他选项这里就不介绍了，可以参考 <a href="https://echarts.apache.org/examples/zh/index.html#chart-type-map" target="_blank" rel="noopener">官网</a> 和 <a href="https://www.makeapie.cn/echarts_1.html" target="_blank" rel="noopener">社区</a> 的样例，然后结合自己的需求进行配置即可。</p><p>贴几张社区上炫酷的地图：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512085159589.png" alt="image-20220512085159589"></p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512085134411.png" alt="image-20220512085134411" style="zoom:50%;"></p><h1 id="省份切换"><a href="#省份切换" class="headerlink" title="省份切换"></a>省份切换</h1><p>下边再实现一下点击省份切换到对应的省份地图的功能。</p><p>知道了上边的东西，思路其实很简单了，我们只需要把所有省份的 <code>Geojson</code> 数据全部下载下来，然后监听 <code>echarts</code> 的点击事件去显示省份即可。</p><p>为了逻辑之间的解耦，我们可以再新建一个组件，专门展示省份的数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">  &lt;div id=<span class="string">"province"</span> style=<span class="string">"width: 600px; height: 600px"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">import</span> * <span class="keyword">as</span> echarts <span class="keyword">from</span> <span class="string">"echarts"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">"Province"</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    fileName: <span class="built_in">String</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      option: &#123;</span><br><span class="line">        series: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: <span class="string">"省份数据"</span>,</span><br><span class="line">            type: <span class="string">"map"</span>,</span><br><span class="line">            map: <span class="string">"province"</span>,</span><br><span class="line">            data: [],</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    <span class="keyword">this</span>.initData();</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    initData() &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> provinceJSON = <span class="built_in">require</span>(<span class="string">"../data/province/"</span> +</span><br><span class="line">                                     <span class="keyword">this</span>.fileName);</span><br><span class="line">        <span class="keyword">const</span> myChart = echarts.init(</span><br><span class="line">          <span class="built_in">document</span>.getElementById(<span class="string">"province"</span>)</span><br><span class="line">        );</span><br><span class="line">        echarts.registerMap(<span class="string">"province"</span>, provinceJSON);</span><br><span class="line">        myChart.setOption(<span class="keyword">this</span>.option);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        alert(<span class="string">`暂无<span class="subst">$&#123;<span class="keyword">this</span>.fileName&#125;</span>数据`</span>);</span><br><span class="line">        <span class="keyword">this</span>.$emit(<span class="string">"toMap"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;style scoped rel="stylesheet/</span>scss<span class="string">" lang="</span>scss<span class="string">"&gt;&lt;/style&gt;</span></span><br></pre></td></tr></table></figure><p>我们把省份数据都放到 <code>&quot;../data/province&quot;</code> 目录中，这里简单演示，只下载了两个省份的地图：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220512091724599.png" alt="image-20220512091724599"></p><p>通过外部传进来文件的 <code>fileName</code> 注册地图。这里直接通过 <code>require(&quot;../data/province&quot; + this.fileName)</code> 来动态引入 <code>Geojson</code>，一定要加上 <code>&quot;../data/province&quot;</code> 前缀来限制文件的位置，关于 <code>webpack</code> 的动态引入的更多细节可以参考 <a href="https://windliang.wang/2022/05/03/Webpack%E6%89%93%E5%8C%85commonjs%E5%92%8Cesmodule%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BA%A7%E7%89%A9%E5%AF%B9%E6%AF%94/">Webpack 打包 commonjs 和 esmodule 动态引入模块的产物对比</a>。</p><p>我们增加一个 <code>ProvinceMap</code> 组件来调度两个组件的显示隐藏。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;Province</span><br><span class="line">            v-<span class="keyword">if</span>=<span class="string">"showProvince"</span></span><br><span class="line">            :fileName=<span class="string">"fileName"</span></span><br><span class="line">            @toMap=<span class="string">"toMap"</span></span><br><span class="line">        &gt;<span class="xml"><span class="tag">&lt;/<span class="name">Province</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">        &lt;<span class="built_in">Map</span> v-<span class="keyword">else</span> @toProvince=<span class="string">"toProvince"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">Map</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> Province <span class="keyword">from</span> <span class="string">"./Province.vue"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="built_in">Map</span> <span class="keyword">from</span> <span class="string">"./Map.vue"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    name: <span class="string">"HelloWorld"</span>,</span><br><span class="line">    components: &#123;</span><br><span class="line">        Province,</span><br><span class="line">        <span class="built_in">Map</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    data() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            showProvince: <span class="literal">false</span>,</span><br><span class="line">            fileName: <span class="literal">null</span>,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">       <span class="comment">// 显示省份数据</span></span><br><span class="line">        toProvince(&#123; fileName &#125; = &#123;&#125;) &#123;</span><br><span class="line">            <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">            <span class="keyword">this</span>.showProvince = <span class="literal">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="comment">// 显示全国地图</span></span><br><span class="line">        toMap() &#123;</span><br><span class="line">            <span class="keyword">this</span>.showProvince = <span class="literal">false</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;!-- Add "scoped" attribute to limit CSS to this component only --&gt;</span></span><br><span class="line"><span class="regexp">&lt;style scoped&gt;&lt;/</span>style&gt;</span><br></pre></td></tr></table></figure><p>在 <code>Map</code> 组件中监听省份的 <code>click</code> ，传递给 <code>ProvinceMap</code> 组件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">initData() &#123;</span><br><span class="line">  <span class="keyword">var</span> myChart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">"main"</span>));</span><br><span class="line">  echarts.registerMap(<span class="string">"china"</span>, china);</span><br><span class="line">  <span class="keyword">const</span> option =  ....;</span><br><span class="line">  myChart.setOption(option);</span><br><span class="line">  myChart.on(<span class="string">"click"</span>, (params) =&gt;</span><br><span class="line">             <span class="keyword">this</span>.$emit(<span class="string">"toProvince"</span>, &#123; <span class="attr">fileName</span>: params.name &#125;)</span><br><span class="line">            );</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>在 <code>Province</code> 组件中监听 <code>click</code>，传递给 <code>ProvinceMap</code> 组件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">initData() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> provinceJSON = <span class="built_in">require</span>(<span class="string">"../data/province/"</span> +</span><br><span class="line">                                 <span class="keyword">this</span>.fileName);</span><br><span class="line">    <span class="keyword">const</span> myChart = echarts.init(</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">"province"</span>)</span><br><span class="line">    );</span><br><span class="line">    echarts.registerMap(<span class="string">"province"</span>, provinceJSON);</span><br><span class="line">    myChart.setOption(<span class="keyword">this</span>.option);</span><br><span class="line">    myChart.on(<span class="string">"click"</span>, () =&gt; <span class="keyword">this</span>.$emit(<span class="string">"toMap"</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    alert(<span class="string">`暂无<span class="subst">$&#123;<span class="keyword">this</span>.fileName&#125;</span>数据`</span>);</span><br><span class="line">    <span class="keyword">this</span>.$emit(<span class="string">"toMap"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>最后看一下实现的效果：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comKapture%202022-05-12%20at%2010.06.29.gif" alt="Kapture 2022-05-12 at 10.06.29"></p><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>通过 <code>GeoJSON</code> 画 <code>echarts</code> ，知道大致的原理，然后其他配置项参考 <a href="https://echarts.apache.org/examples/zh/index.html#chart-type-map" target="_blank" rel="noopener">官网</a> 和 <a href="https://www.makeapie.cn/echarts_7.html" target="_blank" rel="noopener">社区</a> 的例子比对上 <a href="https://echarts.apache.org/zh/option.html#geo" target="_blank" rel="noopener">配置项</a> 慢慢配置即可，文章的整体代码放到了 <a href="https://github.com/wind-liang/echarts-map-vue" target="_blank" rel="noopener">github</a>，需要的同学可以参考。</p><p><code>ECharts</code> 最初由百度团队开源，并于 <code>2018</code> 年初捐赠给<code>Apache</code> 基金会，<code>2021</code> 年 <code>1</code> 月 <code>26</code> 日晚，<code>Apache</code> 基金会官方宣布 <code>ECharts</code> 项目正式毕业，成为 <code>Apache</code> 顶级项目。</p><p>平时开发 <code>Echarts</code> ，我们就可以从「切图仔」变成「<code>echarts</code> 配置工程师了」，手动狗头。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近用 &lt;code&gt;ehcarts&lt;/code&gt; 写了一个有关中国地图的需求，这篇文章来总结下基本的原理和用法。&lt;/p&gt;
&lt;h1 id=&quot;Geojson&quot;&gt;&lt;a href=&quot;#Geojson&quot; class=&quot;headerlink&quot; title=&quot;Geojson&quot;&gt;&lt;/a&gt;G
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="echarts" scheme="https://windliang.wang/tags/echarts/"/>
    
  </entry>
  
  <entry>
    <title>Webpack打包commonjs和esmodule混用模块的产物对比</title>
    <link href="https://windliang.wang/2022/05/06/Webpack%E6%89%93%E5%8C%85commonjs%E5%92%8Cesmodule%E6%B7%B7%E7%94%A8%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BA%A7%E7%89%A9%E5%AF%B9%E6%AF%94/"/>
    <id>https://windliang.wang/2022/05/06/Webpack%E6%89%93%E5%8C%85commonjs%E5%92%8Cesmodule%E6%B7%B7%E7%94%A8%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BA%A7%E7%89%A9%E5%AF%B9%E6%AF%94/</id>
    <published>2022-05-06T01:04:47.000Z</published>
    <updated>2022-11-17T00:01:23.933Z</updated>
    
    <content type="html"><![CDATA[<p>接 <a href="https://zhuanlan.zhihu.com/p/508808789" target="_blank" rel="noopener">Webpack 打包 commonjs 和 esmodule 模块的产物对比</a> 继续，这篇文章来测试下 <code>commonjs</code> 模块和 <code>esmodule</code> 混用的情况，也就是 <code>import</code> 导入 <code>commonjs</code> 的模块，<code>require</code> 导入 <code>esomodule</code> 的模块，看一下它们在 <code>Webpack</code> 下的产物。</p><h1 id="import-导入-commonjs-模块"><a href="#import-导入-commonjs-模块" class="headerlink" title="import 导入 commonjs 模块"></a>import 导入 commonjs 模块</h1><p><code>commonjs</code> 模块会为我们预设一个 <code>module = {exports: {}}</code> 的对象，导出模块的话我们可以直接给 <code>module.exports.xxx = xxxx</code> 或者 <code>exports.xxx = xxx</code> 加属性，也可以给 <code>module.exports = xxx</code> 赋值为一个新对象或者函数。</p><p>下边看下这两种情况的异同：</p><h2 id="exports-添加属性"><a href="#exports-添加属性" class="headerlink" title="exports 添加属性"></a>exports 添加属性</h2><p>两个文件的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/commonjs/add.js</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"add开始引入"</span>);</span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.add = add;</span><br><span class="line"></span><br><span class="line">exports.sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/commonjs/index.js</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"commonjs开始执行"</span>);</span><br><span class="line"><span class="keyword">import</span> &#123; add &#125; <span class="keyword">from</span> <span class="string">"./add"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>如果还记得  <a href="https://zhuanlan.zhihu.com/p/508808789" target="_blank" rel="noopener">Webpack 打包 commonjs 和 esmodule 模块的产物对比</a>  这里总结的，我们的 <code>import</code> 会导入整个对象，然后执行的时候再通过 <code>xxx.add</code> 的形式调用。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(</span><br><span class="line">  <span class="string">"./src/commonjs/add.js"</span></span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"commonjs开始执行"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, (<span class="number">0</span>, _add__WEBPACK_IMPORTED_MODULE_0__.add)(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>而 <code>_add__WEBPACK_IMPORTED_MODULE_0__</code> 就是我们导出的整个 <code>module.exports</code> 对象。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./src/commonjs/add.js"</span>: <span class="function">(<span class="params"><span class="built_in">module</span>, exports</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"add开始引入"</span>);</span><br><span class="line">  <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">module</span>.exports.add = add;</span><br><span class="line"></span><br><span class="line">  exports.sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>因此这种情况两种模式是完全契合的，不会有问题。</p><p>全部代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">        <span class="string">"./src/commonjs/add.js"</span>: <span class="function">(<span class="params"><span class="built_in">module</span>, exports</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"add开始引入"</span>);</span><br><span class="line">            <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> a + b;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">module</span>.exports.add = add;</span><br><span class="line"></span><br><span class="line">            exports.sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line">        <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = (__webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">            exports: &#123;&#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        __webpack_modules__[moduleId](</span><br><span class="line">            <span class="built_in">module</span>,</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.r = <span class="function">(<span class="params">exports</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, &#123;</span><br><span class="line">                    value: <span class="string">"Module"</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">                value: <span class="literal">true</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_exports__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        __webpack_require__.r(__webpack_exports__);</span><br><span class="line">        <span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(</span><br><span class="line">            <span class="string">"./src/commonjs/add.js"</span></span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"commonjs开始执行"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"1+1="</span>, (<span class="number">0</span>, _add__WEBPACK_IMPORTED_MODULE_0__.add)(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h2 id="exports-赋值为新对象"><a href="#exports-赋值为新对象" class="headerlink" title="exports 赋值为新对象"></a>exports 赋值为新对象</h2><p>这次我们将 <code>module.exports</code> 整个赋值为一个新对象，这种情况我们一般是直接赋值为一个新的函数。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/commonjs/add.js</span></span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = add;</span><br></pre></td></tr></table></figure><p><code>index.js</code> 我们可以直接导入函数，不需要这样子 <code>import { xxx } from &#39;yyy&#39;</code>  再进行对象解构。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/commonjs/index.js</span></span><br><span class="line"><span class="keyword">import</span> add <span class="keyword">from</span> <span class="string">"./add"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>我们知道，对于直接 <code>import</code> 导入的话， <code>esmodule</code> 相当于导入 <code>default</code> 属性，事实上 <code>commonjs</code> 并没有导出 <code>default</code> ，但 <code>webpack</code> 帮我们进行了兼容。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__( <span class="string">"./src/commonjs/add.js"</span>);</span><br><span class="line"><span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0___default = __webpack_require__.n(_add__WEBPACK_IMPORTED_MODULE_0__);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, _add__WEBPACK_IMPORTED_MODULE_0___default()(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>看一下 <code>__webpack_require__.n</code> 方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__webpack_require__.n = <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> getter = <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule ? <span class="comment">// 判断是否为 esmodule 模块</span></span><br><span class="line">      () =&gt; (<span class="built_in">module</span>[<span class="string">'default'</span>]) :</span><br><span class="line">  () =&gt; (<span class="built_in">module</span>); <span class="comment">// 直接返回整个模块</span></span><br><span class="line">  __webpack_require__.d(getter, &#123; <span class="attr">a</span>: getter &#125;); <span class="comment">// 这句没懂</span></span><br><span class="line">  <span class="keyword">return</span> getter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如果不是 <code>esmodule</code> 模块的话，我们会将整个模块作为 <code>default</code> 属性返回，但为什么在模块内又加了个 <code>a</code> 属性，这里没太懂，谁知道的话可以和我交流一下哈。</p><p>再看下整个的代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">        <span class="string">"./src/commonjs/add.js"</span>: <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> a + b;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">module</span>.exports = add;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line">        <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = (__webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">            exports: &#123;&#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        __webpack_modules__[moduleId](</span><br><span class="line">            <span class="built_in">module</span>,</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.n = <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> getter =</span><br><span class="line">                <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule</span><br><span class="line">                    ? <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">module</span>[<span class="string">"default"</span>]</span><br><span class="line">                    : <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">module</span>;</span><br><span class="line">            __webpack_require__.d(getter, &#123; <span class="attr">a</span>: getter &#125;);</span><br><span class="line">            <span class="keyword">return</span> getter;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.d = <span class="function">(<span class="params">exports, definition</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> definition) &#123;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    __webpack_require__.o(definition, key) &amp;&amp;</span><br><span class="line">                    !__webpack_require__.o(exports, key)</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="built_in">Object</span>.defineProperty(exports, key, &#123;</span><br><span class="line">                        enumerable: <span class="literal">true</span>,</span><br><span class="line">                        get: definition[key],</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.o = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, prop);</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.r = <span class="function">(<span class="params">exports</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, &#123;</span><br><span class="line">                    value: <span class="string">"Module"</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_exports__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        __webpack_require__.r(__webpack_exports__);</span><br><span class="line">        <span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(</span><br><span class="line">            <span class="string">"./src/commonjs/add.js"</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0___default = __webpack_require__.n(</span><br><span class="line">            _add__WEBPACK_IMPORTED_MODULE_0__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"1+1="</span>, _add__WEBPACK_IMPORTED_MODULE_0___default()(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h1 id="require-导入-esmodule-模块"><a href="#require-导入-esmodule-模块" class="headerlink" title="require 导入 esmodule 模块"></a>require 导入 esmodule 模块</h1><p><code>esmodule</code> 模块除了正常的 <code>export</code> ，我们把 <code>export default</code> 也加一下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/esmodule/add.js</span></span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> add;</span><br></pre></td></tr></table></figure><p>然后 <code>index.js</code> 通过 <code>require</code> 来导入：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/esmodule/index.js</span></span><br><span class="line"><span class="keyword">const</span> m = <span class="built_in">require</span>(<span class="string">"./add"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(m)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, m.default(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1-1="</span>, m.sub(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>因为 <code>require</code> 是直接导入整个对象，没有专门导入 <code>default</code> 的形式，所以调用 <code>default</code> 方法的时候，我们需要通过 <code>m.default</code> 来调用。</p><p>运行起来是没有问题的：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508085606651.png" alt="image-20220508085606651"></p><p>让我们回忆下 <a href="https://zhuanlan.zhihu.com/p/508808789" target="_blank" rel="noopener">Webpack 打包 commonjs 和 esmodule 模块的产物对比</a>  这里介绍的 <code>esmodule</code> 模块的导出产物：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">  <span class="string">"./src/esmodule/add.js"</span>: (</span><br><span class="line">    __unused_webpack_module,</span><br><span class="line">    __webpack_exports__,</span><br><span class="line">    __webpack_require__</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line">    __webpack_require__.r(__webpack_exports__);</span><br><span class="line">    __webpack_require__.d(__webpack_exports__, &#123;</span><br><span class="line">      sub: <span class="function"><span class="params">()</span> =&gt;</span> sub,</span><br><span class="line">      <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> __WEBPACK_DEFAULT_EXPORT__,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> __WEBPACK_DEFAULT_EXPORT__ = add;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>相当于导出了一个 <code>module.exports</code> 大的对象，包含 <code>sub</code> 和 <code>default</code> 属性。</p><p>然后是 <code>index.js</code> </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> m = __webpack_require__(<span class="string">"./src/esmodule/add.js"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(m);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"1+1="</span>, m.default(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"1-1="</span>, m.sub(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>需要注意的是虽然导出的是整个对象，但对于 <code>index.js</code> 我们不可以通过对象解构来拿到 <code>default</code> 方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/esmodule/index.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="keyword">default</span>&#125; = <span class="built_in">require</span>(<span class="string">"./add"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, <span class="keyword">default</span>(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p><code>default</code> 会在这里被认为是一个关键字，直接抛错：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508090141724.png" alt="image-20220508090141724"></p><p>来看下整体代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">        <span class="string">"./src/esmodule/add.js"</span>: (</span><br><span class="line">            __unused_webpack_module,</span><br><span class="line">            __webpack_exports__,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        ) =&gt; &#123;</span><br><span class="line"><span class="meta">            "use strict"</span>;</span><br><span class="line">            __webpack_require__.r(__webpack_exports__);</span><br><span class="line">            __webpack_require__.d(__webpack_exports__, &#123;</span><br><span class="line">                sub: <span class="function"><span class="params">()</span> =&gt;</span> sub,</span><br><span class="line">                <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> __WEBPACK_DEFAULT_EXPORT__,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> a + b;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> __WEBPACK_DEFAULT_EXPORT__ = add;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line">        <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = (__webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">            exports: &#123;&#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        __webpack_modules__[moduleId](</span><br><span class="line">            <span class="built_in">module</span>,</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.d = <span class="function">(<span class="params">exports, definition</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> definition) &#123;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    __webpack_require__.o(definition, key) &amp;&amp;</span><br><span class="line">                    !__webpack_require__.o(exports, key)</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="built_in">Object</span>.defineProperty(exports, key, &#123;</span><br><span class="line">                        enumerable: <span class="literal">true</span>,</span><br><span class="line">                        get: definition[key],</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.o = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, prop);</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.r = <span class="function">(<span class="params">exports</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, &#123;</span><br><span class="line">                    value: <span class="string">"Module"</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_exports__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> m = __webpack_require__(<span class="string">"./src/esmodule/add.js"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(m);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"1+1="</span>, m.default(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"1-1="</span>, m.sub(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h1 id="同时导出-commonjs-和-esmodule"><a href="#同时导出-commonjs-和-esmodule" class="headerlink" title="同时导出 commonjs 和 esmodule"></a>同时导出 commonjs 和 esmodule</h1><p>我们在一个文件同时使用 <code>module.exports</code> 和 <code>export</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports.add = add;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>浏览器会直接抛错：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508092644764.png" alt="image-20220508092644764"></p><p>如果直接重写 <code>module.exports</code> 呢？</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports = add;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508092737165.png" alt="image-20220508092737165"></p><p>同样会抛错，让我们看一下 <code>webpack</code> 的产物。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"./src/commonjs/add.js"</span>: (</span><br><span class="line">           <span class="built_in">module</span>,</span><br><span class="line">           __webpack_exports__,</span><br><span class="line">           __webpack_require__</span><br><span class="line">       ) =&gt; &#123;</span><br><span class="line">           __webpack_require__.r(__webpack_exports__);</span><br><span class="line">           __webpack_require__.d(__webpack_exports__, &#123;</span><br><span class="line">               sub: <span class="function"><span class="params">()</span> =&gt;</span> sub,</span><br><span class="line">           &#125;);</span><br><span class="line">           <span class="built_in">module</span> = __webpack_require__.hmd(<span class="built_in">module</span>);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> a + b;</span><br><span class="line">           &#125;;</span><br><span class="line">           <span class="built_in">module</span>.exports.add = add;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> a + b;</span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;,</span><br></pre></td></tr></table></figure><p>调用了 <code>__webpack_require__.hmd</code> 方法拿到 <code>module</code> 。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__webpack_require__.hmd = <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">module</span> = <span class="built_in">Object</span>.create(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">module</span>.children) <span class="built_in">module</span>.children = [];</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(<span class="built_in">module</span>, <span class="string">"exports"</span>, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    set: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">"ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "</span> +</span><br><span class="line">        <span class="built_in">module</span>.id</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">module</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>hmd</code> 方法重新定义了 <code>exports</code> 属性，没有定义 <code>get</code> 属性，所以 <code>module.exports</code> 返回的是 <code>undefined</code>，<code>module.exports.add</code> 就直接抛错了。</p><p>重新定义了 <code>set</code> 函数，所以 <code>module.exports = xxx</code> ，重新赋值属性的时候走到 <code>set</code> 后直接抛错。</p><h1 id="同时导入-commonjs-和-esmodule"><a href="#同时导入-commonjs-和-esmodule" class="headerlink" title="同时导入 commonjs 和 esmodule"></a>同时导入 commonjs 和 esmodule</h1><p>定义一个 <code>commonjs</code> 模块：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/commonjs/add.js</span></span><br><span class="line"><span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">module</span>.exports = add;</span><br></pre></td></tr></table></figure><p>定义一个 <code>esmodule</code> 模块：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/esmodule/sub.js</span></span><br><span class="line"><span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> sub;</span><br></pre></td></tr></table></figure><p>然后在 <code>index.js</code> 同时引入：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> add = <span class="built_in">require</span>(<span class="string">"./add"</span>) ;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sub <span class="keyword">from</span> <span class="string">'../esmodule/sub'</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1-1="</span>, sub(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>没什么问题，正常运行：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508094440422.png" alt="image-20220508094440422"></p><p>因为导入的话它们是互不影响的，各自导入自己的即可，可以看下完整代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> __webpack_modules__ = &#123;</span><br><span class="line">        <span class="string">"./src/commonjs/add.js"</span>: <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> add = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> a + b;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="built_in">module</span>.exports = add;</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="string">"./src/esmodule/sub.js"</span>: (</span><br><span class="line">            __unused_webpack_module,</span><br><span class="line">            __webpack_exports__,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        ) =&gt; &#123;</span><br><span class="line"><span class="meta">            "use strict"</span>;</span><br><span class="line">            __webpack_require__.r(__webpack_exports__);</span><br><span class="line">            __webpack_require__.d(__webpack_exports__, &#123;</span><br><span class="line">                <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> __WEBPACK_DEFAULT_EXPORT__,</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">const</span> sub = <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> a - b;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> __WEBPACK_DEFAULT_EXPORT__ = sub;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_module_cache__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__webpack_require__</span>(<span class="params">moduleId</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> cachedModule = __webpack_module_cache__[moduleId];</span><br><span class="line">        <span class="keyword">if</span> (cachedModule !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> cachedModule.exports;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = (__webpack_module_cache__[moduleId] = &#123;</span><br><span class="line">            exports: &#123;&#125;,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        __webpack_modules__[moduleId](</span><br><span class="line">            <span class="built_in">module</span>,</span><br><span class="line">            <span class="built_in">module</span>.exports,</span><br><span class="line">            __webpack_require__</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.d = <span class="function">(<span class="params">exports, definition</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> definition) &#123;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    __webpack_require__.o(definition, key) &amp;&amp;</span><br><span class="line">                    !__webpack_require__.o(exports, key)</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="built_in">Object</span>.defineProperty(exports, key, &#123;</span><br><span class="line">                        enumerable: <span class="literal">true</span>,</span><br><span class="line">                        get: definition[key],</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.o = <span class="function">(<span class="params">obj, prop</span>) =&gt;</span></span><br><span class="line">            <span class="built_in">Object</span>.prototype.hasOwnProperty.call(obj, prop);</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        __webpack_require__.r = <span class="function">(<span class="params">exports</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Symbol</span> !== <span class="string">"undefined"</span> &amp;&amp; <span class="built_in">Symbol</span>.toStringTag) &#123;</span><br><span class="line">                <span class="built_in">Object</span>.defineProperty(exports, <span class="built_in">Symbol</span>.toStringTag, &#123;</span><br><span class="line">                    value: <span class="string">"Module"</span>,</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123; <span class="attr">value</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> __webpack_exports__ = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    (<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        __webpack_require__.r(__webpack_exports__);</span><br><span class="line">        <span class="keyword">var</span> _esmodule_sub__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(</span><br><span class="line">            <span class="string">"./src/esmodule/sub.js"</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">const</span> add = __webpack_require__(<span class="string">"./src/commonjs/add.js"</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"1+1="</span>, add(<span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">            <span class="string">"1-1="</span>,</span><br><span class="line">            (<span class="number">0</span>, _esmodule_sub__WEBPACK_IMPORTED_MODULE_0__[<span class="string">"default"</span>])(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;)();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><h1 id="总"><a href="#总" class="headerlink" title="总"></a>总</h1><p>不管是 <code>esmodule</code> 还是 <code>commonjs</code> 模块，最终都转换成了 <code>module = {exports: {}}</code> 形式的模块，所以它们之间的混用成为了可能。</p><p><code>import</code> <code>commonjs</code> 模块的话，<code>import</code> 拿到的就是整个 <code>module.exports</code> 对象，正常使用即可。如果我们直接改写 <code>module.exports</code> 对象，<code>webpack</code> 会认为等同于 <code>export default</code> ，进行兼容处理。</p><p><code>require</code> <code>esmodule</code> 模块的话，如果之前 <code>esmodule</code> 模块中有 <code>export default</code> ，那么使用的时候需要显示的调用 <code>xxx.default</code> ，对于其他的 <code>export</code> 正常使用即可。</p><p>虽然可以混用，但一般情况下能不混用就不混用，以免遇到未知问题，目前更推荐 <code>esmodule</code> 模块。</p><p>如果遇到奇怪问题的话，可以考虑直接去查看 <code>webpack</code> 的产物，能更快的排查出问题。</p><h1 id="讨论"><a href="#讨论" class="headerlink" title="讨论"></a>讨论</h1><p>对产物其实有两个问题，然后去请教了下 <code>Tecvan</code> ，杰哥。</p><p>第一个问题就是上边提到，当使用 <code>imports</code> 导入 <code>commonjs</code> 模块的时候，会调用 <code>n</code> 方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__webpack_require__.n = <span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> getter =</span><br><span class="line">      <span class="built_in">module</span> &amp;&amp; <span class="built_in">module</span>.__esModule</span><br><span class="line">  ? <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">module</span>[<span class="string">"default"</span>]</span><br><span class="line">  : <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">module</span>;</span><br><span class="line">  __webpack_require__.d(getter, &#123; <span class="attr">a</span>: getter &#125;);</span><br><span class="line">  <span class="keyword">return</span> getter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这里会挂一个 <code>a</code> 属性，原因的话如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508095931458.png" alt="image-20220508095931458"></p><p>主要是兼容 <code>webpack</code> 混用的情况，场景可能如下：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508100718016.png" alt="image-20220508100718016"></p><p>第二个问题，还是 <code>import</code> 导入 <code>commonjs</code> 模块的时候，打包产物如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(</span><br><span class="line">  <span class="string">"./src/commonjs/add.js"</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">var</span> _add__WEBPACK_IMPORTED_MODULE_0___default = __webpack_require__.n(</span><br><span class="line">  _add__WEBPACK_IMPORTED_MODULE_0__</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"1+1="</span>, _add__WEBPACK_IMPORTED_MODULE_0___default()(<span class="number">1</span>, <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>这里会触发 <code>__webpack_require__.n</code> 方法去生成 <code>_add__WEBPACK_IMPORTED_MODULE_0___default</code> 变量。触发这个逻辑的原因并不是因为我们使用了 <code>import xxx from &#39;yyy&#39;</code> 的格式，而是因为导出 <code>commonjs</code> 模块的时候直接使用 <code>module.exports = xxx</code> 进行了覆盖，这种情况 <code>webpack</code> 就会认为等效于 <code>export default</code> 的情况。</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508101552792.png" alt="image-20220508101552792"></p><p>但对于代码，因为 <code>_add__WEBPACK_IMPORTED_MODULE_0__</code> 和 <code>_add__WEBPACK_IMPORTED_MODULE_0___default</code> 是同一个值，我们不处理 <code>default</code> 逻辑其实也是通的：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508101628186.png" alt="image-20220508101628186"></p><p><code>webpack</code> 为什么会这样处理，具体原因就不知道了，欢迎大家一起来讨论，下边是杰哥的猜测：</p><p><img src="https://windliangblog.oss-cn-beijing.aliyuncs.com/windliangblog.oss-cn-beijing.aliyuncs.comimage-20220508101715288.png" alt="image-20220508101715288"></p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>算上这篇，总结了三篇 <code>webpack</code> 的产物的文章  <a href="https://zhuanlan.zhihu.com/p/508808789" target="_blank" rel="noopener">Webpack 打包 commonjs 和 esmodule 模块的产物对比</a> 、<a href="https://windliang.wang/2022/05/03/Webpack%E6%89%93%E5%8C%85commonjs%E5%92%8Cesmodule%E5%8A%A8%E6%80%81%E5%BC%95%E5%85%A5%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BA%A7%E7%89%A9%E5%AF%B9%E6%AF%94/">Webpack 打包 commonjs 和 esmodule 动态引入模块的产物对比</a>，可以加深平常开发中对于模块之间的理解。</p><p>大家如果还对 <code>Webpack</code> 原理感兴趣的话，可以去看杰哥的 <a href="https://juejin.cn/column/6978684601921175583" target="_blank" rel="noopener">Webpack 原理系列</a>。目前我没有总结这个系列的计划了，哈哈。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;接 &lt;a href=&quot;https://zhuanlan.zhihu.com/p/508808789&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Webpack 打包 commonjs 和 esmodule 模块的产物对比&lt;/a&gt; 继续，这篇文章来测试下 
      
    
    </summary>
    
    
      <category term="前端" scheme="https://windliang.wang/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="webpack" scheme="https://windliang.wang/tags/webpack/"/>
    
  </entry>
  
</feed>
